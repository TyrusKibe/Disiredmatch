* easypay_APP.PRG
*#INCLUDE [..\easypay_APP.H]
Set Date BRITISH



*-- DECLARE DLL statements for reading/writing to private INI files

Declare Integer GetPrivateProfileString In Win32API  As GetPrivStr ;
	String cSection, String cKey, String cDefault, String @cBuffer, ;
	Integer nBufferSize, String cINIFile

Declare Integer WritePrivateProfileString In Win32API As WritePrivStr ;
	String cSection, String cKey, String cValue, String cINIFile

*-- DECLARE DLL statements for reading/writing to system registry
Declare Integer RegOpenKeyEx In Win32API ;
	Integer nKey, String @cSubKey, Integer nReserved,;
	Integer nAccessMask, Integer @nResult

Declare Integer RegQueryValueEx In Win32API ;
	Integer nKey, String cValueName, Integer nReserved,;
	Integer @nType, String @cBuffer, Integer @nBufferSize

Declare Integer RegCloseKey In Win32API ;
	Integer nKey

*-- DECLARE DLL statement for Windows 3.1 API function GetProfileString
Declare Integer GetProfileString In Win32API As GetProStr ;
	String cSection, String cKey, String cDefault, ;
	String @cBuffer, Integer nBufferSize

Public lckey,lyear,lmonth,m.tx_cdx,m.tmppath,HomeDir,l_licence,l_serial,l_appuserid,m.f_fields,haslogedon,;
	l_commdate,l_commdays,l_vendor,nConnectionHandle,reportpath,lqreportid,noeval,m.r_filter,l_isclosed,lcurrfinmon,lcurrfinyear,;
	IDC_DataSource,IDC_Username,IDC_Password,tlcAlias,llpara_code,llviewmode,l_sregcode,m.rorder,lconstr,lfin_firstmon,;
	llqgroupsid,wantstoregister,cregistereduser,cregisteredco,llreg,l_gp_search,lpaygroup,m.dfile,m.sfile,m.lfile,;
	l_gp_description,l_sub_description,l_previousamt,m.p_formu1,defgroupid,m.thishelptopic,thishelpID,lastfield,lasteader,;
	fastpaypath,my_skinpath,my_skin,datapath,ulevel,c_userlevel,c_username,photopath,astaffno,isregistered,currform,;
	delpath,sprapath,lstaffno,lLstaffno,hremail,paypath,HomeDir,lgroupsid,p_staffno,lcPadName,lcPadName2,M.lval,lpreviousval,;
	lr_f_month,lr_f_year,lr_t_month,lr_t_year,isdetailed,M.thishelptopic,thishelpfile,l_no_logical

l_no_logical = .F.
haslogedon = .F.
thishelpfile = 'easypay.chm'
m.thishelptopic = 'Formula'

isdetailed = .F.
lr_f_year = Year(Date())
lr_f_month = Month(Date())

lr_t_year = Year(Date())
lr_t_month = Month(Date())

lpreviousval = ''
lastfield = ''
m.lval = ''

lfin_firstmon = 1



isregistered = .F.
lconstr = ''
l_isclosed = .F.
lmonth = Month(Date())
lyear = Year(Date())

currform = ''

m.dfile = 'd_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))
m.sfile = 's_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))
m.lfile = 'ln_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))

m.astaffno = 0
m.r_filter = ''
m.f_fields = ''
m.rorder = ''

l_sregcode = ''
lcPadName = "Repo_Pop"
lcPadName2 = "Repo2_Pop"

noeval = .F.
m.thishelptopic = "fastpaye"
thishelpID = 1
lpaygroup = ''
p_staffno = 0
l_appuserid = 0
HomeDir = Alltrim(Curdir())

#Define APP_SUPERCLASS         "_application"
#Define APP_GLOBAL              goApp
#Define APP_MEDIATOR_NAME       "app_mediator"
#Define APP_CLASSLIB            "easypay_APP.VCX"
#Define APP_CLASSNAME           "app_application"

* the splash class can be anything you want:
#Define APP_SPLASHCLASS         "app_splash"
#Define APP_SPLASHCLASSLIB      "easypay_APP.VCX"

* the topform class:
#Define APP_FORMCLASS      "app_topform"

*how long should the splash screen stay up if
* no key is pressed and if the app object initializes
* too quickly? (this figure is in seconds)

#Define APP_SPLASHDELAY         3

* the following are localization strings for the wrapper program:
#Define APP_CANNOT_RUN_LOC           "Application cannot run."
#Define APP_ALREADY_RUNNING_LOC      "Application already running."
#Define APP_WRONG_SUPERCLASS_LOC     "Sorry -- this application must instantiate "+ Chr(13)+ ;
	"an object that descends from "+APP_SUPERCLASS+"."

* this is a localization string for the menus:
*#Define APP_FEATURE_NOT_AVAILABLE_LOC "Feature not available."

* this one is a hook in the startup program, not
* needed by the framework:
* #DEFINE APP_INITIALIZE          *<Initialize>*

m.p_formu1 = '' &&Holds the formula fields

defgroupid = 0
l_previousamt = 0
l_sub_description = ''
l_gp_description  = 'Main'

llreg = .F.
cregisteredco = 'Developer'
cregistereduser = 'Un registered : Evaluation Only '
wantstoregister = .F.
llqgroupsid = 0
lqreportid = 0
llviewmode = 1
llpara_code = 0 &&The last parameter you were working on
lyear = Year(Date())
lmonth = Month(Date())
lckey = ''
photopath  = ''

ttlcAlias = ''
m.tmppath = Sys(2023)+'/' &&Creates temporary files int the windows temp file
m.tx_cdx = m.tmppath+"tx"+Left(Sys(3),6)+".cdx" &&Index for the temporary file

reportpath = HomeDir

l_licence = 'EVALUATION' &&Default value of the licence holder name
l_serial = 'EVALUATION' &&Default serial number
l_commdate = Date()-1 &&Default commission date
l_commdays = 0 &&Default commission days
l_vendor = 'Developer' &&Default Vendor



IDC_DataSource = 'easypay'  &&Database to connect to -
*This is the ODBC Reference. Could be anything because the
* nconnection handle will be used from now onwards
*These are the user name and password to the data connection

iniloc = Alltrim(Curdir())+'easypay.ini' &&Location of the inifile

&&Defult User name & Password
IDC_Username = 'sa'
IDC_Password = 'password'

If File(iniloc)
	lcBuffer = Space(150)
	If GetPrivStr("Paths",'q1', "", ;
			@lcBuffer, Len(lcBuffer), ;
			iniloc) > 0
		IDC_Username  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
	Endif

	lcBuffer = Space(150)

	If GetPrivStr("Paths",'q2', "", ;
			@lcBuffer, Len(lcBuffer), ;
			iniloc) > 0
		IDC_Password   = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
	Endif
	lcBuffer = Space(150)
	If GetPrivStr("Paths",'q3', "", ;
			@lcBuffer, Len(lcBuffer), ;
			iniloc) > 0
		IDC_DataSource  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
	Endif

	lcBuffer = Space(150)
	If GetPrivStr("Paths",'reports', "", ;
			@lcBuffer, Len(lcBuffer), ;
			iniloc) > 0
		reportpath  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
	Endif

	lcBuffer = Space(150)
	If GetPrivStr("Paths",'PHOTOS', "", ;
			@lcBuffer, Len(lcBuffer), ;
			iniloc) > 0
		photopath  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
	Endif

Endif

nConnectionHandle =SQLConnect(IDC_DataSource,IDC_Username,IDC_Password)


If nConnectionHandle <= 0  And 1 = 2&&Failed
	Messagebox('Sorry, The system could not connect to your data.'+Chr(13)+'Please contact your systems administrator for assistance ',16,'Fastpay Enterprise :: Error ')
	Return .F.
Else &&Successful
*nConnectionHandle = SQLCONNECT('mysqlforhrms','root','')
	ciniloc = Alltrim(Curdir())+'fastpay.ini' &&Location of the inifile - We need this for the personal settings
	m.year = Year(Date())
	m.month = Month(Date())

	If Used('e_p9paras')
		Select e_p9paras
		Use
	Endif
	lopened = opendtable('p9paras','e_p9paras','',.T.,'p9parasid')
	Select e_p9paras
	Go Top
	Locate For Alltrim(Upper(para_des)) = 'FINYEAR'
	If Found()
		lfin_firstmon = defavalue
	Else
		lfin_firstmon = 1
	Endif


	osuccess =opendtable('lastdat','v_lastdat',"",.F.,'lastdatid')

	last_month = Year(Date())
	last_year = Month(Date())

	lallclosed = .T.
	Select v_lastdat
	Go Top
	Do While !Eof()
		last_month = v_lastdat.Month
		last_year = v_lastdat.Year
		If closed = 0
			lallclosed = .F.
			Exit
		Endif
		Skip
	Enddo

	If lallclosed
		last_month = last_month+1
		If last_month > 12
			last_month = 1
			last_year = last_year+1
		Endif
	Endif


	If last_month = lmonth And last_year = lyear

	Else
		lxcurrfinmon = last_month
		lxcurrfinyear = last_year
		last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(last_year)))

		If lxcurrfinmon < lfin_firstmon
			lxcurrfinyear = last_year-1
			last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(lxcurrfinyear)))
		Endif
		lc_date = Ctod('01/'+Alltrim(Str(last_month))+'/'+Alltrim(Str(last_year)))

		ltmon = 0

		Do While last_date <= lc_date
			last_date = Gomonth(last_date,1)
			ltmon = ltmon+1
		Enddo

		lxcurrfinmon = ltmon
		messret = 0

*lmess =  'The last financial period to be processed was : ['+ALLTRIM(STR(lxcurrfinmon))+'-'+ALLTRIM(STR(lxcurrfinyear))+'] Calendar month :'+ALLTRIM(mon(last_month))+', '+ALLTRIM(str(last_year))
*messret = Messagebox(lmess+'. The system will attempt to advance to the next period. Click YES to proceed to the next period or NO to remain in the current period'+CHR(13)+'Do you wish to proceed to the next period ?',4+48,'fastPAY Enterprise : Notification' )
*
		If messret = 6
			l_date = Ctod('01/'+Alltrim(Str(last_month))+'/'+Alltrim(Str(last_year)))
			l_date = Gomonth(l_date,1)

			last_month = Month(l_date)
			last_year = Year(l_date)

			lxcurrfinmon = last_month
			lxcurrfinyear = last_year

			last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(last_year)))
			If lxcurrfinmon < lfin_firstmon
				lxcurrfinyear = last_year-1
				last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(lxcurrfinyear)))
			Endif
			lc_date = Ctod('01/'+Alltrim(Str(last_month))+'/'+Alltrim(Str(last_year)))
			ltmon = 0
			Do While last_date <= lc_date
				last_date = Gomonth(last_date,1)
				ltmon = ltmon+1
			Enddo
			lxcurrfinmon = ltmon

			lmonth = last_month
			lyear = last_year

*lmess = 'Your financial period has now been set as: ['+ALLTRIM(STR(lxcurrfinmon))+'-'+ALLTRIM(STR(lxcurrfinyear))+'] Calendar month :'+ALLTRIM(mon(last_month))+', '+ALLTRIM(str(last_year))
*Messagebox(lmess,64,'Fastpay Enterprise :: Notice ')





		Else
			lmonth = last_month
			lyear = last_year
*lmess = 'Your financial period has now been set as: ['+ALLTRIM(STR(lxcurrfinmon))+'-'+ALLTRIM(STR(lxcurrfinyear))+'] Calendar month :'+ALLTRIM(mon(last_month))+', '+ALLTRIM(str(last_year))
*Messagebox(lmess,64,'Fastpay Enterprise :: Notice ')
		Endif
	Endif

*-- Write toolbar position to INI file
	lgroupsid = 0

	lcurrfinmon = lmonth
	lcurrfinyear = lyear
	last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(lcurrfinyear)))
	If lcurrfinmon < lfin_firstmon
		lcurrfinyear = lyear-1
		last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(lcurrfinyear)))
	Endif
	lc_date = Ctod('01/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
	ltmon = 0
	Do While last_date <= lc_date
		last_date = Gomonth(last_date,1)
		ltmon = ltmon+1
	Enddo
	lcurrfinmon = ltmon


	my_skinpath = '' &&Path of the system skins
	my_skin = '' &&The name of the Current skin
	paypath = '' &&The path of the payroll file
	hremail = '' &&The default support email

	lstaffno = 0 &&The staff ID of the user logged in
	lLstaffno = 0

	delpath = ''
	sprapath = ''

	c_userlevel = 0
	c_username = ''
	ulevel = 0

	Release APP_GLOBAL
	Release APP_FORM
	Public  APP_GLOBAL,LJBPOSDETID,APP_FORM

	datapath = Space(150)
	fastpaypath = Space(150)

	iniloc = Alltrim(Curdir())+'easypay.ini' &&Location of the inifile
	cnopath = .T.
	If File(iniloc)
		lcBuffer = Space(150)
		If GetPrivStr("emails",'HR', "", ;
				@lcBuffer, Len(lcBuffer), ;
				iniloc) > 0
			hremail  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
		Endif

		lcBuffer = Space(150)
		If GetPrivStr("skins",'path', "", ;
				@lcBuffer, Len(lcBuffer), ;
				iniloc) > 0
			my_skinpath  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
		Endif

		lcBuffer = Space(150)
		If GetPrivStr("skins",'skin', "", ;
				@lcBuffer, Len(lcBuffer), ;
				iniloc) > 0
			my_skin  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
		Endif

		cnopath = .T.
		lcBuffer = Space(150)
		If GetPrivStr("Paths",'Data', "", ;
				@lcBuffer, Len(lcBuffer), ;
				iniloc) > 0
			datapath  = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
			secfile = datapath +'staff.dbf'
			If File(secfile)
				cnopath = .F.
			Endif
		Endif

		If !Empty(IDC_DataSource)
			cnopath = .F.
		Else
			Do While cnopath
				newloc = Alltrim(Getdir(Curdir(),'Please locate the data directory'))
				If !Empty(newloc)
					secfile = newloc+'staff.dbf'
					If File(secfile)
						cnopath = .F.
					Endif
					If !cnopath
						=WritePrivStr("Paths",'Data',;
							newloc+'>',iniloc)
						datapath = newloc
						Exit
					Endif
				Else
					Exit
				Endif
				Exit
			Enddo
		Endif

		If !cnopath
			If Empty(IDC_DataSource)
				Set Default To (datapath)
				Open Database (datapath+'easypay.dbc') Shared
				If !Used("staff")
					Select 0
					Use (m.datapath+"staff.dbf") Shared
				Endif

				If !Used("notices")
					Select 0
					Use (m.datapath+"notices.dbf") Shared
				Endif
			Endif
		Endif
	Endif

	If !cnopath &&Data file has been found
		If File(ciniloc)
			nopath = .T.
			lcBuffer = Space(150)
			If GetPrivStr("Paths",'DATA', "", ;
					@lcBuffer, Len(lcBuffer), ;
					ciniloc) > 0
				fastpaypath = Alltrim(Left(lcBuffer,At('>',lcBuffer)-1))
				secfile = fastpaypath+'empdata.dbf'
				If File(secfile)
					nopath = .F.
				Endif
			Endif

			Do While nopath
				cnewloc = Alltrim(Getdir(Curdir(),'Please locate the fastpay data directory'))
				If !Empty(cnewloc)
					secfile = cnewloc+'empdata.dbf'
					If File(secfile)
						nopath = .F.
					Endif
					If !nopath
						=WritePrivStr("Paths",'DATA',;
							cnewloc+'>',ciniloc)
						fastpaypath = cnewloc

						Exit
					Endif
				Else
					Exit
				Endif
				Exit
			Enddo

			paypath = Alltrim(fastpaypath)
			fastpaypath = ''
		Endif

		If Type([APP_GLOBAL.Class]) = "C" And ;
				UPPER(APP_GLOBAL.Class) == Upper(APP_CLASSNAME)
			Messagebox(APP_ALREADY_RUNNING_LOC,48, ;
				APP_GLOBAL.cCaption )
			If Vartype(APP_GLOBAL.oFrame) = "O"
				APP_GLOBAL.oFrame.Show()
			Endif
			Return

		Endif

	Endif

Endif &&Check Connection

Release APP_GLOBAL
Public  APP_GLOBAL

Local lcLastSetTalk, llAppRan, lnSeconds, loSplash
Local Array laCheck[1]

lcLastSetTalk=Set("TALK")
loSplash = .Null.
Set Talk Off

#Ifdef APP_SPLASHCLASS

	If Not Empty(APP_SPLASHCLASS)
		loSplash = Newobject(APP_SPLASHCLASS, APP_SPLASHCLASSLIB)
		If Vartype(loSplash) = "O"
			lnSeconds = Seconds()
			loSplash.Show()
		Endif
	Endif

#Endif


APP_GLOBAL = Newobject(APP_CLASSNAME, APP_CLASSLIB)

If Vartype(APP_GLOBAL) = "O" ;
		AND Aclass(laCheck,APP_GLOBAL) > 0 And ;
		ASCAN(laCheck,Upper(APP_SUPERCLASS)) > 0

	APP_GLOBAL.cReference =[APP_GLOBAL]
	APP_GLOBAL.cFormMediatorName = APP_MEDIATOR_NAME

	#Ifdef APP_CD
		APP_CD
	#Endif

	#Ifdef APP_PATH
		APP_PATH
	#Endif

	#Ifdef APP_INITIALIZE
		APP_INITIALIZE
	#Endif

	If Vartype(loSplash) = "O"
		If Seconds() < lnSeconds + APP_SPLASHDELAY
			=Inkey(APP_SPLASHDELAY-(Seconds()-lnSeconds),"MH")
		Endif
		loSplash.Release()
		loSplash = .Null.
	Endif

	*******************************************************************MEMEMEME
** Simple 6-month license from first run
*******************************************************************MEMEMEME
** Simple 6-month license from first run
LOCAL llreg, isregistered, cregistereduser, cregisteredco
LOCAL ldToday, ldStart, ldExpiry, lcExp

* File to store license info (DO NOT redeclare iniloc if already exists)
iniloc = "AppLicense.ini"

* Initialize variables
llreg = .F.
isregistered = .F.
cregistereduser = ""
cregisteredco = ""

ldToday = DATE()
ldStart = {}
ldExpiry = {}
lcExp = SPACE(30)

*========================
* CHECK IF LICENSE EXISTS
*========================
IF FILE(iniloc)
    lcExp = GETPRIVSTR("LICENSE","EXPIRY","",30,iniloc)
ENDIF

IF !EMPTY(lcExp)
    ldExpiry = CTOD(LEFT(lcExp, AT(">", lcExp)-1))
    IF ldToday <= ldExpiry
        llreg = .T.
        isregistered = .T.
        cregistereduser = "REGISTERED USER"
        cregisteredco = "YOUR COMPANY"
    ENDIF
ENDIF

*========================
* CREATE LICENSE IF MISSING
*========================
IF NOT llreg
    llreg = .T.
    isregistered = .T.
    cregistereduser = "REGISTERED USER"
    cregisteredco = "YOUR COMPANY"
    ldStart = ldToday
    ldExpiry = GOMONTH(ldStart,6)

    * Save license info in INI file
    WRITEPRIVSTR("LICENSE","START",DTOC(ldStart)+">",iniloc)
    WRITEPRIVSTR("LICENSE","EXPIRY",DTOC(ldExpiry)+">",iniloc)
ENDIF

*========================
* CONTINUE WITH ORIGINAL CODE
*========================
IF NOT APP_GLOBAL.Show()
    IF TYPE([APP_GLOBAL.Name])="C"
        MESSAGEBOX(APP_CANNOT_RUN_LOC,16,APP_GLOBAL.cCaption)
        APP_GLOBAL.Release()
    ELSE
        MESSAGEBOX(APP_CANNOT_RUN_LOC,16)
    ENDIF
ELSE
    llAppRan = .T.
ENDIF

IF TYPE([APP_GLOBAL.lReadEvents])="L"
    IF APP_GLOBAL.lReadEvents
        APP_GLOBAL.Release()
    ENDIF
ELSE
    RELEASE APP_GLOBAL
ENDIF

IF lcLastSetTalk=="ON"
    SET TALK ON
ELSE
    SET TALK OFF
ENDIF

IF TYPE([APP_GLOBAL])="O"
    RETURN APP_GLOBAL
ELSE
    RETURN llAppRan
ENDIF

PROCEDURE alive
RETURN

FUNCTION retuser
PARAMETERS fakestr
m.thisstr = ALLTRIM(fakestr)
N = 1
actstr = ""
DO WHILE N <= LEN(m.thisstr)
    i = SUBSTR(m.thisstr,N,1)
    IF !EMPTY(i)
        ival = ASC(i)-N-LEN(m.thisstr)
        actstr = actstr+CHR(ival)
    ENDIF
    N = N+1
ENDDO
RETURN actstr
***********************************************MEMEMEMEME

***********************************************MEMEMEMEME

***********************************************MEMEMEMEME

***********************************************MEMEMEMEME
Function insertpass
Parameters newpassval
Assert Vartype(newpassval) = "C"
APP_GLOBAL.StorePassword(newpassval)
Return .T.


Procedure sho_sel
Deactivate Popup SELpop
Return .T.

Procedure sho_cont
Select f_conds
Go Top
Define Popup cont_pop2;
	FROM 15,2;
	TO 25,45 ;
	PROMPT Field Alltrim(f_conds.cond_des) ;
	SCROLL;
	MARGIN;
	MESSAGE "";
	COLOR ,Rgb(0,0,255,255,255,255)
On Selection Popup cont_pop2 Do sho_cont2
Activate Popup cont_pop2 At 14,28

Return .T.

Procedure sho_cont2
l_reportid = q_reports.reportid
L_field_id  = tqfields.field_id
l_lcond_no = f_conds.lcond_no

L_dispfilter = Proper(Alltrim(tqfields.Descript)+' is '+Alltrim(f_conds.cond_des))
l_field_type = Alltrim(tqfields.fieldtype)

=SQLExec(nConnectionHandle,"select * from filters order by filterid ","v_filters")
Select v_filters
Go Bottom
l_filterid = filterid+1

Select filters
Append Blank
Replace field_id  With L_field_id
Replace dispfilter  With L_dispfilter
Replace lcond_no  With l_lcond_no
Replace reportid  With l_reportid
Replace filterid  With l_filterid
Replace obrack  With ' '
Replace cbrack  With ' '
Replace fvalue With ' '
Replace field_type With l_field_type
Replace link_code With ' '
=Tableupdate(.T.)
Deactivate Popup cont_pop
Deactivate Popup cont_pop2
Return .T.

Procedure shoskin
Deactivate Popup skinpop
Return

Procedure saveskin
=WritePrivStr("skins",'skin',;
	my_skin+'>',iniloc)
Return


**************
**Payroll Fourmulae computation
Function formu
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu1
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu2
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu3
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu4
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu5
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y


Function formu6
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y


Function formu7
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu8
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu9
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function formu10
Parameters t_form
m.lthis = Alltrim(t_form)
If Empty(m.lthis)
	Y =  0
Else
	Y =  &lthis
Endif
Return  Y

Function  f_eval &&Evaluates items in file
Parameters yout
Select t_params
m.self = .F.

m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"


If m.thisone = m.npos_no
	m.self = .T.
Endif
m.l_pos = Recno()
p1 = 0

If !m.self
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p1 = p1+&amt_f
Endif

If Found() And !m.self
	m.amt_f = "t_params.amt"

	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.

		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p1 = 0
			Else
				l_para_code = t_params.para_code

				Select params
				Go Top
				Locate For para_code = l_para_code
				Select t_params

				If !t_params.checked And Recno() <> m.recno1
					m.pt = Alltrim(params.p_formu1)
					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL1')
						m.recno2 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu1(m.pt)
						Else
							m.tamt = 0
						Endif

						Select t_params
						Goto  m.recno2

						m.amt_f = "t_params.amt"

						m.ltot_amt = &amt_f

						Replace &amt_f With m.tamt
						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2

							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif
************

						Select t_params
					Endif
				Endif

				p1 = p1+&amt_f
				Replace t_params.checked With m.checked
			Endif
		Endif

		Select t_params
		If m.self
			Exit
		Endif

		Skip
	Enddo
Endif
If m.l_pos > 0
	Goto m.l_pos
Endif

Return p1


Function f_eval1 &&Evaluates items in file
Parameters yout
Select t_params

m.self1 = .F.

m.thisone = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self1 = .T.
Endif

m.l_pos1 = Recno()

p2 = 0

If !m.self1
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"

	p2 = p2+&amt_f
Endif

If Found() And !m.self1
	Do While pos_no = m.npos_no And !Eof()

		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.

		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f2 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p2 = 0
			Else

				l_para_code = t_params.para_code
				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno2
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL2')

						m.recno3 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu2(m.pt)
						Else
							m.tamt = 0
						Endif

						Select t_params
						Goto m.recno3


						m.ltot_amt = &amt_f2

						m.amt_f = "t_params.amt"

						Replace &amt_f2 With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt
						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params
						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

						Select t_params
					Endif
				Endif
				p2 = p2+&amt_f2
				Replace t_params.checked With m.checked

			Endif

		Endif
		Select t_params
		If m.self1
			Exit
		Endif

		Skip
	Enddo
Endif
If m.l_pos1 > 0
	Goto m.l_pos1
Endif
Return p2


Function f_eval2 &&Evaluates items in file
Parameters yout
Select t_params

m.self2 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self2 = .T.
Endif

m.l_pos2 = Recno()

p3 = 0

If !m.self2
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p3 = p3+&amt_f
Endif


If Found() And !m.self2
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f3 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p3 = 0
			Else

				l_para_code = t_params.para_code
				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno3
					m.pt = Alltrim(params.p_formu1)
					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL3')

						m.recno4 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu3(m.pt)
						Else
							m.tamt = 0
						Endif

						Select t_params
						Goto m.recno4

						m.ltot_amt = &amt_f3

						m.amt_f = "t_params.amt"

						Replace &amt_f3 With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p3 = p3+&amt_f3
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self2
			Exit
		Endif

		Skip
	Enddo
Endif

If m.l_pos2 > 0
	Goto m.l_pos2
Endif

Return p3


Function f_eval3 &&Evaluates items in file
Parameters yout
Select t_params

m.self3 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self3 = .T.
Endif

m.l_pos3 = Recno()

p4 = 0

If !m.self3
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p4 = p4+&amt_f
Endif


If Found() And !m.self3
	Do While pos_no = m.npos_no And !Eof()

		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f4 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p4 = 0
			Else

				l_para_code = t_params.para_code
				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno4
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL4')

						m.recno5 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu4(m.pt)
						Else
							m.tamt = 0
						Endif

						Select t_params

						Goto m.recno5

						m.ltot_amt = &amt_f4

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p4 = p4+&amt_f4
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self3
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos3 > 0
	Goto m.l_pos3
Endif

Return p4

Function f_eval4 &&Evaluates items in file
Parameters yout
Select t_params

m.self4 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self4 = .T.
Endif

m.l_pos4 = Recno()

p5 = 0

If !m.self4
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p5 = p5+&amt_f
Endif


If Found() And !m.self4
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f5 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p5 = 0
			Else
				l_para_code = t_params.para_code
				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno5
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL5')

						m.recno6 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu5(m.pt)
						Else
							m.tamt = 0
						Endif

						Select t_params
						Goto m.recno6

						m.ltot_amt = &amt_f5

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p5 = p5+&amt_f5
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self4
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos4 > 0
	Goto m.l_pos4
Endif

Return p5

Function f_eval5 &&Evaluates items in file
Parameters yout
Select t_params

m.self5 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self5 = .T.
Endif

m.l_pos5 = Recno()

p6 = 0

If !m.self5
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p6 = p6+&amt_f
Endif


If Found() And !m.self5
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f6 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p6 = 0
			Else
				l_para_code = t_params.para_code
				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno6
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL6')

						m.recno7 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu6(m.pt)
						Else
							m.tamt = 0
						Endif


						Select t_params
						Goto m.recno7

						m.ltot_amt = &amt_f6

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p6 = p6+&amt_f6
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self5
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos5 > 0
	Goto m.l_pos5
Endif

Return p6




Function f_eval6 &&Evaluates items in file
Parameters yout
Select t_params

m.self6 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self6 = .T.
Endif

m.l_pos6 = Recno()

p7 = 0

If !m.self6
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p7 = p7+&amt_f
Endif


If Found() And !m.self6
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f7 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p7 = 0
			Else
				l_para_code = t_params.para_code
				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno6
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL7')

						m.recno8 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu7(m.pt)
						Else
							m.tamt = 0
						Endif


						Select t_params
						Goto m.recno8

						m.ltot_amt = &amt_f7

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p7 = p7+&amt_f7
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self6
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos6 > 0
	Goto m.l_pos6
Endif

Return p7




Function f_eval7 &&Evaluates items in file
Parameters yout
Select t_params

m.self7 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.self7 = .T.
Endif

m.l_pos7 = Recno()

p8 = 0

If !m.self7
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p8 = p8+&amt_f
Endif


If Found() And !m.self7
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f8 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p8 = 0
			Else

				l_para_code = t_params.para_code

				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno6
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL8')

						m.recno9 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu8(m.pt)
						Else
							m.tamt = 0
						Endif


						Select t_params
						Goto m.recno9

						m.ltot_amt = &amt_f8

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p8 = p8+&amt_f8
				Replace t_params.checked With m.checked
			Endif
		Endif

		Select t_params

		If m.self7
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos7 > 0
	Goto m.l_pos7
Endif

Return p8



Function f_eval8 &&Evaluates items in file
Parameters yout
Select t_params

m.self8 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"


If m.thisone = m.npos_no
	m.self8 = .T.
Endif

m.l_pos8 = Recno()

p9 = 0

If !m.self8
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p9 = p9+&amt_f
Endif


If Found() And !m.self8
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f9 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p9 = 0
			Else
				l_para_code = t_params.para_code

				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno6
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL9')

						m.recno10 = Recno()

						If !Deleted() And Freeze <> 1
							m.tamt = formu9(m.pt)
						Else
							m.tamt = 0
						Endif

						Select t_params
						Goto m.recno10

						m.ltot_amt = &amt_f9

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt


						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p9 = p9+&amt_f9
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self8
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos8 > 0
	Goto m.l_pos8
Endif

Return p9


Function f_eval9 &&Evaluates items in file
Parameters yout
Select t_params

m.self9 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"


If m.thisone = m.npos_no
	m.self9 = .T.
Endif

m.l_pos9 = Recno()

p10 = 0

If !m.self9
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p10 = p10+&amt_f
Endif


If Found() And !m.self9
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f10 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p10 = 0
			Else

				l_para_code = t_params.para_code

				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno6
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.pt = Strtran(m.pt, 'F_EVAL', 'F_EVAL10')

						m.recno11 = Recno()

						If !Deleted()  And Freeze <> 1
							m.tamt = formu10(m.pt)
						Else
							m.tamt = 0
						Endif


						Select t_params
						Goto m.recno11

						m.ltot_amt = &amt_f10

						m.amt_f = "t_params.amt"

						Replace &amt_f With m.tamt

						Replace t_params.checked With .T.

***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt


						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p10 = p10+&amt_f10
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self9
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos9 > 0
	Goto m.l_pos9
Endif

Return p10



Function f_eval10 &&Evaluates items in file
Parameters yout
Select t_params

m.self10 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"


If m.thisone = m.npos_no
	m.self10 = .T.
Endif

m.l_pos10 = Recno()

p11 = 0

If !m.self10
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.amt"
	p11 = p11+&amt_f
Endif


If Found() And !m.self10
	Do While pos_no = m.npos_no And !Eof()
		If t_params.staffno = 0 Or t_params.para_code = 0
			Skip
			Loop
		Endif

		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f10 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				p11 = 0
			Else

				l_para_code = t_params.para_code

				Select params
				Go Top
				Locate For para_code = l_para_code

				Select t_params

				If !t_params.checked And Recno() <> m.recno6
					m.pt = Alltrim(params.p_formu1)

					If !Empty(m.pt)
						m.tamt = 0
						m.amt_f = "t_params.amt"
						Replace &amt_f With m.tamt
						Replace t_params.checked With .T.
***********
						m.tot_amt = m.tamt

						m.difftot = m.tot_amt-m.ltot_amt

						Select t_params

						If l_no_logical
							l_maintbal = .F.
							If params.maintbal <> 0
								l_maintbal = .T.
							Endif
						Else
							l_maintbal = params.maintbal
						Endif

						Select t_params
						If  l_maintbal  &&AND poscode <> 2
							m.lppos = Recno()
							m.lporder = Order()
							m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
							Set Order To Tag  pos_no Of (m.tx_cdx)
							Seek m.tpos_no
							If Found()
								Replace amt With amt+m.difftot
							Endif
							Goto m.lppos
							Set Order To m.lporder
						Endif

					Endif
				Endif
				p11 = p11+&amt_f11
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self10
			Exit
		Endif
		Skip
	Enddo
Endif

If m.l_pos10 > 0
	Goto m.l_pos10
Endif

Return p11


***************************
***Compute Balances

Function  fb_eval &&Evaluates items in file
Parameters yout

Select t_params
m.bself = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"

m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"
If m.thisone = m.npos_no
	m.bself = .T.
Endif
m.bl_pos = Recno()
bp1 = 0
If !m.bself
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	bp1 = bp1+&amt_f
Endif

If Found() And !m.bself
	m.amt_f = "t_params.c_balance"

	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'
		Else
			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp1 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()

					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif
				bp1 = bp1+&amt_f
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.bself
			Exit
		Endif
		Skip
	Enddo
Endif

If m.bl_pos > 0
	Goto m.bl_pos
Endif

Return bp1


Function fb_eval1 &&Evaluates items in file
Parameters yout
Select t_params

m.bself1 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.bself1 = .T.
Endif

m.bl_pos1 = Recno()

bp2 = 0

If !m.bself1
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	bp2 = bp2+&amt_f
Endif

If Found() And !m.bself1
	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f2 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp2 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()

					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif

				bp2 = bp2+&amt_f2
				Replace t_params.checked With m.checked
			Endif
		Endif

		Select t_params
		If m.bself1
			Exit
		Endif
		Skip
	Enddo
Endif

If m.bl_pos1 > 0
	Goto m.bl_pos1
Endif

Return bp2

Function fb_eval2 &&Evaluates items in file
Parameters yout
Select t_params

m.bself2 = .F.

m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.bself2 = .T.
Endif

m.bl_pos2 = Recno()

bp3 = 0

If !m.bself2
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	bp3 = bp3+&amt_f
Endif


If Found() And !m.bself2
	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f3 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp3 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()

					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif
				bp3 = bp3+&amt_f3
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.bself2
			Exit
		Endif
		Skip
	Enddo
Endif

If m.bl_pos2 > 0
	Goto m.bl_pos2
Endif

Return p3


Function fb_eval3 &&Evaluates items in file
Parameters yout
Select t_params

m.bself3 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.bself3 = .T.
Endif

m.bl_pos3 = Recno()

p4 = 0

If !m.bself3
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	p4 = p4+&amt_f
Endif


If Found() And !m.bself3
	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f4 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp4 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()

					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif
				bp4 = bp4+&amt_f4
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.bself3
			Exit
		Endif
		Skip
	Enddo
Endif

If m.bl_pos3 > 0
	Goto m.bl_pos3
Endif

Return p4

Function fb_eval4 &&Evaluates items in file
Parameters yout
Select t_params

m.bself4 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.bself4 = .T.
Endif

m.bl_pos4 = Recno()

bp5 = 0

If !m.bself4
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	bp5 = bp5+&amt_f
Endif


If Found() And !m.bself4
	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f5 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp5 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()

					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif
				bp5 = bp5+&amt_f5
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.bself4
			Exit
		Endif
		Skip
	Enddo
Endif
If m.bl_pos4 > 0
	Goto m.bl_pos4
Endif
Return p5

Function fb_eval5 &&Evaluates items in file
Parameters yout
Select t_params

m.bself5 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.bself5 = .T.
Endif

m.bl_pos5 = Recno()

bp6 = 0

If !m.bself5
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	bp6 = bp6+&amt_f
Endif


If Found() And !m.bself5
	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else
			m.amt_f6 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp6 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()

					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif
				bp6 = bp6+&amt_f6
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.self5
			Exit
		Endif
		Skip
	Enddo
Endif

If m.bl_pos5 > 0
	Goto m.bl_pos5
Endif

Return bp6

Function fb_eval6 &&Evaluates items in file
Parameters yout
Select t_params

m.bself6 = .F.
m.thisone = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*"+Alltrim(Str(poscode))+")"
m.npos_no = "("+Alltrim(Str(t_params.staffno))+"*"+Alltrim(yout)+"*1)"

If m.thisone = m.npos_no
	m.bself6 = .T.
Endif

m.bl_pos6 = Recno()

bp7 = 0

If !m.bself6
	Set Order To Tag  pos_no Of (m.tx_cdx)
	Seek m.npos_no
Else
	m.amt_f = "t_params.c_balance"
	bp7 = bp7+&amt_f
Endif


If Found() And !m.bself6
	Do While pos_no = m.npos_no And !Eof()
		m.checked = .T.
		If !Empty(t_params.l_order) And Right(Alltrim(t_params.l_order),2) <> '1)'

		Else

			m.amt_f7 = "t_params.amt"

			If Deleted() &&OR date_start > DATE() OR (date_end < DATE() AND !EMPTY(date_end))
				bp7 = 0
			Else
				If !t_params.checked
					m.recno2 = Recno()
					m.tamt = t_params.c_balance
					Select t_params
					Goto  m.recno2

					m.amt_f = "t_params.c_balance"
					m.ltot_amt = &amt_f
***********
					m.tot_amt = m.tamt

					m.difftot = m.tot_amt-m.ltot_amt

					l_para_code = t_params.para_code

					Select params
					Go Top
					Locate For para_code = l_para_code

					Select t_params

					If l_no_logical
						l_maintbal = .F.
						If params.maintbal <> 0
							l_maintbal = .T.
						Endif
					Else
						l_maintbal = params.maintbal
					Endif

					Select t_params
					If  l_maintbal  &&AND poscode <> 2
						m.lppos = Recno()
						m.lporder = Order()
						m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
						Set Order To Tag  pos_no Of (m.tx_cdx)
						Seek m.tpos_no
						If Found()
							Replace amt With amt+m.difftot
						Endif
						Goto m.lppos
						Set Order To m.lporder
					Endif
************
					Select t_params
				Endif
				bp7 = bp7+&amt_f
				Replace t_params.checked With m.checked
			Endif
		Endif
		Select t_params
		If m.bself6
			Exit
		Endif
		Skip
	Enddo
Endif
If m.bl_pos6 > 0
	Goto m.bl_pos6
Endif
Return bp7
**********


Function calcthem &&Perform a calculation of the spreadsheet
Parameters shothem

m.shothem = shothem
m.isclosed = .F.
Select t_params
lasttrec = Recno()

If !m.isclosed
	Select t_params
	Set Order To Tag  pos_no Of (m.tx_cdx)

	m.thermsize = Reccount()
	Replace All checked With .F.

	Go Top
	Do While !Eof()
		If m.shothem
			m.thermpos = Recno()
			m.thislen = ((m.thermpos/m.thermsize)*m.thermpa)+m.thermadd
			=updtherm(m.thislen)
		Endif
		Select t_params

		If t_params.Type <> 1 Or t_params.poscode > 1
			Skip
			Loop
		Endif

		If t_params.staffno = 0  Or t_params.para_code = 0
			Skip
			Loop
		Endif

**Update the correct cells in the grid
		l_para_code = t_params.para_code

		Select params
		Go Top
		Locate For para_code = l_para_code

		Select t_params

		m.amt_f = "t_params.amt"

		If !t_params.checked

			m.recno1 = Recno()

			If !Deleted() And Freeze <> 1
				m.tamt = formu(params.p_formu1) &&execute the formula
			Else
				m.tamt = 0
			Endif

			Select t_params
			Goto m.recno1

			m.ltot_amt = &amt_f

			m.amt_f = "t_params.amt"

			Replace &amt_f With m.tamt
			Replace t_params.checked With .T.

			m.tot_amt = m.tamt
			m.difftot = m.tot_amt-m.ltot_amt

			Select t_params
			l_para_code = t_params.para_code

			Select params
			Go Top
			Locate For para_code = l_para_code
			Select t_params


			If l_no_logical
				l_maintbal = .F.
				If params.maintbal <> 0
					l_maintbal = .T.
				Endif
			Else
				l_maintbal = params.maintbal
			Endif

			If  l_maintbal  &&AND poscode <> 2
				m.lppos = Recno()
				m.lporder = Order()
				m.tpos_no = "("+Alltrim(Str(staffno))+"*"+Alltrim(Str(para_code))+"*2)"
				Set Order To Tag  pos_no Of (m.tx_cdx)
				Seek m.tpos_no
				If Found()
					Replace amt With amt+m.difftot
				Endif
				Goto m.lppos
				Set Order To m.lporder
			Endif
		Endif
		Select t_params
		Skip
	Enddo
Endif

Select t_params
If lasttrec > 0 And lasttrec <= Reccount()
	Goto lasttrec
Endif

Return .T.

Function updtherm

Return

Function calctax
Parameter m.ctot,m.cduration,m.pyear
Private m.area

m.area = Select()

If Empty(m.cduration)
	m.cduration = 1
Endif

If Empty(m.ctot)
	m.ctot = 0
Endif

If Empty(m.pyear)
	m.pyear = lyear
Endif

nsqlstring = "SELECT * ;
FROM paye order by rate "
=SQLExec(nConnectionHandle,nsqlstring,"v_paye")

Select v_paye
Go Top

If !Eof() And m.ctot > 0 &&Open PAYE file
	Select v_paye
	If m.cduration > 0
		m.tpayecdx = m.tmppath+"pa"+Left(Sys(3),6)+".cdx" &&Index for the temporary file
		Create Cursor tpaye (Lower N(12,4),Upper N(12,4),rate N(12,4))
		Select tpaye
		Index On rate Tag rate Of (m.tpayecdx)

		Select v_paye

		Go Top
		m.llower = Lower
		Do While !Eof()
			m.rate = rate
			m.UPPER = Upper*m.cduration
			m.LOWER = m.llower
			m.llower = m.UPPER+1
			Select tpaye
			Append Blank
			Gather Memvar
			Select v_paye
			Skip
		Enddo
		Select tpaye
	Endif

* paye
	m.amt = 0
	Go Top
	Do While Not Eof()
		If !Deleted()
			If m.ctot < ((Upper-Lower) + 1 )
				m.amt = m.amt +(m.ctot * rate)
				Exit
			Else
				m.amt = m.amt + (((Upper-Lower)+1) * rate)
				m.ctot = m.ctot - ((Upper-Lower)+ 1)
			Endif
		Endif
		Skip
	Enddo

	If Used('tpaye')
		Select tpaye
		Use
	Endif

	If !Empty(m.area)
		Select (m.area)
	Endif

	Return m.amt
Else
	Return 0
Endif


Function mon
Parameters mh
m.cmonth = ''
Do Case
Case mh = 1
	m.cmonth =  "January"
Case mh = 2
	m.cmonth =   "February"
Case mh = 3
	m.cmonth =   "March"
Case mh = 4
	m.cmonth =    "April"
Case mh = 5
	m.cmonth =   "May"
Case mh = 6
	m.cmonth =   "June"
Case mh = 7
	m.cmonth =   "July"
Case mh = 8
	m.cmonth =    "August"
Case mh = 9
	m.cmonth =  "September"
Case mh = 10
	m.cmonth =   "October"
Case mh = 11
	m.cmonth =   "November"
Case mh = 12
	m.cmonth =   "December"
Endcase

Return m.cmonth


Function ginterest &&Fetch the interest
Parameters ccode
m.osel = Select()
m.ginterest = 0
m.tccode = Val(Alltrim(ccode))

If !Used(m.lfile)
	m.lfile = 'ln_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))
	osuccess =opendtable(m.lfile,m.lfile,"",.T.,'d_loansid')
Endif

If Used(m.lfile)
	Select(m.lfile)
	Go Top
	Locate For para_code = m.tccode And staffno = lLstaffno
	If Found()
		l_s_code = s_code
		If !Used('s_loans')
**Get the loans header file
			osuccess =opendtable('s_loans','s_loans',"",.T.,'s_code')
		Endif

		Select s_loans
		Go Top
		Locate For s_code = l_s_code
		If Found()
			l_s_date = s_date
			l_e_date = Gomonth(s_date,r_period)
			l_asdate = Ctod('1/'+Str(Month(l_s_date))+'/'+Str(Year(l_s_date)))
			l_aedate = Ctod('1/'+Str(Month(l_e_date))+'/'+Str(Year(l_e_date)))-1
			Select(m.lfile)
			lsmdate = Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
			lemdate = Gomonth(Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))),1)
			m.ginterest = 0
			If lsmdate >= l_asdate And l_aedate >= lsmdate
				m.ginterest = tinterest
			Else
				Delete
				=Tableupdate(.T.)
			Endif
		Else
			Delete
			=Tableupdate(.T.)
		Endif
	Endif
	Use
Endif
If !Empty(m.osel)
	Select (m.osel)
Endif
Return m.ginterest

Function gprinciple &&Fetch the principle
Parameters ccode
m.osel = Select()
m.ginterest = 0
m.tccode = Val(Alltrim(ccode))

If !Used(m.lfile)
	m.lfile = 'ln_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))
	osuccess =opendtable(m.lfile,m.lfile,"",.T.,'d_loansid')
Endif

If Used(m.lfile)
	Select(m.lfile)
	Go Top
	Locate For para_code = m.tccode And staffno = lLstaffno
	If Found()
		l_s_code = s_code
		If !Used('s_loans')
**Get the loans header file
			osuccess =opendtable('s_loans','s_loans',"",.T.,'s_code')
			m.tl_cdx = m.tmppath+"tl"+Left(Sys(3),6)+".cdx" &&Index for the temporary file
			Select s_loans
			Index On staffno Tag staffno Of (m.tl_cdx) Ascending Additive
			Index On para_code Tag para_code Of (m.tl_cdx) Ascending Additive
			Index On s_code Tag s_code Of (m.tl_cdx) Ascending Additive
		Endif
		Select s_loans
		Go Top
		Locate For s_code = l_s_code
		If Found()
			l_s_date = s_date
			l_e_date = Gomonth(s_date,r_period)
			l_asdate = Ctod('1/'+Str(Month(l_s_date))+'/'+Str(Year(l_s_date)))
			l_aedate = Ctod('1/'+Str(Month(l_e_date))+'/'+Str(Year(l_e_date)))-1

			Select(m.lfile)
			lsmdate = Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
			lemdate = Gomonth(Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))),1)
			m.ginterest = 0
			If lsmdate >= l_asdate And l_aedate >= lsmdate
				m.ginterest = principle
				l_tbalance = tbalance
				If Used('t_params')
					Select t_params
					Replace c_balance With l_tbalance
				Endif
				Select(m.lfile)

			Else
				Delete
				=Tableupdate(.T.)
			Endif
		Else
			Delete
			=Tableupdate(.T.)
		Endif
	Endif
	Use
Endif
If !Empty(m.osel)
	Select (m.osel)
Endif
Return m.ginterest

Function gbalance &&Fetch the principle
Parameters ccode

m.osel = Select()
m.ginterest = 0
m.tccode = Val(Alltrim(ccode))

If !Used(m.lfile)
	m.lfile = 'ln_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))
	osuccess =opendtable(m.lfile,m.lfile,"",.T.,'d_loansid')
Endif

If Used(m.lfile)
	Select(m.lfile)
	Go Top
	Locate For para_code = m.tccode And staffno = lLstaffno
	If Found()
		l_s_code = s_code

		If !Used('s_loans')
**Get the loans header file
			osuccess =opendtable('s_loans','s_loans',"",.T.,'s_code')
*				m.tl_cdx = m.tmppath+"tl"+Left(Sys(3),6)+".cdx" &&Index for the temporary file
*				Select s_loans
*				Index On staffno Tag staffno Of (m.tl_cdx) Ascending Additive
*				Index On para_code Tag para_code Of (m.tl_cdx) Ascending Additive
*				Index On s_code Tag s_code Of (m.tl_cdx) Ascending Additive
		Endif

		Select s_loans
		Go Top
		Locate For s_code = l_s_code
		If Found()
			l_s_date = s_date
			l_e_date = Gomonth(s_date,r_period)
			l_asdate = Ctod('1/'+Str(Month(l_s_date))+'/'+Str(Year(l_s_date)))
			l_aedate = Ctod('1/'+Str(Month(l_e_date))+'/'+Str(Year(l_e_date)))-1

			Select(m.lfile)
			lsmdate = Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
			lemdate = Gomonth(Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))),1)
			m.ginterest = 0

			If lsmdate >= l_asdate And l_aedate >= lsmdate
				m.ginterest = tbalance
			Else
				Delete
				=Tableupdate(.T.)
			Endif
		Else
			Delete
			=Tableupdate(.T.)
		Endif
	Endif
	Use
Endif

If !Empty(m.osel)
	Select (m.osel)
Endif

Return m.ginterest


Function gpayment &&Fetch the principle
Parameters ccode

m.osel = Select()
m.ginterest = 0
m.tccode = Val(Alltrim(ccode))

If !Used(m.lfile)
	m.lfile = 'ln_'+Alltrim(Str(lmonth))+Alltrim(Str(lyear))
	osuccess =opendtable(m.lfile,m.lfile,"",.T.,'d_loansid')
Endif

If Used(m.lfile)
	Select(m.lfile)
	Go Top
	Locate For para_code = m.tccode And staffno = lLstaffno
	If Found()
		l_s_code = s_code

		If !Used('s_loans')
**Get the loans header file
			osuccess =opendtable('s_loans','s_loans',"",.T.,'s_code')
*m.tl_cdx = m.tmppath+"tl"+Left(Sys(3),6)+".cdx" &&Index for the temporary file
*Select s_loans
*Index On staffno Tag staffno Of (m.tl_cdx) Ascending Additive
*Index On para_code Tag para_code Of (m.tl_cdx) Ascending Additive
*Index On s_code Tag s_code Of (m.tl_cdx) Ascending Additive
		Endif

		Select s_loans
		Go Top
		Locate For s_code = l_s_code
		If Found()
			l_s_date = s_date
			l_e_date = Gomonth(s_date,r_period)
			l_asdate = Ctod('1/'+Str(Month(l_s_date))+'/'+Str(Year(l_s_date)))
			l_aedate = Ctod('1/'+Str(Month(l_e_date))+'/'+Str(Year(l_e_date)))-1

			Select(m.lfile)
			lsmdate = Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
			lemdate = Gomonth(Ctod('1/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))),1)
			m.ginterest = 0

			If lsmdate >= l_asdate And l_aedate >= lsmdate
				m.ginterest = Payment
			Else
				Delete
				=Tableupdate(.T.)
			Endif
		Else
			Delete
			=Tableupdate(.T.)
		Endif
	Endif
	Use
Endif

If !Empty(m.osel)
	Select (m.osel)
Endif


Return m.ginterest


Procedure ctmon &&Converts a month number to character
Parameters nmon
Set Date BRITISH
m.tnmon = nmon
m.tcmon = Cmonth(Ctod("01/"+Alltrim(Str(m.tnmon))+"/1999"))
Return m.tcmon


Function mon
Parameters mh
m.cmonth =   ""
Do Case
Case mh = 1
	m.cmonth =  "January"
Case mh = 2
	m.cmonth =   "February"
Case mh = 3
	m.cmonth =   "March"
Case mh = 4
	m.cmonth =    "April"
Case mh = 5
	m.cmonth =   "May"
Case mh = 6
	m.cmonth =   "June"
Case mh = 7
	m.cmonth =   "July"
Case mh = 8
	m.cmonth =    "August"
Case mh = 9
	m.cmonth =  "September"
Case mh = 10
	m.cmonth =   "October"
Case mh = 11
	m.cmonth =   "November"
Case mh = 12
	m.cmonth =   "December"
Endcase

Return m.cmonth



Function g_right
Parameters tl

Return .T.


Procedure sho_dest
Show Gets
Deactivate Popup dests_p
Return

Procedure createit

m.cur_str = ""

m.cur_str = "("+m.cur_str+" pos_no C(20),ord_no C(20),taxlow L(1),added N(1),mode N(1),showhi L(1),noshow L(1),"
m.cur_str = m.cur_str+"empcode N(4), para_code N(5), cat_no N(2),file_p N(5),poscode N(1),cumded N(1),"
m.cur_str = m.cur_str+"position N(5),p_formu1 M(10),editable l(1),p_type N(1),checked L(1),funcno N(5),"
m.cur_str = m.cur_str+"date_start D(10),date_end D(10),link_code N(5),d_remark C(254),compcode N(4),f_name C(50),P_NAME C(200),"
m.cur_str = m.cur_str+"s_code N(10),sal_amt N(12,2),amt N(12,2),op_amt N(12,2),p_l_name C(50),join_date D(8),END_date D(8),"
m.cur_str = m.cur_str+"type N(1),skipit l(1),deptcode N(5),names C(50),oldempcode C(10),lmonth N(2),lyear N(4),startpay N(12,2),"
m.cur_str = m.cur_str+"acc_code C(25),e_account C(25),c_account C(25),t_earnings N(1),personal N(1),l_order C(50),e_source C(15),srecno N(10),"
m.cur_str = m.cur_str+"cost_code N(5),ccost N(5),bk_code N(5),br_code N(5),sort_code C(5),bk_name C(30),br_name C(30),emp_per C(15))"

Create Cursor  t_params &cur_str
Select t_params

Index On empcode Tag empcode Of (m.tx_cdx) Ascending
Index On para_code Tag para_code  Of (m.tx_cdx) Ascending
Index On position Tag position  Of (m.tx_cdx) Ascending
Index On pos_no Tag pos_no  Of (m.tx_cdx) Ascending
Index On ord_no Tag ord_no  Of (m.tx_cdx) Ascending
Index On l_order Tag l_order  Of (m.tx_cdx) Ascending Additive
Index On e_source Tag e_source  Of (m.tx_cdx) Ascending Additive
Index On emp_per Tag emp_per  Of (m.tx_cdx) Ascending Additive
Index On compcode Tag compcode  Of (m.tx_cdx) Ascending Additive

Index On '['+Alltrim(Str(empcode))+'/'+Alltrim(Str(position))+']' Tag commb  Of (m.tx_cdx) Ascending Additive

m.annual = .F.

m.count = m.month

If Upper(Left(r_cats.cat_name,6)) = "ANNUAL"
	m.annual = .T.
	m.count = 1
Endif

m.sdate = Ctod('01/'+Alltrim(Str(m.smonth))+'/'+Alltrim(Str(m.syear)))
m.edate = Ctod('01/'+Alltrim(Str(m.emonth))+'/'+Alltrim(Str(m.eyear)))

If m.annual
	m.sdate = Ctod('01/'+Alltrim(Str(1))+'/'+Alltrim(Str(m.year)))
	m.edate = Ctod('01/'+Alltrim(Str(12))+'/'+Alltrim(Str(m.year)))
Endif

m.d_ln_dat = "ln"+Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate)))
m.i_ln_dat = m.datapath+"ln"+Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate)))+".CDX"

m.d_s_dat = "S_"+Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate))) &&salary summary table
m.d_d_dat = "D_"++Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate))) &&salary details table

Do While .T.
*IF USED(m.d_s_dat)
*	SELECT (m.d_s_dat)
*	USE
*ENDIF

	If Used(m.d_d_dat)
		Select (m.d_d_dat)
		Use
	Endif

	m.d_ln_dat = "ln"+Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate)))
	m.i_ln_dat = m.datapath+"ln"+Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate)))+".CDX"

	m.d_s_dat = "S_"+Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate))) &&salary summary table
	m.d_d_dat = "D_"++Alltrim(Str(Month(m.sdate)))+Alltrim(Str(Year(m.sdate))) &&salary details table

	If opendbf(m.d_d_dat) &&AND opendbf(m.d_s_dat)
		m.isclosed = .T. &&This month has been closed. Use archives-no processing
	Else
		m.isclosed = .F. &&The month is not yet closed
		m.d_d_dat = "static" &&salary details table
	Endif

	m.i_s_dat = m.datapath+m.d_s_dat+".CDX"
	m.i_d_dat = m.datapath+m.d_d_dat+".CDX"

	Select (m.d_params)
	Set Order To Tag para_code Of (m.i_params)

	m.lmonth = Month(m.sdate)
	m.lyear = Year(m.sdate)

	m.untill = " empcode = m.empcode AND !EOF()"

	Do p_sel &&Get data according to scope

	If m.sdate = m.edate
		Exit
	Endif

	m.sdate = Gomonth(m.sdate,1)
Enddo

Select t_params
Go Top

If Eof()
	m.nosal = .T. &&This means that there is no salary details
Endif

m.b_list = ""

If !Empty(reports.r_name)
	m.p_name = Alltrim(reports.r_name)
	Do &p_name
Else
	If !Empty(reports.divertto)
		m.p_name = Alltrim(reports.divertto)
		Do &p_name
	Else
		Do p_rep
	Endif
Endif

Select t_params
Set Relation To
*USE

*IF FILE(m.tx_cdx)
*	ERASE(m.tx_cdx)
*ENDIF
Return


Procedure p_rep
Select (m.d_emp)
Set Order To Tag empcode Of (m.i_emp)

m.hascosts = .F.
m.salfile = .F.
m.nosfile = .F.

m.b_fields = ""  &&For export

m.ffrom = ""
m.fwhere = ""
m.fflist = ""

m.tc_dbf = m.tmppath+"tc"+Left(Sys(3),6)+".DBF" && temporary file for employee codes

m.ec_ty = "ec"+Left(Sys(3),6)

m.ec_dbf = m.tmppath+m.ec_ty+".DBF" && temporary file for employee codes
m.ec_cdx = m.tmppath+m.ec_ty+".CDX" && temporary file for employee codes

m.tu_dbf = m.tmppath+"tu"+Left(Sys(3),6)+".DBF" && temporary file for the salaries

m.xx_alias = "xx"+Left(Sys(3),6) &&Alias for the xtab file
m.xx_dbf = m.tmppath+m.xx_alias+".DBF" && xtab file

Select novalues.empcode, empnos.nosname, novalues.novalue;
	FROM novalues, empnos;
	ORDER By novalues.empcode;
	WHERE empnos.nocode = novalues.nocode;
	INTO Table (m.tc_dbf)

m.testali = ""

If !Eof()
	Do genxtab.prg With (m.ec_dbf)
	m.testali = Alltrim(Alias())
	Select (m.testali)
	Index On empcode Tag empcode Of (m.ec_cdx) Ascending
Endif


*m.ffrom = m.ffrom+m.testali

Select (m.d_params)
Set Order To Tag para_code Of (m.i_params)

Select (m.d_f_list)
Set Order To Tag f_code Of (m.i_f_list)

Select (m.d_report)

m.b_list = ""
m.having = ""
m.fstr = ""

m.b_fields = ""

m.fstr = Alltrim(reports.rep_fields)
m.ordtimes = 0
m.filtimes = 0

Do While !Empty(m.fstr) And m.filtimes <= 25
	m.fpos = At("}",m.fstr)
	m.f1 = Left(m.fstr,m.fpos-1)
	m.addf = Substr(m.f1,2)

	If m.fpos <> Len(m.fstr)
		m.fstr = Substr(m.fstr,m.fpos+1)
	Else
		m.fstr = ""
	Endif

	Select (m.d_f_list)
	Seek Val(m.addf)

	If Found()
		m.para_code = para_code

		If m.para_code > 0
			m.isfound = .F.
			Select t_params
			m.lprec = Recno()
			m.lorder = Order()
			Set Order To Tag para_code Of (m.tx_cdx)

			Go Top
			If !Eof()
				Seek m.para_code
				m.isfound = .T.

				If !Found()
					Append Blank
					Replace para_code With m.para_code
				Endif
*IF m.lprec > 0
*	GOTO m.lprec
*	IF !EMPTY(m.lorder)
*		SET ORDER TO TAG &lorder OF (m.tx_cdx)
*	ENDIF
*ENDIF
			Else
				m.isfound = .F.
			Endif

			If m.isfound And !m.nosal
				m.ordtimes = m.ordtimes+1

				If !Empty(m.fflist) And m.ordtimes <= 4
					m.fflist = m.fflist+","
				Endif

				If !Empty(m.b_list)
					m.b_list = m.b_list+","
				Endif

				Select (m.d_params)
				Seek m.para_code

				If Found()
					If m.ordtimes <= 4
						m.fflist = 	m.fflist+Alltrim(m.xx_alias)+".N_"+Alltrim(Str(params.para_code))+Iif(m.desc,' DESC','')
					Endif
					m.b_list = 	m.b_list+Alltrim(f_list.f_name)
					If !Empty(m.b_fields)
						m.b_fields = m.b_fields+","
					Endif

					m.b_fields = m.b_fields+Alltrim(m.xx_alias)+".N_"+Alltrim(Str(params.para_code))+" AS '"+Alltrim(f_list.f_name)+"'"

					If !Empty(m.b_list2)
						m.b_list2 = m.b_list2+","
					Endif

					m.b_list2 = m.b_list2+"convit2(flist."+Alltrim(f_list.f_name)+") AS '"+Alltrim(f_list.f_name)+"'"  &&Second list
					m.b_list = 	m.b_list+ " :H= '"+Alltrim(params.p_l_name)+"'"

					If !Empty(m.having)
						m.having = m.having+" OR "
					Endif

					m.having = m.having+" t_params.para_code = "+Alltrim(Str(params.para_code))
					m.salfile = .T.
				Endif
			Endif
		Else
			If !Empty(m.b_fields)
				m.b_fields = m.b_fields+","
			Endif

			m.ordtimes = m.ordtimes+1
			If !Empty(m.fflist) And m.ordtimes <= 4
				m.fflist = m.fflist+","
			Endif

			If !Empty(m.b_list)
				m.b_list = m.b_list+","
			Endif


			If Upper(Alltrim(f_alias)) = "EMPNOS"
				If m.ordtimes <= 4
					m.fflist = 	m.fflist+Alltrim(m.testali)+"."+Alltrim(f_name)+Iif(m.desc,' DESC','')
				Endif
				m.b_list = 	m.b_list+Alltrim(f_name)
				m.b_fields = m.b_fields+Alltrim(m.testali)+"."+Alltrim(f_name)
				m.nosfile = .T.
			Else
				If Upper(Alltrim(f_alias)) = "CCENT"
					m.hascosts = .T.
				Endif
				If m.ordtimes <= 4
					m.fflist = 	m.fflist+Alltrim(f_alias)+"."+Alltrim(f_name)+Iif(m.desc,' DESC','')
				Endif

				m.b_list = 	m.b_list+Alltrim(f_name)
				m.b_fields = m.b_fields+Alltrim(f_alias)+"."+Alltrim(f_name)
			Endif

			If !Empty(m.b_list2)
				m.b_list2 = m.b_list2+","
			Endif
			m.b_list2 = m.b_list2+"flist."+Alltrim(f_list.f_name) &&Second list
		Endif
	Endif
	m.filtimes = m.filtimes+1
Enddo

Select t_params
Set Order To Tag empcode Of (m.tx_cdx)

m.flist = "t_params.empcode,t_params.para_code,t_params.sal_amt+t_params.op_amt+t_params.amt AS 'pay' "

m.from = " t_params"
m.order = "t_params.empcode,t_params.position "

m.xtabali = ""

If !Empty(m.having)
	m.lhaving = Alltrim(m.having)+' AND (t_params.added = 0) '

	Select &flist;
		FROM &From;
		ORDER By &Order;
		HAVING &lhaving Into Table (m.tu_dbf)

	If !Empty(m.ffrom)
		m.ffrom = m.ffrom+","
	Endif

	m.ffrom = m.ffrom+"t_params"
	m.xtabali = ""


	If !Eof()
		Do genxtab.prg With (m.xx_dbf)
		m.xtabali = Alltrim(Alias())

		If !Empty(m.ffrom)
			m.ffrom = m.ffrom+","
		Endif
		m.ffrom = m.ffrom+m.xtabali
	Else
		m.xx_dbf = ""
	Endif

	Erase (m.tu_dbf)
Endif


*m.testali &&EMPNOS
*m.xtabali &&t_params

If Empty(m.xtabali)
	If Empty(m.testali)
		m.ffrom = 'empdata,depts,paymodes'
		m.fwhere = 'depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Else
		m.ffrom = Alltrim(m.testali)+',empdata,depts,paymodes'
		m.fwhere = m.testali+'.empcode = empdata.empcode AND depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Endif
	If m.hascosts
		m.fwhere = m.fwhere+' AND ccent.empcode = empdata.empcode'
		m.ffrom  =  m.ffrom+',ccent'
	Endif
Else
	If Empty(m.testali)
		m.ffrom = m.xtabali+',empdata,depts,paymodes'
		m.fwhere ='empdata.empcode = '+m.xtabali+'.empcode AND depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Else
		m.ffrom = m.xtabali+','+Alltrim(m.testali)+',empdata,depts,paymodes'
		m.fwhere ='empdata.empcode = '+m.xtabali+'.empcode AND '+m.testali+'.empcode = '+m.xtabali+'.empcode AND depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Endif

	If m.hascosts
		m.fwhere = m.fwhere+' AND ccent.empcode = empdata.empcode'
		m.ffrom  =  m.ffrom+',ccent'
	Endif
Endif

*ERASE (m.tu_dbf)

Return

Procedure bjv
m.earnstr = ''
m.ded_str = ''

Select t_params
Go Top
Replace All cost_code With 0 For para_code <> 35

Set Order To Tag para_code Of (m.tx_cdx)
Seek 35

If Found()
	m.earnstr = Alltrim(t_params.p_formu1)
Endif

Seek 16 &&NONSTAT
If Found()
	m.ded_str = Alltrim(t_params.p_formu1)
Endif

Seek 25 &&NON CASH BENEFITS
If Found()
	m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
Endif

Seek 31  &&STAT
If Found()
	m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
Endif

Seek 15  &&STAT

If Found()
	m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
Endif

Seek  71
If Found()
	m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
Endif

Seek 4  &&NET
If Found()
	m.ded_str = m.ded_str+"'"+Alltrim(Str(t_params.para_code))+"'"
Endif

m.flist = "t_params.cat_no,t_params.empcode,t_params.e_account,t_params.acc_code,"
m.flist = m.flist+"t_params.para_code,t_params.ccost,"
m.flist = m.flist+"t_params.sal_amt+t_params.op_amt+t_params.amt AS 'dr',"
m.flist = m.flist+"t_params.sal_amt+t_params.op_amt+t_params.amt AS 'cr',"
m.flist = m.flist+"ccent.cost_code,ccent.percent,"
m.flist = m.flist+"t_params.t_earnings,t_params.personal,t_params.p_l_name"

m.flist1 = "prejv.cat_no,prejv.e_account,prejv.acc_code,"
m.flist1 = m.flist1+"prejv.p_l_name,prejv.empcode,prejv.para_code,"
m.flist1 = m.flist1+"(prejv.percent/100)*prejv.dr AS 'DR',"
m.flist1 = m.flist1+"(prejv.percent/100)*prejv.Cr AS 'CR',"
m.flist1 = m.flist1+"prejv.percent,prejv.cost_code,prejv.t_earnings,"
m.flist1 = m.flist1+"prejv.personal"

m.pl_name = Space(50)
m.pl_name = 'Payroll 1 Salaries '+Left(Alltrim(mon(m.month)),3)+' '+Alltrim(Str(m.year))
*m.flist2 = "prejv2.p_l_name,prejv2.empcode,prejv2.para_code,"

m.tnone = 'NONE'+Space(11)
m.tnone2 = 'NONE'+Space(21)
m.tsal = '1210101'+Space(18)

m.flist2 = "LEFT(m.pl_name+SPACE(50),50) AS 'p_l_name',prejv2.empcode,prejv2.para_code,"
m.flist2 = m.flist2+"ROUND(SUM(convit(prejv2.dr)),1) AS 'DR',"
m.flist2 = m.flist2+"ROUND(convnil(prejv2.cr),1) AS 'CR',"
m.flist2 = m.flist2+"IIF(!EMPTY(cost_cen.c_account),m.tnone,cost_cen.COST_SNAME) AS 'COST_SNAME',IIF(!EMPTY(cost_cen.c_account),m.tnone2,cost_cen.GRANT) AS 'GRANT',prejv2.percent,"
m.flist2 = m.flist2+"IIF(!EMPTY(cost_cen.c_account),cost_cen.c_account,m.tsal) AS 'acc_code'"


m.flist3 = "prejv2.p_l_name,prejv2.empcode,prejv2.para_code,"
m.flist3 =m.flist3+"ROUND(convnil(prejv2.dr),1) AS 'DR',"
m.flist3 =m.flist3+" ROUND(SUM(convit(prejv2.cr)),1) AS 'CR',"
m.flist3 =m.flist3+"cost_cen.cost_sname,cost_cen.grant,prejv2.percent,prejv2.e_account AS 'acc_code' "


m.flist4 = "prejv2.p_l_name,prejv2.empcode,prejv2.para_code,"
m.flist4 =m.flist4+" ROUND(convnil(prejv2.dr),1) AS 'DR',"
m.flist4 =m.flist4+"ROUND(SUM(convit(prejv2.cr)),1) AS 'CR',"
m.flist4 =m.flist4+"cost_cen.cost_sname,cost_cen.grant,prejv2.percent,params.acc_code AS 'acc_code' "


m.flist5 = "portion3.p_l_name,portion3.empcode,portion3.para_code,"
m.flist5 =m.flist5+" ROUND(convit(portion3.dr),1) AS 'DR',"
m.flist5 =m.flist5+"ROUND(SUM(convit(portion3.cr)),1) AS 'CR',"
m.flist5 =m.flist5+"portion3.cost_sname,portion3.grant,portion3.percent,portion3.acc_code AS 'acc_code' "

Select &flist;
	FROM t_params,ccent,empdata;
	WHERE ccent.empcode = t_params.empcode And empdata.empcode = t_params.empcode ;
	HAVING t_params.added = 0 ;
	INTO Cursor prejv

Select &flist1;
	FROM prejv;
	INTO Cursor prejv1

m.groupy = 'prejv2.cost_code'

Select *;
	FROM prejv1;
	HAVING prejv1.para_code = 3 Or prejv1.para_code = 36 Or prejv1.para_code = 51 Or prejv1.para_code = 31 Or prejv1.para_code = 6 Or prejv1.para_code = 72;
	INTO Cursor prejv2

Select &flist2;
	FROM prejv2,cost_cen ;
	WHERE cost_cen.cost_code = prejv2.cost_code ;
	ORDER By prejv2.cost_code;
	GROUP By &groupy;
	INTO Cursor portion1

m.groupy = 'prejv2.para_code,prejv2.empcode'

**Deductions into personal accounts

Select *;
	FROM prejv1;
	HAVING prejv1.personal <> 0 And At("'"+Alltrim(Str(prejv1.para_code))+"'",m.ded_str) > 0 And !Empty(acc_code) ;
	INTO Cursor prejv2

Select &flist3;
	FROM prejv2,cost_cen,params ;
	WHERE params.para_code = prejv2.para_code And cost_cen.cost_code = params.cost_code ;
	ORDER By prejv2.para_code,prejv2.empcode;
	GROUP By &groupy;
	INTO Cursor portion2

m.groupy = 'prejv2.para_code'

**Deductions

Select *;
	FROM prejv1;
	HAVING prejv1.personal = 0 And At("'"+Alltrim(Str(prejv1.para_code))+"'",m.ded_str) > 0 And !Empty(acc_code) ;
	INTO Cursor prejv2

Select &flist4;
	FROM prejv2,cost_cen,params ;
	WHERE params.para_code = prejv2.para_code And cost_cen.cost_code = params.cost_code ;
	ORDER By prejv2.para_code;
	GROUP By &groupy ;
	INTO Cursor portion3

m.groupy = 'portion3.acc_code'

Select &flist5;
	FROM portion3;
	ORDER By portion3.acc_code,portion3.p_l_name Desc ;
	GROUP By &groupy ;
	INTO Cursor portion4

Select *  From portion1 Union All Select * From portion2 Union All Select * From portion4 Into Cursor jvv

Select * From jvv ;
	HAVING jvv.dr > 0  Or  jvv.cr > 0 ;
	INTO Cursor jv

Return

Procedure jv
m.earnstr = ''
m.ded_str = ''

Select (m.d_p9paras)
Set Order To Tag para_des Of (m.i_p9paras)

Select t_params
Go Top
Replace All cost_code With 0 For para_code <> 35
Set Order To Tag para_code Of (m.tx_cdx)

m.seritem = 'EARNINGS' &&Earnings
Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode
	If Found()
		m.earnstr = Alltrim(t_params.p_formu1)
	Endif
Endif

m.seritem = 'NONSTAT' &&non statutory deductions

Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode&&
	If Found()
		m.ded_str = Alltrim(t_params.p_formu1)
	Endif
Endif

m.seritem = 'TOTNSSF' &&NSSF
Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode
	If Found()
		m.ded_str = m.ded_str+"'"+Alltrim(Str(t_params.para_code))+"'"
	Endif
Endif

m.seritem = 'OBEN' &&benefits
Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode &&NON CASH BENEFITS
	If Found()
		m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
		m.earnstr = m.earnstr+Alltrim(t_params.p_formu1)
	Endif
Endif

m.seritem = 'RENT' &&RENT
Select (m.d_p9paras)
Seek m.seritem

If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode
	If Found()
		m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
		m.earnstr = m.earnstr+Alltrim(t_params.p_formu1)
	Endif
Endif

m.seritem = 'STAT' &&STATUTORY
Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode  &&STAT

	If Found()
		m.ded_str = m.ded_str+Alltrim(t_params.p_formu1)
	Endif
Endif

m.seritem = 'NET' &&NSSF
Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode
	If Found()
		m.ded_str = m.ded_str+"'"+Alltrim(Str(t_params.para_code))+"'"
	Endif
Endif

m.seritem = 'NSSF' &&NSSF
Select (m.d_p9paras)
Seek m.seritem
If Found()
	m.sercode = para_code
	Select t_params
	Seek m.sercode

	If Found()
		m.earnstr = m.earnstr+Alltrim(t_params.p_formu1)
	Endif

Endif

m.flist = "t_params.cat_no,t_params.empcode,t_params.e_account,t_params.acc_code,"
m.flist = m.flist+"t_params.para_code,t_params.ccost,"
m.flist = m.flist+"t_params.sal_amt+t_params.op_amt+t_params.amt AS 'dr',"
m.flist = m.flist+"t_params.sal_amt+t_params.op_amt+t_params.amt AS 'cr',"
m.flist = m.flist+"ccent.cost_code,ccent.percent,"
m.flist = m.flist+"t_params.t_earnings,t_params.personal,t_params.p_l_name"

m.flist1 = "prejv.cat_no,prejv.e_account,prejv.acc_code,"
m.flist1 = m.flist1+"prejv.p_l_name,prejv.empcode,prejv.para_code,"
m.flist1 = m.flist1+"(prejv.percent/100)*prejv.dr AS 'DR',"
m.flist1 = m.flist1+"(prejv.percent/100)*prejv.Cr AS 'CR',"
m.flist1 = m.flist1+"prejv.percent,prejv.cost_code,prejv.t_earnings,"
m.flist1 = m.flist1+"prejv.personal"

m.pl_name = Space(50)
m.pl_name = 'Payroll 1 Salaries '+Left(Alltrim(mon(m.month)),3)+' '+Alltrim(Str(m.year))
*m.flist2 = "prejv2.p_l_name,prejv2.empcode,prejv2.para_code,"

m.tnone = 'NONE'+Space(11)
m.tnone2 = 'NONE'+Space(21)
m.tsal = '1210101'+Space(18)

m.flist2 = "LEFT(m.pl_name+SPACE(50),50) AS 'p_l_name',prejv2.empcode,prejv2.para_code,"
m.flist2 = m.flist2+"ROUND(SUM(convit(prejv2.dr)),1) AS 'DR',"
m.flist2 = m.flist2+"ROUND(convnil(prejv2.cr),1) AS 'CR',"
m.flist2 = m.flist2+"IIF(!EMPTY(cost_cen.c_account),m.tnone,cost_cen.COST_SNAME) AS 'COST_SNAME',IIF(!EMPTY(cost_cen.c_account),m.tnone2,cost_cen.GRANT) AS 'GRANT',prejv2.percent,"
m.flist2 = m.flist2+"IIF(!EMPTY(cost_cen.c_account),cost_cen.c_account,m.tsal) AS 'acc_code'"


m.flist3 = "prejv2.p_l_name,prejv2.empcode,prejv2.para_code,"
m.flist3 =m.flist3+"ROUND(convnil(prejv2.dr),1) AS 'DR',"
m.flist3 =m.flist3+" ROUND(SUM(convit(prejv2.cr)),1) AS 'CR',"
m.flist3 =m.flist3+"cost_cen.cost_sname,cost_cen.grant,prejv2.percent,prejv2.e_account AS 'acc_code' "


m.flist4 = "prejv2.p_l_name,prejv2.empcode,prejv2.para_code,"
m.flist4 =m.flist4+" ROUND(convnil(prejv2.dr),1) AS 'DR',"
m.flist4 =m.flist4+"ROUND(SUM(convit(prejv2.cr)),1) AS 'CR',"
m.flist4 =m.flist4+"cost_cen.cost_sname,cost_cen.grant,prejv2.percent,params.acc_code AS 'acc_code' "


m.flist5 = "portion3.p_l_name,portion3.empcode,portion3.para_code,"
m.flist5 =m.flist5+" ROUND(convit(portion3.dr),1) AS 'DR',"
m.flist5 =m.flist5+"ROUND(SUM(convit(portion3.cr)),1) AS 'CR',"
m.flist5 =m.flist5+"portion3.cost_sname,portion3.grant,portion3.percent,portion3.acc_code AS 'acc_code' "

Select &flist;
	FROM t_params,ccent,empdata;
	WHERE ccent.empcode = t_params.empcode And empdata.empcode = t_params.empcode ;
	HAVING t_params.added = 0 ;
	INTO Cursor prejv

Select &flist1;
	FROM prejv;
	INTO Cursor prejv1

m.groupy = 'prejv2.cost_code'

*SELECT *;
*	FROM prejv1;
*	HAVING prejv1.para_code = 3 OR prejv1.para_code = 36 OR prejv1.para_code = 51 OR prejv1.para_code = 31 OR prejv1.para_code = 6 OR prejv1.para_code = 72;
*	INTO CURSOR prejv2

******earnings

Select *;
	FROM prejv1;
	HAVING At("'"+Alltrim(Str(prejv1.para_code))+"'",m.earnstr) > 0;
	INTO Cursor prejv2


Select &flist2;
	FROM prejv2,cost_cen ;
	WHERE cost_cen.cost_code = prejv2.cost_code ;
	ORDER By prejv2.cost_code;
	GROUP By &groupy;
	INTO Cursor portion1


m.groupy = 'prejv2.para_code,prejv2.empcode'

**Deductions into personal accounts

*WAIT WINDOW m.ded_str TIMEOUT 30

Select *;
	FROM prejv1;
	HAVING prejv1.personal <> 0 And At("'"+Alltrim(Str(prejv1.para_code))+"'",m.ded_str) > 0 And !Empty(acc_code) ;
	INTO Cursor prejv2

Select &flist3;
	FROM prejv2,cost_cen,params ;
	WHERE params.para_code = prejv2.para_code And cost_cen.cost_code = params.cost_code ;
	ORDER By prejv2.para_code,prejv2.empcode;
	GROUP By &groupy;
	INTO Cursor portion2

m.groupy = 'prejv2.para_code'

**Deductions

Select *;
	FROM prejv1;
	HAVING prejv1.personal = 0 And At("'"+Alltrim(Str(prejv1.para_code))+"'",m.ded_str) > 0 And !Empty(acc_code) ;
	INTO Cursor prejv2

Select &flist4;
	FROM prejv2,cost_cen,params ;
	WHERE params.para_code = prejv2.para_code And cost_cen.cost_code = params.cost_code ;
	ORDER By prejv2.para_code;
	GROUP By &groupy ;
	INTO Cursor portion3


m.groupy = 'portion3.acc_code'

Select &flist5;
	FROM portion3;
	ORDER By portion3.acc_code,portion3.p_l_name Desc ;
	GROUP By &groupy ;
	INTO Cursor portion4

Select *  From portion1 Union All Select * From portion2 Union All Select * From portion4 Into Cursor jvv

Select * From jvv ;
	HAVING jvv.dr > 0  Or  jvv.cr > 0 ;
	INTO Cursor jv


Return

Procedure Control
Select t_params
m.flist = "t_params.empcode,"
m.flist = m.flist+"t_params.para_code,"
m.flist = m.flist+"ROUND(SUM(t_params.sal_amt+t_params.op_amt+t_params.amt),2) AS 'amt',"
m.flist = m.flist+"t_params.p_l_name,t_params.p_type,t_params.SHOWHI,t_params.NOSHOW,t_params.ADDED"

Select &flist;
	FROM t_params;
	GROUP By t_params.para_code;
	ORDER By t_params.position ;
	INTO Cursor Control
Select Control
Return




Procedure variance
Select (m.d_emp)
Set Order To Tag empcode Of (m.i_emp)

m.hascosts = .F.
m.salfile = .F.
m.nosfile = .F.

m.b_fields = ""  &&For export

m.ffrom = ""
m.fwhere = ""
m.fflist = ""

m.tc_dbf = m.tmppath+"tc"+Left(Sys(3),6)+".DBF" && temporary file for employee codes

m.ec_ty = "ec"+Left(Sys(3),6)

m.ec_dbf = m.datapath+m.ec_ty+".DBF" && temporary file for employee codes
m.ec_cdx = m.datapath+m.ec_ty+".CDX" && temporary file for employee codes

m.tu_dbf = m.tmppath+"tu"+Left(Sys(3),6)+".DBF" && temporary file for the salaries

m.xx_alias = "xx"+Left(Sys(3),6) &&Alias for the xtab file
m.xx_dbf = m.datapath+m.xx_alias+".DBF" && xtab file

m.x_alias = "x"+Left(Sys(3),6) &&Alias for the xtab file
m.x_dbf = m.datapath+m.x_alias+".DBF" && xtab file

Select novalues.empcode, empnos.nosname, novalues.novalue;
	FROM novalues, empnos;
	ORDER By novalues.empcode;
	WHERE empnos.nocode = novalues.nocode;
	INTO Table (m.tc_dbf)


m.testali = ""

If !Eof()
	Do genxtab.prg With (m.ec_dbf)
	m.testali = Alltrim(Alias())
	Select (m.testali)
	Index On empcode Tag empcode Of (m.ec_cdx) Ascending
Endif

Erase (m.tc_dbf)

*m.ffrom = m.ffrom+m.testali

Select (m.d_params)
Set Order To Tag para_code Of (m.i_params)

Select (m.d_f_list)
Set Order To Tag f_code Of (m.i_f_list)

Select (m.d_report)

m.b_list = ""
m.having = ""
m.fstr = ""

m.b_fields = ""
m.t_fields = ""

m.fstr = Alltrim(reports.rep_fields)
m.f_var = ""
Do While !Empty(m.fstr)

	m.fpos = At("}",m.fstr)
	m.f1 = Left(m.fstr,m.fpos-1)
	m.addf = Substr(m.f1,2)

	If m.fpos <> Len(m.fstr)
		m.fstr = Substr(m.fstr,m.fpos+1)
	Else
		m.fstr = ""
	Endif

	Select (m.d_f_list)
	Seek Val(m.addf)

	If Found()
		If !Empty(m.b_list)
			m.b_list = m.b_list+","
		Endif

		m.para_code = para_code
		If m.para_code > 0
			Select (m.d_params)
			Seek m.para_code

			If Found()
*IF !EMPTY(m.fflist)
*m.fflist = m.fflist+","
*ENDIF
*m.fflist = 	m.fflist+ALLTRIM(m.xx_alias)+".C"+ALLTRIM(STR(params.para_code))+"-"+ALLTRIM(m.xx_alias)+".P"+ALLTRIM(STR(params.para_code))

				m.b_list = 	m.b_list+Alltrim(f_list.f_name)

				If !Empty(m.b_fields)
					m.b_fields = m.b_fields+","
				Endif
				If !Empty(m.t_fields)
					m.t_fields = m.t_fields+","
				Endif

				m.b_fields = m.b_fields+Alltrim(m.xx_alias)+".C"+Alltrim(Str(params.para_code))+"-"+Alltrim(m.xx_alias)+".P"+Alltrim(Str(params.para_code))+" AS '"+Alltrim(f_list.f_name)+"'"
				m.t_fields = m.t_fields+Alltrim(m.x_alias)+".N_"+Alltrim(Str(params.para_code))+" AS '"+Alltrim(f_list.f_name)+"'"

				If !Empty(m.b_list2)
					m.b_list2 = m.b_list2+","
				Endif
				m.b_list2 = m.b_list2+"convit(flist."+Alltrim(f_list.f_name)+") AS '"+Alltrim(f_list.f_name)+"'"  &&Second list
				m.b_list = 	m.b_list+ " :H= '"+Alltrim(params.p_l_name)+"'"
				If !Empty(m.having)
					m.having = m.having+" OR "
				Endif
				m.having = m.having+" t_params.para_code = "+Alltrim(Str(params.para_code))
				m.salfile = .T.
			Endif
		Else
			If !Empty(m.fflist)
				m.fflist = m.fflist+","
			Endif

			If !Empty(m.b_fields)
				m.b_fields = m.b_fields+","
			Endif

			If Upper(Alltrim(f_alias)) = "EMPNOS"
				m.fflist = 	m.fflist+Alltrim(m.testali)+"."+Alltrim(f_name)
				m.b_list = 	m.b_list+Alltrim(f_name)
				m.b_fields = m.b_fields+Alltrim(m.testali)+"."+Alltrim(f_name)
				m.nosfile = .T.
			Else
				If Upper(Alltrim(f_alias)) = "CCENT"
					m.hascosts = .T.
				Endif
				m.fflist = 	m.fflist+Alltrim(f_alias)+"."+Alltrim(f_name)
				m.b_list = 	m.b_list+Alltrim(f_name)
				m.b_fields = m.b_fields+Alltrim(f_alias)+"."+Alltrim(f_name)
			Endif

			If !Empty(m.b_list2)
				m.b_list2 = m.b_list2+","
			Endif
			m.b_list2 = m.b_list2+"flist."+Alltrim(f_list.f_name) &&Second list
		Endif
	Endif

Enddo

Select t_params
Set Order To Tag empcode Of (m.tx_cdx)

m.flist = "t_params.empcode,t_params.para_code,t_params.sal_amt+t_params.op_amt+t_params.amt AS 'pay' "

m.from = " t_params"
m.order = "t_params.empcode,t_params.position "

m.xtabali = ""

If !Empty(m.having)
	Do Varr &&Create the necessary cursors for comparison
	If !Eof()
		Do genxtab.prg With (m.xx_dbf)
		m.xtabali = Alltrim(Alias())

		If !Empty(m.ffrom)
			m.ffrom = m.ffrom+","
		Endif
		m.ffrom = m.ffrom+m.xtabali
	Else
		m.xx_dbf = ""
	Endif
Endif

*m.testali &&EMPNOS
*m.xtabali &&t_params

If Empty(m.xtabali)
	If Empty(m.testali)
		m.ffrom = 'empdata,depts,paymodes'
		m.fwhere = 'depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Else
		m.ffrom = Alltrim(m.testali)+',empdata,depts,paymodes'
		m.fwhere = m.testali+'.empcode = empdata.empcode AND depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Endif
	If m.hascosts
		m.fwhere = m.fwhere+' AND ccent.empcode = empdata.empcode'
		m.ffrom  =  m.ffrom+',ccent'
	Endif
Else
	If Empty(m.testali)
		m.ffrom = m.xtabali+',empdata,depts,paymodes'
		m.fwhere ='empdata.empcode = '+m.xtabali+'.empcode AND depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Else
		m.ffrom = m.xtabali+','+Alltrim(m.testali)+',empdata,depts,paymodes'
		m.fwhere ='empdata.empcode = '+m.xtabali+'.empcode AND '+m.testali+'.empcode = '+m.xtabali+'.empcode AND depts.deptcode = empdata.deptcode AND paymodes.mode = empdata.mode'
	Endif
	If m.hascosts
		m.fwhere = m.fwhere+' AND ccent.empcode = empdata.empcode'
		m.ffrom  =  m.ffrom+',ccent'
	Endif
Endif
Return


Procedure Varr
m.lmonth = m.month
m.lyear = m.year
m.flist = "t_params.empcode,"

m.t_dbf = m.tmppath+"t"+Left(Sys(3),6)+".dbf" &&Index for the temporary file
m.v_dbf = m.tmppath+"v"+Left(Sys(3),6)+".dbf" &&Index for the temporary file

m.tflist = "1 AS 'E_ID',t_params.para_code,"
m.tflist = m.tflist+"ROUND(SUM(t_params.sal_amt+t_params.op_amt+t_params.amt),2) AS 'amt'"

Select &tflist From t_params Group By t_params.para_code Into Table (m.t_dbf)
m.talias = Alias()

Do genxtab.prg With (m.x_dbf)
Select &t_fields From (m.x_alias) Into Cursor o_bal

Select (m.x_alias)
Use

*SELECT (M.TALIAS)
*USE

m.flist = m.flist+" 'C'+ALLTRIM(STR(t_params.para_code)) AS 'IDENTITY',"
m.flist = m.flist+"ROUND(t_params.sal_amt+t_params.op_amt+t_params.amt,2) AS 'amt'"
m.untill = " empcode = m.empcode AND !EOF()"

Select &flist From t_params Into Cursor Current


m.lmonth = m.lmonth-1

If m.lmonth = 0
	m.lyear = m.year-1
	m.lmonth = 12
Endif

*m.untill = " empcode = m.empcode AND !EOF()"
m.untill = ""

Create Cursor  t_params &cur_str

Select t_params

Index On empcode Tag empcode Of (m.tx_cdx) Ascending
Index On para_code Tag para_code  Of (m.tx_cdx) Ascending
Index On position Tag position  Of (m.tx_cdx) Ascending
Index On pos_no Tag pos_no  Of (m.tx_cdx) Ascending
Index On ord_no Tag ord_no  Of (m.tx_cdx) Ascending


*IF !isclosed()
m.oldemps = .T.

Do getthem &&Get past Data

*DO calcthem
*ELSE
*	DO getthem2 &&Get past Data
*ENDIF

Select &tflist From t_params Group By t_params.para_code Into Table (m.t_dbf)
m.talias = Alias()

Do genxtab.prg With (m.x_dbf)

Select &t_fields From (m.x_alias) Into Cursor c_bal

Select (m.x_alias)
Use

*SELECT (M.TALIAS)
*USE

m.flist = "t_params.empcode,"
m.flist = m.flist+" 'P'+ALLTRIM(STR(t_params.para_code)) AS 'IDENTITY',"
m.flist = m.flist+"ROUND(t_params.sal_amt+t_params.op_amt+t_params.amt,2) AS 'amt'"

Select &flist From t_params Into Cursor past


Select past.empcode,past.identity,past.amt;
	FROM past Union All Select Current.empcode,Current.identity,Current.amt;
	FROM Current ;
	INTO Cursor variance

m.tv_dbf = m.tmppath+"tv"+Left(Sys(3),6)+".dbf" &&Index for the temporary file
m.vv_dbf = m.tmppath+"vv"+Left(Sys(3),6)+".dbf" &&Index for the temporary file

Select * From variance Order By variance.empcode,variance.identity  Into Table (m.tv_dbf)
Return

Procedure r_add
m.repadd = .T.
m.repedit = .F.
Create Cursor  fil_l (f_l_des C(254), f_i_pos N(3),;
	c_i_pos N(3),Value C(238))
Select (m.d_report)
Scatter Memvar Blank Memo
Do editmode
Do c_pop
Return

Procedure r_edit
m.repadd = .F.
m.repedit = .T.
Do c_pop
Do editmode
Return


Procedure r_del
Select (m.d_report)
Delete
Return

Procedure r_cancel
Do defamode
Return

Procedure editmode
Show  Get m.op,1 Disable
Show  Get m.op,2 Disable
Show  Get m.op,3 Enable
Show  Get m.op,4 Prompt "Cancel"

Show  Get m.rep_name Enable
Show  Get m.movit Enable
Return

Procedure defamode
Select (m.d_report)
Set Relation To
Set Relation To curr_code  Into (m.d_currency) Additive

Scatter Memvar Memo
m.repadd = .F.
m.repedit = .F.

Show  Get m.rep_name Disable
Show  Get m.movit Disable
Show  Get m.op,1 Enable
Show  Get m.op,2 Enable

Show  Get m.op,3 Disable
Show  Get m.op,4 Prompt "Delete"

Do c_pop

Return

*************GROUPS


Procedure g_add
m.g_add = .T.
m.g_edit = .F.
Do editmode2
Do c_pop2
Return

Procedure g_edit
m.g_add = .F.
m.g_edit = .T.
Do c_pop2
Do editmode2
Return


Procedure g_del
Return

Procedure g_cancel
Do defamode2
Return

Procedure editmode2
Show  Get m.op_g,1 Disable
Show  Get m.op_g,2 Disable
Show  Get m.op_g,3 Enable
Show  Get m.op_g,4 Prompt "Cancel"

Show  Get m.cat_name Enable
Show  Get m.movit2 Enable
Return

Procedure defamode2
Select (m.d_r_cats)
Scatter Memvar Memo
m.g_add = .F.
m.g_edit = .F.

Show  Get m.cat_name Disable
Show  Get m.movit2 Disable
Show  Get m.op_g,1 Enable
Show  Get m.op_g,2 Enable

Show  Get m.op_g,3 Disable
Show  Get m.op_g,4 Prompt "Delete"
Do c_pop2
Return


*******************
Procedure modirep
If !Empty(reports.r_name)
	m.repfile = m.datapath+Alltrim(reports.r_name)+".FRX"
	Do Case
	Case Upper(Alltrim(reports.rep_name)) = 'P9A (BACK PAGE)'
		m.repfile = m.datapath+"P9A_2.FRX"
	Case Alltrim(reports.rep_name) = 'P9A'
		m.l_type = Alltrim(reports.r_name)
		m.repfile = m.datapath+m.l_type+".FRX"
	Case Alltrim(reports.rep_name) = 'P10'
		m.repfile = m.datapath+"P10.FRX"
	Case Alltrim(reports.rep_name) = 'AP10'
		m.repfile = m.datapath+"P10A.FRX"
	Case Alltrim(reports.rep_name) = 'SPREAD'
		m.repfile = m.datapath+"SPREAD.FRX"
	Case Alltrim(reports.rep_name) = 'ANNUAL TAX ANALYSIS'
		m.repfile = m.datapath+"annualiz.FRX"
	Case Alltrim(reports.rep_name) = 'PAY_SUM'
		m.repfile = m.datapath+"pay_sum.FRX"
	Case Alltrim(reports.rep_name) = 'NHIF'
		m.repfile = m.datapath+"NHIF.FRX"
	Case Alltrim(reports.rep_name) = 'W9F'
		m.repfile = m.datapath+"W9F.FRX"
	Case Alltrim(reports.rep_name) = 'W10F'
		m.repfile = m.datapath+"W10F.FRX"
	Endcase
Else
	m.repfile = m.datapath+"R_"+Alltrim(Str(reports.cat_no))+"_"+Alltrim(Str(reports.rep_code))+".FRX"
Endif

Do Case
Case Alltrim(reports.rep_name) = 'ANNUAL TAX ANALYSIS'
	m.repfile = m.datapath+"annualiz.FRX"
Endcase

If File(m.repfile)
	Modify Report (m.repfile)
Endif
Return

Procedure modicov
m.covfile = m.datapath+"C_"+Alltrim(Str(reports.cat_no))+"_"+Alltrim(Str(reports.rep_code))+".FRX"
If File(m.covfile)
	Modify Report (m.covfile) &&WINDOW repwin
Endif
Return


Procedure genrep
m.head = Alltrim(reports.Head)
m.foot = Alltrim(reports.Foot)

m.b_list2 = ""
m.b_list = ""

m.ffrom = ""
m.fwhere = ""

m.fflist = ""
m.ffilter = Alltrim(reports.ffilter)

*m.testali &&EMPNOS
*m.xtabali &&t_params

m.b_fields = ""


If reports.r_name = 'DETPAY'
	Do det_pay
	m.isdet = .T.
Else
	Do Case
	Case Alltrim(reports.r_name) = 'NHIF'
		Do setnhif
	Case Alltrim(reports.r_name) = 'PAY_SUM'
		Do setsum
	Otherwise
		Do createit
	Endcase
Endif


If !m.isdet
	If !m.annual
		If At('t_banks',m.b_fields) > 0
			Select branches.br_code,banks.bk_name,branches.br_name,branches.sort_code,branches.noeft;
				FROM banks, branches;
				ORDER By branches.br_code;
				WHERE banks.bk_code = branches.bk_code;
				INTO Cursor t_banks
			m.fwhere = m.fwhere+' AND t_banks.br_code = empdata.br_code'
			m.ffrom  =  m.ffrom+',t_banks'
		Endif

*IF !EMPTY(m.fflist)
		If Empty(reports.r_name)
			m.b_fields = " "+m.b_fields
			m.ffilter = Strtran(m.ffilter,"EMPNOS.",Alltrim(m.testali)+".") &&Employee number
			m.ffilter = Strtran(m.ffilter,"t_params.",Alltrim(m.xtabali)+".") &&Salary details

			If !Empty(m.ffilter)
				If !Empty(m.fflist)
					Select &b_fields;
						FROM &ffrom;
						WHERE &fwhere;
						HAVING &ffilter;
						ORDER By &fflist;
						INTO Cursor flist

				Else
					Select &b_fields;
						FROM &ffrom;
						WHERE &fwhere;
						HAVING &ffilter;
						INTO Cursor flist
				Endif

			Else
				If !Empty(m.fflist)
					Select &b_fields;
						FROM &ffrom;
						WHERE &fwhere;
						ORDER By &fflist;
						INTO Cursor flist

				Else
					Select &b_fields;
						FROM &ffrom;
						WHERE &fwhere;
						INTO Cursor flist
				Endif
			Endif

			Select flist

			If m.hascosts
				Select &b_list2;
					FROM flist;
					INTO Cursor flist2
				Select flist2
			Endif
			m.repfile = m.datapath+"R_"+Alltrim(Str(reports.cat_no))+"_"+Alltrim(Str(reports.rep_code))+".FRX"
		Else
			m.t_file = Alltrim(reports.r_name)
			Select (m.t_file)
			Go Top
			m.repfile = m.datapath+m.t_file+".FRX"
			m.b_list = Alltrim(reports.s_f_list)
		Endif

		m.covfile = m.datapath+"C_"+Alltrim(Str(reports.cat_no))+"_"+Alltrim(Str(reports.rep_code))+".FRX"

		m.typi = Alltrim(dests.Type)
		m.deli = Upper(Alltrim(dests.Delimited))
		m.des_ext = Alltrim(dests.des_ext)
		m.tval = 0

	Else
**P9A
	Endif
Endif
Return


Function getcount
Parameters t_para
m.tpara = t_para
m.thisamt = 0
m.t_emp = p9a_2.empcode
m.tpara = Alltrim(m.tpara)
Select p9a
Calculate Cnt() To m.thisamt For &tpara <> 0 And p9a.empcode = p9a_2.empcode
Select p9a_2
Return m.thisamt

Function getsum
Parameters t_para,ccf,cce
m.tpara = t_para
If !Empty(ccf)
	m.tccf = ccf
	If Empty(cce)
		m.tcce = 0
	Else
		m.tcce = cce
	Endif
	If m.tcce <> 0 And m.tccf = 0
		m.tccf = 1
	Endif
	If m.tccf <> 0 And m.tcce = 0
		m.tcce = 9999
	Endif
Else
	m.tcce = 0
	m.tccf = 0
Endif
m.thisamt = 0
m.t_emp = p9a_2.empcode
m.tpara = Alltrim(m.tpara)
Select p9a
Go Top
If m.tccf <> 0
	Calculate Sum(&tpara) To m.thisamt For &tpara <> 0 And p9a.empcode = p9a_2.empcode And p9a.carsize >= m.tccf And p9a.carsize <= m.tcce
Else
	Calculate Sum(&tpara) To m.thisamt For &tpara <> 0 And p9a.empcode = p9a_2.empcode
Endif

Select p9a_2
Return m.thisamt

Function getpin
Parameters t_pin
m.tt_pin = Alltrim(Str(t_pin))+"/1/"
m.thispin = ""
Select(m.d_novalues)
Set Order To Tag nocombo Of (m.i_novalues)
Seek m.tt_pin
If Found()
	m.thispin = Alltrim(novalue)
Endif
Return m.thispin

Function getamts
Parameters paraval
m.paraval = paraval
m.retamt = 0
Select p9paras
Go Top
Locate For Alltrim(Upper(para_des)) = Alltrim(m.paraval)
If Found()
	m.defavalue = defavalue
	m.para_code = para_code
	Select (m.dfile)
	Go Top
	Locate For para_code = m.para_code And staffno = lLstaffno
	If Found()
		m.retamt = d_amt
	Else
		m.retamt = m.defavalue
	Endif
Endif
Return m.retamt


Function getlower
Parameters te1,te2,te3
m.retamt = 0
m.te1 = te1
m.te2 = te2
m.te3 = te3
If m.te1 < m.te2
	m.retamt = m.te1
	If m.te3 < m.te1
		m.retamt = m.te3
	Endif
Else
	m.retamt = m.te2
	If m.te3 < m.te2
		m.retamt = m.te3
	Endif
Endif
Return m.retamt

Function gettax
Parameters thisemp
m.temp_per = thisemp+"*13)"
m.retamt = 0

Select t_params
Seek m.temp_per
If Found()
	m.retamt = op_amt+sal_amt+amt
Endif
Return m.retamt

Function gettax2
Parameters thisemp
m.temp_per = thisemp+"*5)" &&81
m.retamt = 0
Select t_params
Seek m.temp_per
If Found()
	m.retamt = op_amt+sal_amt+amt
Endif
Return m.retamt

Function getrel
Parameters thisemp
m.temp_per = thisemp+"*14)"
m.retamt = 0
Select t_params
Seek m.temp_per
If Found()
	m.retamt = op_amt+sal_amt+amt
Endif
Return m.retamt

Procedure c_pop &&Create popup for fields
Deactivate Popup All
If m.repadd Or m.repedit
	Define Popup f_pop;
		IN reports2;
		MULTISELECT;
		FROM 10.538,1.800;
		TO 22.400,31.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,255,255,255)

	Define Popup f_pop2;
		IN reports2;
		MULTISELECT;
		MOVER;
		FROM 10.538,42.400;
		TO 22.400,73.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,255,255,255)
Else
	Define Popup f_pop;
		IN reports2;
		FROM 10.538,1.800;
		TO 22.400,31.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,192,192,192)

	Define Popup f_pop2;
		IN reports2;
		FROM 10.538,42.400;
		TO 22.400,73.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,192,192,192)
Endif

Do b_temp

Return

Procedure b_temp &&Create popup for fields

m.ix_cdx = m.tmppath+"ix"+Left(Sys(3),6)+".cdx"
Create Cursor sel_list (para_code N(5),f_alias C(10),f_code N(10),f_name C(20),p_code N(10),f_pos N(10),c_pos N(10),c_pos2 N(10),f_des C(50),f_size N(3),f_dec N(2),f_type C(1),Format C(12))

Index On f_code Tag f_code Of (m.ix_cdx) Ascending
Index On c_pos Tag c_pos Of (m.ix_cdx) Additive
Index On c_pos2 Tag c_pos2 Of (m.ix_cdx) Additive

Select (m.d_f_list)
Set Order To Tag f_code Of (m.i_f_list)


m.fstr = Alltrim(r_cats.cat_fields)
m.count = 0

Do While !Empty(m.fstr)
	m.fpos = At("}",m.fstr)
	m.f1 = Left(m.fstr,m.fpos-1)
	m.addf = Substr(m.f1,2)

	If m.fpos <> Len(m.fstr)
		m.fstr = Substr(m.fstr,m.fpos+1)
	Else
		m.fstr = ""
	Endif

	Select (m.d_f_list)
	Seek Val(m.addf)

	If Found()
		m.f_pos = Recno()
		Scatter Memvar Memo
		m.count = m.count+1
		m.c_pos = m.count
		Select sel_list
		Append Blank
		Gather Memvar
		Define Bar m.count Of f_pop Prompt Iif(m.repadd Or m.repedit,sel_list.f_name,"  "+sel_list.f_name)
	Endif
Enddo

**********Selected fields
If !m.repadd
	Select sel_list
	Set Order To Tag f_code Of (m.ix_cdx)

	m.fstr2 = Alltrim(reports.rep_fields)
	m.count2 = 0

	Do While !Empty(m.fstr2)
		m.fpos = At("}",m.fstr2)
		m.f1 = Left(m.fstr2,m.fpos-1)
		m.addf = Substr(m.f1,2)

		If m.fpos <> Len(m.fstr2)
			m.fstr2 = Substr(m.fstr2,m.fpos+1)
		Else
			m.fstr2 = ""
		Endif

		Select sel_list
		Seek Val(m.addf)

		If Found()
			m.count2 = m.count2+1
			Replace c_pos2 With m.count2
			Set Skip Of Bar sel_list.c_pos Of f_pop .T.
			Define Bar m.count2 Of f_pop2 Prompt Iif(m.repadd Or m.repedit,sel_list.f_name,"  "+sel_list.f_name)
		Endif
	Enddo
Endif


On Selection Popup f_pop Do sho_f

If Cntbar('f_pop') > 0
	Activate Popup f_pop Nowait
Endif

If Cntbar('f_pop2') > 0
	Activate Popup f_pop2 Nowait
Endif

Set Border To Single
Return


Function build_s &&Build selection str
m.oldarea = Select()

Select sel_list
Set Order To Tag c_pos2 Of (m.ix_cdx)
m.cnt = Cntbar('f_pop2')
m.counter = 0
m.repf = ""

Do While m.counter <= m.cnt-1
	m.counter = m.counter+1
	m.l_selbar = Getbar('f_pop2',m.counter)
	Select sel_list
	Seek m.l_selbar

	If Found()
		m.repf = m.repf+"{"+Alltrim(Str(f_code))+"}"
	Endif
Enddo

Select(m.oldarea)
Return m.repf

Procedure sho_f
Return

Procedure movethem
m.oldarea = Select()

Do Case
Case m.movit = 1 Or m.movit = 2
	Select sel_list

	Set Order To Tag c_pos Of (m.ix_cdx)
	m.cnt = Cntbar('f_pop')
	m.counter = 0

	Do While m.counter <= m.cnt-1
		m.counter = m.counter+1

		If (!Mrkbar('f_pop',m.counter) And m.movit = 1) Or Skpbar('f_pop',m.counter)
			Loop
		Endif

		Select sel_list
		Seek m.counter

		If Found()
			m.p_size = Cntbar('f_pop2')+1
			Replace c_pos2 With m.p_size

			Define Bar m.p_size Of f_pop2 Prompt Iif(m.repadd Or m.repedit,sel_list.f_name,"  "+sel_list.f_name)

			Set Skip Of Bar sel_list.c_pos Of f_pop .T.
		Endif
	Enddo

	If Cntbar('f_pop2') > 0
		Activate Popup f_pop2 Nowait
	Endif
Case m.movit = 3 Or m.movit = 4

	Select sel_list
	Set Order To Tag c_pos2 Of (m.ix_cdx)
	m.cnt = Cntbar('f_pop2')
	m.counter = 0
	m.repf = ""

	Do While m.counter <= m.cnt-1
		m.counter = m.counter+1

		If !Mrkbar('f_pop2',m.counter) And m.movit = 4
			Loop
		Endif

		m.l_selbar = Getbar('f_pop2',m.counter)
		Select sel_list
		Seek m.l_selbar

		If Found()
			Replace c_pos2 With 0
			Set Skip Of Bar sel_list.c_pos Of f_pop .F.
		Endif
	Enddo

	Deactivate Popup 'f_pop2'
	Define Popup f_pop2;
		IN reports2;
		MULTISELECT;
		MOVER;
		FROM 10.538,42.400;
		TO 22.615,73.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,255,255,255)

**Rebuild popup
	Select sel_list
	Go Top
	m.counter = 0

	Do While !Eof()
		If c_pos2 > 0
			m.counter = m.counter+1
			Replace c_pos2 With m.counter
			Define Bar m.counter Of f_pop2 Prompt Iif(m.repadd Or m.repedit,sel_list.f_name,"  "+sel_list.f_name)
		Endif
		Skip
	Enddo

	If Cntbar('f_pop2') > 0
		Activate Popup f_pop2 Nowait
	Endif
Endcase

Select(m.oldarea)
Return


Procedure c_pop2 &&Create popup for fields
Deactivate Popup All

If m.g_add Or m.g_edit
	Define Popup g_pop;
		IN reports3;
		MULTISELECT;
		FROM 10.615,1.800;
		TO 22.692,31.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,255,255,255)

	Define Popup g_pop2;
		IN reports3;
		MULTISELECT;
		MOVER;
		FROM 10.538,42.400;
		TO 22.615,73.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,255,255,255)
Else
	Define Popup g_pop;
		IN reports3;
		FROM 10.615,1.800;
		TO 22.692,31.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,192,192,192)

	Define Popup g_pop2;
		IN reports3;
		FROM 10.538,42.400;
		TO 22.615,73.600;
		MARGIN;
		COLOR ,Rgb(0,0,255,192,192,192)
Endif

m.gx_cdx = m.tmppath+"gx"+Left(Sys(3),6)+".cdx"

Create Cursor sel_g_list (f_code N(10),f_des C(50),p_code N(10),f_pos N(10),c_pos N(10),c_pos2 N(10))

Index On f_des Tag f_des Of (m.gx_cdx) Ascending
Index On f_code Tag f_code Of (m.gx_cdx) Additive
Index On c_pos2 Tag c_pos2 Of (m.gx_cdx) Additive
Index On c_pos Tag c_pos Of (m.gx_cdx) Additive

Select (m.d_f_list)
Set Order To Tag f_name Of (m.i_f_list)
Go Top
m.count = 0

Do While !Eof()
	m.f_pos = Recno()
	Scatter Memvar
	m.count = m.count+1
	m.c_pos = m.count

	Select sel_g_list
	Append Blank
	Gather Memvar

	Define Bar m.count Of g_pop Prompt Iif(m.repadd Or m.repedit,sel_g_list.f_des,"  "+sel_g_list.f_des)
	Select (m.d_f_list)
	Skip
Enddo

**********Selected fields
If !m.g_add
	Select sel_g_list
	Set Order To Tag f_code Of (m.gx_cdx)

	m.fstr2 = Alltrim(r_cats.cat_fields)
	m.count2 = 0

	Do While !Empty(m.fstr2)
		m.fpos = At("}",m.fstr2)
		m.f1 = Left(m.fstr2,m.fpos-1)
		m.addf = Substr(m.f1,2)

		If m.fpos <> Len(m.fstr2)
			m.fstr2 = Substr(m.fstr2,m.fpos+1)
		Else
			m.fstr2 = ""
		Endif

		Select sel_g_list
		Seek Val(m.addf)

		If Found()
			m.count2 = m.count2+1
			Replace c_pos2 With m.count2
			Set Skip Of Bar sel_g_list.c_pos Of g_pop .T.
			Define Bar m.count2 Of g_pop2 Prompt Iif(m.g_add Or m.g_edit,sel_g_list.f_des,"  "+sel_g_list.f_des)
		Endif
	Enddo
Endif


If Cntbar('g_pop') > 0
	Activate Popup g_pop Nowait
Endif

If Cntbar('g_pop2') > 0
	Activate Popup g_pop2 Nowait
Endif

Set Border To Single
Return


Procedure sho_f
Return


Function convit
Parameters f_amt
m.f_amt = f_amt
m.f_amt  = Round(m.f_amt,4)
Return m.f_amt

Function convit2
Parameters f_amt
m.f_amt = f_amt
m.multi = (percent/100)
m.f_amt  = Round(m.f_amt*m.multi,4)
Return m.f_amt

Function convnil
Parameters f_amt
m.t = 0.00
Return m.t



Function p9a && Produces a p9a form
m.b_list = " * "

Return



Procedure det_pay
Select (m.d_emp)
Set Order To Tag empcode Of (m.i_emp) In (m.d_emp)

Select (m.d_params)
Set Order To Tag para_code Of (m.i_params) In (m.d_params)
Seek 3
m.p_gross = Alltrim(p_formu1)

Seek 15
m.p_nonst = Alltrim(p_formu1)

Skip
m.p_stat = Alltrim(p_formu1)

Create Cursor detpay (oldempcode C(10),deptcode N(4),surname C(15),onames C(25),empcode N(4),eitem C(25),earning N(12,2),ditem C(25),deduct N(12,2),mode N(1))

m.td_cdx = m.tmppath+"td"+Left(Sys(3),6)+".cdx"

Select detpay

Index On deptcode Tag deptcode  Of (m.td_cdx) Additive
Index On empcode Tag empcode  Of (m.td_cdx) Additive
Index On surname Tag surname  Of (m.td_cdx) Additive

Select detpay
Set Order To

Select t_params
*SET ORDER TO TAG empcode OF (m.tx_cdx)

Set Order To Tag commb Of (m.tx_cdx)

Set Relation To deptcode Into (m.d_depts) Additive
Set Relation To empcode Into (m.d_emp) Additive

Go Top

m.elevel = 1
m.dlevel = 1


Do While !Eof()
	Scatter Memvar

	If t_params.added = 0

		m.empc = m.empcode

		m.eitem = ''
		m.ditem = ''

		m.deduct = 0
		m.earning = 0

		m.strpara = Alltrim(Str(para_code))

		Select detpay

		If  At("F_EVAL('"+m.strpara+"')",m.p_gross) > 0

			m.eitem = Alltrim(t_params.p_l_name)
			m.earning = t_params.sal_amt+t_params.amt+t_params.op_amt

			If m.earning > 0 And t_params.added = 0

				Select detpay
				If m.elevel > Reccount()
					Append Blank
				Else
					Goto m.elevel
				Endif

				Gather Memvar Fields empcode,deptcode,eitem,earning,mode

				m.surname = Alltrim(empdata.surname)
				m.onames = Alltrim(empdata.onames)
				m.oldempcode = Alltrim(empdata.oldempcode)
				Replace surname With m.surname
				Replace onames With m.onames
				Replace oldempcode With m.oldempcode
				m.elevel = m.elevel+1
			Endif
		Else
			If At("F_EVAL('"+m.strpara+"')",m.p_stat) > 0

				m.ditem = Alltrim(t_params.p_l_name)
				m.deduct = t_params.sal_amt+t_params.amt+t_params.op_amt

				If  t_params.added = 0 And !Empty(m.empcode) && AND m.deduct > 0
					Select detpay

					If m.dlevel > Reccount()
						Append Blank
					Else
						Goto m.dlevel
					Endif

					Gather Memvar Fields empcode,deptcode,ditem,deduct,mode

					m.surname = Alltrim(empdata.surname)
					m.onames = Alltrim(empdata.onames)

					m.oldempcode = Alltrim(empdata.oldempcode)

					Replace surname With m.surname
					Replace onames With m.onames
					Replace oldempcode With m.oldempcode

					m.dlevel = m.dlevel+1
				Endif
			Else
				If  At("F_EVAL('"+m.strpara+"')",m.p_nonst) > 0
					m.ditem = Alltrim(t_params.p_l_name)
					m.deduct = t_params.sal_amt+t_params.amt+t_params.op_amt

					If  t_params.added = 0 And !Empty(m.empcode) && AND m.deduct > 0
						Select detpay

						If m.dlevel > Reccount()
							Append Blank
						Else
							Goto m.dlevel
						Endif
						Gather Memvar Fields empcode,deptcode,ditem,deduct,mode

						m.surname = Alltrim(empdata.surname)
						m.onames = Alltrim(empdata.onames)

						m.oldempcode = Alltrim(empdata.oldempcode)

						Replace surname With m.surname
						Replace onames With m.onames
						Replace oldempcode With m.oldempcode

						m.dlevel = m.dlevel+1

					Endif

				Endif
			Endif
		Endif
	Endif

	Select t_params
	If !Eof()
		Skip
	Endif

	If !Eof() And m.empc <> t_params.empcode
		Select detpay
		Append Blank
		m.dlevel= Recno()
		m.elevel= Recno()
	Endif
	Select t_params
Enddo


Select detpay

Select * From detpay Order By oldempcode Having !Empty(detpay.empcode) Into Cursor det

Select det
Go Top

m.repfile = m.datapath+"detpay.FRX"


Select detpay
Use
Erase (m.td_cdx)

Select det
Use

m.isdet = .T.
m.annual = .T.

Return


Procedure e_rep
m.majfile = Select()


Go Top

m.typi = Alltrim(dests.Type)
m.deli = Upper(Alltrim(dests.Delimited))
m.des_ext = Alltrim(dests.des_ext)

Do Case
Case Upper(Alltrim(reports.rep_name)) = 'P9A (BACK PAGE)'
	m.repfile = m.datapath+"P9A_2.FRX"
Case Alltrim(reports.rep_name) = 'P9A'
	m.l_type = Alltrim(reports.r_name)
	m.repfile = m.datapath+m.l_type+".FRX"
Case Alltrim(reports.rep_name) = 'P10'
	m.repfile = m.datapath+"P10.FRX"
Case Alltrim(reports.rep_name) = 'AP10'
	m.repfile = m.datapath+"P10A.FRX"
Case Alltrim(reports.rep_name) = 'SPREAD'
	m.repfile = m.datapath+"SPREAD.FRX"
Case Alltrim(reports.rep_name) = 'ANNUAL TAX ANALYSIS'
	m.repfile = m.datapath+"annualiz.FRX"
	Select taxdiff
	Go Top
Endcase

Do Case
Case Upper(Alltrim(dests.Type)) = "BROWSE"
	If !Empty(m.b_list) And Alltrim(m.b_list) <> '*'
		Browse Window win_brow Title Alltrim(reports.rep_name) Fields &b_list
	Else
		Browse Window win_brow Title Alltrim(reports.rep_name)
	Endif
Case Upper(Alltrim(dests.Type)) = "PRINTER"
	If File(m.repfile)
		Report Form (m.repfile) To Print Prompt Noconsole
	Endif
Case Upper(Alltrim(dests.Type)) = "PREVIEW"
	If File(m.repfile)
		Report Form (m.repfile) Preview
	Endif
Case Upper(Alltrim(dests.Type)) = "CASH"
	m.repfile = m.datapath+"DETCOIN.FRX"
	m.alias = Alias()
	If File(m.repfile) And opendbf(m.d_money)
		m.co_cdx = m.tmppath+"co"+Left(Sys(3),6)+".cdx"

		Create Cursor det_coin (oldempcode C(10), onames C(25),surname C(15), tnet N(12,2), n_1000 N(4), n_500 N(4),n_200 N(4), n_100 N(4),;
			n_50 N(4), n_20 N(4),n_10 N(4),n_5 N(4),n_1 N(4),nc_50 N(4),nc_10 N(4))

		Select det_coin
		Index On oldempcode Tag oldempcode  Of (m.co_cdx) Additive

		Select(m.d_money)
		Set Order To Tag Value Of (m.i_money)
		Replace All Number With 0

		Select (m.alias)
		Go Top
		If !Eof()
			Do While !Eof()
				m.bal=net
				m.oldempcode = oldempcode
				m.surname = surname
				m.onames = onames

				Select det_coin
				Append Blank
				Replace tnet With m.bal
				Replace oldempcode With m.oldempcode
				Replace surname With Alltrim(m.surname)
				Replace onames With Alltrim(m.onames)

				Select(m.d_money)
				Go Top

				Do While !Eof()
					m.den = Upper(Alltrim(Desc))
					m.num = ((m.bal-(m.bal%Value))/Value)
					Do Case
					Case Value = 1000
						m.cValue = "1000"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 500
						m.cValue = "500"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 200
						m.cValue = "200"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 100
						m.cValue = "100"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 50
						m.cValue = "50"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 20
						m.cValue = "20"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 10
						m.cValue = "10"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 5
						m.cValue = "5"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 1
						m.cValue = "1"
						m.rep_den = "N_"+Alltrim(Str(Value))
					Case Value = 0.50
						m.cValue = "50"
						m.rep_den = "NC_"+Alltrim(m.cValue)
					Case Value = 0.10
						m.cValue = "10"
						m.rep_den = "NC_"+Alltrim(m.cValue)
					Endcase

					Select det_coin
					Replace &rep_den With m.num

					Select(m.d_money)
					Replace Number With Number+m.num
					m.bal=m.bal%Value
					Skip
				Enddo
				Select(m.alias)
				Skip
			Enddo

			Select det_coin
			Set Order To Tag oldempcode Of (m.co_cdx)
			Go Top

			Browse Window win_brow
			Report Form (m.repfile) To Print Prompt Noconsole

		Endif

		Select(m.d_money)

		Select det_coin
		Use
		Erase (m.co_cdx)
***********
	Endif
Case Upper(Alltrim(dests.Type)) = "CBA"
	Go Top
	m.tfile =  Getfile('TXT', 'Please specify the file name', 'Select',0)

	Wait Window 'CBA' Timeout 30

	If !Empty(m.tfile)

		pnhandle = Fcreate(m.tfile)

		m.lyear = m.year &&YEAR(DATE())
		m.lmonth = m.month &&MONTH(DATE())
		m.lday = Day(Date())

***Header

		m.sc_code = compcode
		m.lastfile = Select()

		Select (m.d_p9paras)
		Set Order To Tag para_des Of (m.i_p9paras)
		Seek 'PAYABLE'
		m.para = para_code

		Select (m.d_params)
		Set Order To Tag para_code Of (m.i_params)
		Seek m.para

		m.p_field = Alltrim(p_s_name)

		Select (m.d_comp_fil)
		m.corder = Order()

		Set Order To Tag compcode  Of (m.i_comp_fil)
		Seek m.sc_code

		m.send = m.cbacode &&comp_fil.sendcode

		If !Empty(m.corder)
			Set Order To &corder
		Else
			Set Order To
		Endif

		Select (m.lastfile)


		m.hrectype = 'UHL'
		m.ldate = Transform(m.lyear,'9999')+Transform(m.lmonth,'@L 99')+Transform(m.lday,'99')

		m.rec = 'CBA  '
		m.serial = '000008'
		m.workcode = 'DIRECT PAYMENTS'
		m.version = '000.001'
		m.hfiller = '000000000000000000000000000000000000000000000000000'

		Set Console Off

		m.header = m.hrectype+m.ldate+m.send+m.rec+m.serial+m.workcode+m.version+m.hfiller

		=Fputs(pnhandle,m.header)
***Salary record
		m.srectype = 'PAY'
		m.pfiller = '00000000000000000000000000'

		m.ecount = 0
		m.totcr = 0

		Do While !Eof()
*						If !noeft
			pamt = &p_field
			m.ebank1 = Left(sort_code,2)
			m.ebank2 = Substr(sort_code,3)
			m.ebank = m.ebank1+'-'+m.ebank2

*m.ebankac = ALLTRIM(cl(empacc_no))

			m.ebankac = Alltrim(cl(s_bankacc))
			m.ebankac = Padl(m.ebankac, 15,'0')

			Wait Window m.details Timeout 30
*m.empname = ALLTRIM(onames)+' '+ALLTRIM(surname)+SPACE(30)

			m.empname = Alltrim(s_accname)+Space(30)
			m.empname = Left(m.empname,35)

			m.amount = Transform(pamt*100,'@L 99999999999999')
			m.totcr = m.totcr+pamt
			m.ecount = m.ecount+1
			m.indicator = '1'
			m.details = m.srectype+m.ebank+m.ebankac+m.empname+m.amount+m.indicator+m.pfiller
			Wait Window m.details Timeout 30

			=Fputs(pnhandle,m.details)
*						Endif
			Skip
		Enddo

***Trailer
		m.trectype = 'UTL'
		m.damttot = Transform(0,'@L 99999999999999')
		m.camttot = Transform(m.totcr*100,'@L 99999999999999')
		m.totaldr = Transform(0,'@L 999999')
		m.totalcr = Transform(m.ecount,'@L 999999')
		m.tfiller = '000000000000000000000000000000000000000000000000000000000'
		m.trailer = m.trectype+m.damttot+m.camttot+m.totaldr+m.totalcr+m.tfiller

		=Fputs(pnhandle,m.trailer)

		Fsize = Fseek(pnhandle,0,2)
		If Fclose(pnhandle)
			?? Chr(7)
			m.mess = "The EFT format file has been saved as "+Chr(13)+m.tfile
			Modify File (m.tfile) Noedit
		Endif
		Set Console On
	Endif

Case Upper(Alltrim(dests.Type)) = "KCB"
	Go Top

	m.tfile =  Getfile('TXT', 'Please specify the file name', 'Select',0)

	If !Empty(m.tfile)

		pnhandle = Fcreate(m.tfile)

		m.lyear = m.year && YEAR(DATE())
		m.lmonth = m.month &&MONTH(DATE())
		m.lday = Day(Date())
***Header

		m.hr_type = '18' &&Record type
		m.f_type = '6' &&file type
		m.clearing = '01'

		m.sc_code = compcode
		m.lastfile = Select()

		Select (m.d_p9paras)
		Set Order To Tag para_des Of (m.i_p9paras)
		Seek 'PAYABLE'
		m.para = para_code

		Select (m.d_params)
		Set Order To Tag para_code Of (m.i_params)
		Seek m.para

		m.p_field = Alltrim(p_s_name)

		Select (m.d_comp_fil)
		m.corder = Order()

		Set Order To Tag compcode  Of (m.i_comp_fil)
		Seek m.sc_code

		m.send = m.cbacode &&comp_fil.sendcode
		m.company = Left(Alltrim(comp_fil.cpname_s)+Space(30),30)

		m.f_serial = Left(comp_fil.fversion+Space(8),8) &&file serial number

		m.origsort = comp_fil.origsort

		m.pref = Left(comp_fil.Pref+Space(15),15)
		m.origref = Left(comp_fil.origref+Space(35),35)

		m.debitacc = Left(Alltrim(comp_fil.cacc_no)+Space(15),15)

		If !Empty(m.corder)
			Set Order To &corder
		Else
			Set Order To
		Endif

		Select (m.lastfile)

		m.ldate = Transform(m.lday,'99')+Transform(m.lmonth,'@L 99')+Transform(m.lyear,'9999')
		m.hfiller = Replicate('0',101)

		Set Console Off
		m.clearing = '01'

		m.header = m.hr_type+m.f_type+m.ldate+m.clearing+'000000'+m.f_serial+m.company+m.hfiller

		=Fputs(pnhandle,m.header)

***Salary record

		m.srectype = '00'
		m.vtype = '58'

		m.ecount = 0
		m.totcr = 0


		Do While !Eof()
			If !noeft
				pamt = &p_field
				m.ebank = Left(Alltrim(sort_code)+Space(5),5)
				m.ebankac = Alltrim(cl(empacc_no))
				m.ebankac = Padl(m.ebankac, 15,'0')
				m.empname = Alltrim(onames)+' '+Alltrim(surname)+Space(35)
				m.empname = Left(m.empname,35)
				m.amount = Transform(pamt*100,'@L 9999999999999')
				m.totcr = m.totcr+pamt
				m.ecount = m.ecount+1
				m.details = m.srectype+m.vtype+m.amount+Replicate('0',1)+m.origsort+m.debitacc+m.ebank+m.ebankac+m.origsort+m.pref+m.empname+m.origref+Replicate('0',10)
				=Fputs(pnhandle,m.details)
			Endif

			Skip

		Enddo

***Trailer
		m.trectype = '19'

		m.camttot = Transform(m.totcr*100,'@L 99999999999999')
		m.totalcr = Transform(m.ecount,'@L 99999')
		m.trailer = m.trectype+m.clearing+Replicate('0',6)+m.totalcr+m.camttot+Replicate('0',129)

		=Fputs(pnhandle,m.trailer)

		Fsize = Fseek(pnhandle,0,2)
		If Fclose(pnhandle)
			?? Chr(7)
			m.mess = "The EFT format file has been saved as "+Chr(13)+m.tfile
			Modify File (m.tfile) Noedit
		Endif
		Set Console On
	Endif
*********
Case Upper(Alltrim(dests.Type)) = "SCB"
	Go Top
	m.tfile =  Getfile('TXT', 'Please specify the file name', 'Select',0)

	If !Empty(m.tfile)
		pnhandle = Fcreate(m.tfile)

		m.tlyear = Alltrim(Str(Year(Date())))
		m.tlyear = Right(m.tlyear,2)

		m.tlmonth = Month(Date())
		m.tlday = Day(Date())


*********
		m.sc_code = compcode
		m.lastfile = Select()

		Select (m.d_p9paras)
		Set Order To Tag para_des Of (m.i_p9paras)
		Seek 'PAYABLE'
		m.para = para_code

		Select (m.d_params)
		Set Order To Tag para_code Of (m.i_params)
		Seek m.para

		m.p_field = Alltrim(p_s_name)

		Select (m.d_comp_fil)
		m.corder = Order()

		Set Order To Tag compcode  Of (m.i_comp_fil)
		Seek m.sc_code

		m.send = comp_fil.sendcode

		If !Empty(m.corder)
			Set Order To &corder
		Else
			Set Order To
		Endif

		Select (m.lastfile)

*************

***Header
		m.hrectype = 'UHL'


		m.ldate = m.tlyear+Iif(m.tlmonth < 10,'0','')+Alltrim(Str(m.tlmonth))+Iif(m.tlday < 10,'0','')+Alltrim(Str(m.tlday))

		m.send = comp_fil.sendcode
		m.rec = comp_fil.rec_code
		m.origsort = comp_fil.origsort

		m.serial = Transform(comp_fil.fserial,'@L 999999')

		m.workcode = 'DIRECTPAYMENTS'

		m.version = comp_fil.fversion

		m.hfiller = '000000000000000000000000000000000000000000000000000'

		m.header = m.hrectype+m.ldate+m.send+m.rec+m.serial+m.workcode+m.version

		=Fputs(pnhandle,m.header)

***Salary record

		m.srectype = 'PAY'
		m.pfiller = '00000000000000000000000000'

		m.desttype = '1'
		m.transtype = '51'

*m.origsort = m.rec
		m.origacc = Left(comp_fil.cacc_no+Space(15),13)

		m.origacctype = '1'
		m.ecount = 0
		m.totcr = 0
		m.paydate = m.ldate
		m.errorcode = '00'

		Do While !Eof()
			If !noeft
				pamt = &p_field
				m.ref = Left(Alltrim(comp_fil.cref)+Space(15),15)
				m.ebank = sort_code
				m.ebankac = Alltrim(cl(empacc_no))
				m.ebankac = Padr(m.ebankac, 13,' ')
				m.empname = Alltrim(onames)+' '+Alltrim(surname)+Space(30)
				m.empname = Left(m.empname,30)
				m.amount = Transform(pamt*100,'@L 999999999999')
				m.totcr = m.totcr+pamt
				m.ecount = m.ecount+1
				m.indicator = '1'
				m.details = m.srectype+m.ebank+m.ebankac+m.desttype+m.transtype+m.origsort+m.origacc+m.origacctype+m.ref+m.empname+m.amount+m.ldate+m.errorcode
				=Fputs(pnhandle,m.details)
			Endif
			Skip
		Enddo

****Contra

		m.ebank = m.origsort

		m.ebankac = m.origacc

		m.transtype = '49'

		m.ref = Left('CONTRA '+Space(15),15)

		m.empname = Alltrim(comp_fil.cpname_l)+Space(30)

		m.empname = Left(m.empname,30)

		m.amount = Transform(m.totcr*100,'@L 999999999999')

		m.indicator = '1'

		m.details = m.srectype+m.ebank+m.ebankac+m.desttype+m.transtype+m.origsort+m.origacc+m.origacctype+m.ref+m.empname+m.amount+m.ldate+m.errorcode

		=Fputs(pnhandle,m.details)

***Trailer
		m.trectype = 'UTL'

		m.damttot = Transform(m.totcr*100,'@L 99999999999999')
		m.camttot = Transform(m.totcr*100,'@L 99999999999999')

		m.totaldr = Transform(1,'@L 999999')
		m.totalcr = Transform(m.ecount,'@L 999999')

		m.tfiller = ''
		m.trailer = m.trectype+m.damttot+m.camttot+m.totaldr+m.totalcr


		=Fputs(pnhandle,m.trailer)
		Fsize = Fseek(pnhandle,0,2)

		If Fclose(pnhandle)
			?? Chr(7)
			m.mess = "The EFT format file has been saved as "+Chr(13)+m.tfile
			Modify File (m.tfile) Noedit
		Endif
	Endif

*********

Case Upper(Alltrim(dests.Type)) = "SFI"

	m.newfile = Alltrim(Getfile(m.des_ext,'','',0))

	If !Empty(m.newfile)
		Go Top

*********
		m.sc_code = compcode
		m.lastfile = Select()

		Select (m.d_p9paras)
		Set Order To Tag para_des Of (m.i_p9paras)
		Seek 'PAYABLE'
		m.para = para_code

		Select (m.d_params)
		Set Order To Tag para_code Of (m.i_params)
		Seek m.para

		m.p_field = Alltrim(p_s_name)

		Select (m.d_comp_fil)
		m.corder = Order()

		Set Order To Tag compcode  Of (m.i_comp_fil)
		Seek m.sc_code

		m.send = comp_fil.sendcode

		If !Empty(m.corder)
			Set Order To &corder
		Else
			Set Order To
		Endif

		Select (m.lastfile)

*******
		pnhandle = Fcreate(m.newfile)

		m.namt = 0
		m.oamt = 0
		m.tamt = 0

		Do While !Eof()
			If !noeft
				pamt = &p_field
				=Fputs(pnhandle,tstr(oldempcode)+Left(Alltrim(surname)+','+Alltrim(onames)+Space(50),50)+Left(Alltrim(sort_code)+Space(5),5)+Left(cl(empacc_no),13)+Transform(pamt,"9,999,999.99"))
				m.namt = m.namt+pamt
			Else
				m.oamt = m.oamt+pamt
			Endif
			Skip
		Enddo
		m.tamt = m.oamt+m.namt

		Fsize = Fseek(pnhandle,0,2)

		If Fclose(pnhandle)
			?? Chr(7)
			m.mess = "The EFT format file has been saved as "+Chr(13)+m.newfile
			Modify File (m.newfile) Noedit
		Endif

		Set Console On

		m.trepfile = m.datapath+"bktot.FRX"


		If File(m.trepfile)
			Report Form (m.trepfile) Preview &&TO PRINT PROMPT NOCONSOLE
			Report Form (m.trepfile) To Print Prompt Noconsole
		Endif

	Endif

Case Upper(Alltrim(dests.Type)) = "COOP"

	m.newfile = Alltrim(Getfile(m.des_ext,'','',0))

	If !Empty(m.newfile)
		Go Top

*********
		m.sc_code = compcode
		m.lastfile = Select()

		Select (m.d_p9paras)
		Set Order To Tag para_des Of (m.i_p9paras)
		Seek 'PAYABLE'
		m.para = para_code

		Select (m.d_params)
		Set Order To Tag para_code Of (m.i_params)
		Seek m.para

		m.p_field = Alltrim(p_s_name)

		Select (m.d_comp_fil)
		m.corder = Order()

		Set Order To Tag compcode  Of (m.i_comp_fil)
		Seek m.sc_code

		m.send = comp_fil.sendcode

		If !Empty(m.corder)
			Set Order To &corder
		Else
			Set Order To
		Endif

		Select (m.lastfile)

*******
		pnhandle = Fcreate(m.newfile)

		m.namt = 0
		m.oamt = 0
		m.tamt = 0

		Do While !Eof()
			If !noeft
				pamt = &p_field
				pamt = pamt*100
				=Fputs(pnhandle,Left(Alltrim(sort_code)+Space(5),5)+'     '+Left(cl(empacc_no),13)+'  '+Left(Alltrim(onames)+' '+Alltrim(surname)+Space(50),50)+Transform(pamt,"999999999"))
				m.namt = m.namt+pamt
			Else
				m.oamt = m.oamt+pamt
			Endif
			Skip
		Enddo
		m.tamt = m.oamt+m.namt
		Fsize = Fseek(pnhandle,0,2)
		If Fclose(pnhandle)
			?? Chr(7)
			m.mess = "The EFT format file has been saved as "+Chr(13)+m.newfile
			Modify File (m.newfile) Noedit
		Endif
		Set Console On
	Endif


Case Upper(Alltrim(dests.Type)) = "SUN"
	m.alias = Alias()
	Select (m.alias)

	Create Cursor tformat (acccode C(10),tdate D(10),tref C(40),tdescri C(120),;
		tcurr C(10),tamount N(12,2),tscode C(6),gline C(5),pcode C(5),eloc C(4),;
		officec C(4),sitecode C(3),personc C(5))


	Select params

	Set Filter To !Empty(acc_code)
	Go Top
	Do While  !Eof()
		m.acccode = Alltrim(acc_code)
		m.ofields = Alltrim(m.alias)+'.'+Alltrim(p_s_name)

		Select (m.alias)
		Go Top
		Do While !Eof()
			m.cost_sname = Alltrim(cost_sname)
			m.tdate = Date()
			m.dd = Ctod(Alltrim(Str(monthd()))+'/'+Alltrim(Str(m.month))+'/'+Alltrim(Str(m.year)))
			m.tdate = m.dd
			m.tref = Left(Alltrim(Cmonth(m.dd)),3)+" "+Alltrim(Str(m.year))+" PAY"
			m.tdescri = Alltrim(surname)+' '+Alltrim(onames)
			m.tcurr = 'KSH'
			m.tamount = &ofields

			If Alltrim(params.p_s_name) = 'GROSS'
				m.tamount = m.tamount+nssf

			Else
				m.tamount = 0-m.tamount
				If Alltrim(params.p_s_name) = 'NSSF'
					m.tamount = m.tamount*2
				Endif
			Endif


			m.cost_sname = Alltrim(m.cost_sname)

			m.tscode = Left(m.cost_sname,5)
			m.cost_sname = Alltrim(Substr(m.cost_sname,6))

			m.gline = Alltrim(Left(m.cost_sname,4))
			m.cost_sname = Substr(m.cost_sname,5)

			m.pcode = Alltrim(Left(m.cost_sname,5))
			m.cost_sname = Substr(m.cost_sname,6)

			m.eloc = Alltrim(Left(m.cost_sname,4))
			m.cost_sname = Substr(m.cost_sname,5)

			m.officec = Alltrim(Left(m.cost_sname,4))
			m.cost_sname = Substr(m.cost_sname,5)

			m.sitecode = m.cost_sname
			m.personc = Alltrim(oldempcode)

			If m.tamount <> 0
				Select tformat
				Append Blank
				Gather Memvar
			Endif

			Select (m.alias)
			Skip
		Enddo

		Select params
		Skip
	Enddo

	Select params
	Set Filter To

	Select tformat
	Go Top

	m.newfile = Alltrim(Getfile('XLS','','',0))
	If !Empty(m.newfile)
		Copy To (newfile) Type Xls
	Endif
Case Upper(Alltrim(dests.Type)) = "XSUN"
	m.jvno = 0
	m.tdesc = Space(30)
	m.yypp = '9911'
	m.date = Space(8)
	m.bl_1 = Space(2)
	m.rec_type = 'E'
	m.sunbus = Space(2)
	m.jour_no = Space(5)
	m.jour_line = Space(5)
	m.bl_2 = Space(2)
	m.d_c_ind = Space(1)
	m.allocid = Space(1)
	m.jour_type = 'JV'
	m.jour_src = Space(5)
	m.ref = Space(15)
	m.dte_entry = Date()
	m.prd_entry = Space(7)
	m.due_date = Space(8)
	m.pay_ref = Space(15)
	m.pay_date = Date()
	m.pay_per = Space(7)
	m.asst_ind =Space(1)
	m.asst_cod = Space(10)
	m.asst_sub = Space(5)
	m.curr_code = 'KSHS'
*m.curr_rate = 0
	m.oth_del = Space(1)
	m.id_enter = Space(3)
	m.id_post = Space(3)
	m.id_amend = Space(3)
	m.reversal = .F.
	m.text = Space(18)
	m.bl_4 = Space(10)
	m.anly_ctg3 = Space(5)
	m.anly_ctg4 = Space(5)
	m.anly_ctg5 = Space(5)
	m.bl_3 = Space(100)
	m.up_bal = Space(8)


	If Used('JV')
		m.newfile = Alltrim(Getfile('DBF','','',0))
		If !Empty(m.newfile)
			m.ref = 'JV '+Alltrim(Str(m.jvno))

			Select (m.d_sun)
			Copy To (m.newfile)

			Select 0
			Use (m.newfile) Shared

			m.talias = Alias()

			Select jv
			Go Top

			Do While !Eof()
*m.amount = ((jv.dr+jv.cr)/m.curr_rate)*1000
				m.oth_amt = (jv.dr+jv.cr)*1000

				If jv.dr > 0
					m.d_c_ind = 'D'
					If Empty(m.tdesc)
						m.desc = Alltrim(jv.p_l_name)
					Else
						m.desc = m.tdesc
					Endif
				Else
					m.d_c_ind = 'C'
					m.desc = Alltrim(jv.p_l_name)
				Endif


				m.anly_ctg1 = Alltrim(jv.cost_sname)
				m.anly_ctg2 = Alltrim(jv.grant)
				m.code_sun = jv.acc_code

				Select (m.talias)
				Append Blank
				Gather Memvar
				Select jv
				Skip
			Enddo

			Select (m.talias)
			Browse Window win_brow

			m.newfile = Alltrim(Getfile(m.des_ext,'','',0))

			If !Empty(m.newfile)
				Select (m.talias)
				Go Top
				Copy To (m.newfile) Type Sdf
				Modify Command (m.newfile)
				Select (m.talias)
				Use
			Endif
		Endif
	Endif

Case Upper(Alltrim(dests.Type)) = "STAMPS"
	m.n_20 = 0
	m.n_40 = 0
	m.n_60 = 0
	m.n_80 = 0
	m.n_100 = 0
	m.n_120 = 0
	m.n_140 = 0
	m.n_160 = 0
	m.n_180 = 0
	m.n_200 = 0

	Calculate Cnt() To m.n_20 For lasc = 20
	Calculate Cnt() To m.n_40 For lasc = 40
	Calculate Cnt() To m.n_60 For lasc = 60
	Calculate Cnt() To m.n_80 For lasc = 80
	Calculate Cnt() To m.n_100 For lasc = 100
	Calculate Cnt() To m.n_120 For lasc = 120
	Calculate Cnt() To m.n_140 For lasc = 140
	Calculate Cnt() To m.n_160 For lasc = 160
	Calculate Cnt() To m.n_180 For lasc = 180
	Calculate Cnt() To m.n_200 For lasc = 200

	Create Cursor c_lasc (bank_name C(30))

	Select c_lasc
	Append Blank
	Go Top

	m.lrepfile = m.datapath+"c_lasc.FRX"
	Report Form (m.lrepfile) Preview
	Report Form (m.lrepfile) To Printer Prompt Noconsole
***********
Case dests.External
	m.newfile = Alltrim(Getfile(m.des_ext,'','',0))
	If !Empty(m.newfile)
		If m.typi =  "DBF"
			Copy To (newfile)
		Else
			Copy To (newfile) Type &typi
		Endif
	Endif
Case !Empty(dests.Delimited)
	m.newfile = Alltrim(Getfile('txt','','',0))
	If !Empty(m.newfile)
		Copy To (m.newfile) Type Delimited With &Deli
		Modify Command (m.newfile)
	Endif

Endcase
Select (m.majfile)

Return

Function cl
Parameters clval
m.clval = Strtran(m.clval,".")
m.clval = Strtran(m.clval,"\")
m.clval = Strtran(m.clval,"/")
m.clval = Strtran(m.clval,"-")
m.clval = Strtran(m.clval," ")
m.clval = Strtran(m.clval,",")
m.clval = Strtran(m.clval,".")

Return m.clval+Space(10)

Function tstr
Parameter e_code
m.e_code = Val(e_code)
m.se_code = ""
m.zeros = ""
Do Case
Case m.e_code < 10
	m.zeros = "0000"
Case m.e_code => 10  And m.e_code < 100
	m.zeros = "000"
Case m.e_code => 100 And m.e_code < 1000
	m.zeros = "00"
Case m.e_code => 1000 And m.e_code < 10000
	m.zeros = "0"
Endcase
m.se_code = m.zeros+Alltrim(Str(m.e_code))
Return m.se_code

Function getcover
Parameters tpara
m.tpara = tpara
m.rect = Recno()
Sum &tpara To m.tval
Goto m.rect
Return m.tval

********Scope

Procedure actpop
Set Border To None
Do defemp_p
Do defdept_p
Do defpay_p

Define Popup actpop;
	IN scope;
	FROM 10.077,2.800;
	TO 19.231,25.200 ;
	MARGIN;
	COLOR ,Rgb(0,0,255,192,192,192)
Define Bar 1 Of actpop Prompt 'All'
Define Bar 2 Of actpop Prompt 'Payroll'
Define Bar 3 Of actpop Prompt 'Department'
Define Bar 4 Of actpop Prompt 'Employee '
On Selection Popup actpop Do shoact
Activate Popup actpop Nowait
Set Border To Single
Return

Procedure shoact
m.exeto = Bar()
Deactivate Popup paypop
Deactivate Popup deptpop
Deactivate Popup emppop
Do Case
Case m.exeto = 1
Case m.exeto = 2
	Activate Popup paypop Nowait
Case m.exeto = 3
	Activate Popup deptpop Nowait
Case m.exeto = 4
	Activate Popup emppop Nowait
Endcase
Return

Function defdept_p &&POPUP
If opendbf(m.d_depts)
	Select (m.d_depts)
	Set Order To Tag deptname_l Of (m.i_depts)

	Deactivate Popup deptpop
	Define Popup deptpop;
		IN scope;
		FROM 5.538,26.400;
		TO 22.538,85.800;
		TITLE 'Department';
		MARGIN;
		SCROLL;
		MULTISELECT;
		COLOR ,Rgb(0,0,255,255,255,255)

	Go Top
	m.count = 1
	Do While !Eof()
		Define Bar m.count Of deptpop Prompt depts.deptname_l+Space(100)+'('+Alltrim(Str(deptcode))+')'
		Skip
		m.count = m.count+1
	Enddo
*ON SELECTION POPUP deptpop DO showdept
	Return .T.
Else
	Return .F.
Endif

Function defemp_p &&POPUP
If opendbf(m.d_emp)
	Select (m.d_emp)
	m.empord = Order()
	Set Order To Tag surname Of (m.i_emp)

	Deactivate Popup emppop

	Define Popup emppop;
		IN scope;
		FROM 5.538,26.400;
		TO 22.538,85.800;
		TITLE 'Employees';
		MARGIN;
		SCROLL;
		MULTISELECT;
		COLOR ,Rgb(0,0,255,255,255,255)

	m.tpos = empcode
	Go Top

	m.count = 1
	Do While !Eof()
		Define Bar m.count Of emppop Prompt Alltrim(empdata.surname)+","+empdata.onames+Space(100)+'('+Alltrim(Str(empcode))+')'
		Skip
		m.count = m.count+1
	Enddo

*ON SELECTION POPUP emppop DO showemp

	Set Order To Tag empcode Of (m.i_emp)
	Seek m.tpos
	Set Order To
	Return .T.
Else
	Return .F.
Endif

Function defpay_p &&POPUP
If opendbf(m.d_comp_fil)
	Select (m.d_comp_fil)
	Deactivate Popup paypop
	Define Popup paypop;
		IN scope;
		FROM 5.538,26.400;
		TO 22.538,85.800;
		TITLE 'Payroll';
		MARGIN;
		SCROLL;
		MULTISELECT;
		COLOR ,Rgb(0,0,255,255,255,255)
	Go Top
	m.count = 1

	Do While !Eof()
		Define Bar m.count Of paypop Prompt comp_fil.p_name+'('+Alltrim(Str(compcode))+')'
		Skip
		m.count = m.count+1
	Enddo
*ON SELECTION POPUP paypop DO showpay
	Return .T.
Else
	Return .F.
Endif


Function showpay
Return

Function showdept
Return

Function showemp
Return


Function relpop2 &&Release popups
Return


Procedure p_sel
*PRMBAR(<expC>, <expN>)  &&Get the text so that you can identify the selection
*MRKBAR(<expC>, <expN>)  &&determine the bars that are marked
*CNTBAR([<expC>]) &&Gets the total number of bars

*paypop  &&Payroll popup
*deptpop &&Dept popup
*emppop  &&emp popup
Select (m.d_emp)
Do Case
Case m.exeto = 1  &&All
	Go Top
	Do While !Eof()
		If !m.annual And !Empty(end_date) And ((Month(end_date) < m.month And Year(end_date) <= m.year) Or Year(end_date) < m.year )

		Else
			Do c_record
		Endif

		Select (m.d_emp)
		Skip
	Enddo
Case m.exeto = 2  &&Payroll
	Set Order To Tag compcode Of (m.i_emp)
	m.totbars = Cntbar('paypop')
	m.barno = 1
	Do While m.barno <= m.totbars
		If Mrkbar('paypop',m.barno)

			m.thistext = Alltrim(Prmbar('paypop',m.barno))  &&Get the text so that you can identify the selection
			m.f_c_pos = At('(',m.thistext)
			m.shortstr = Alltrim(Substr(m.thistext,m.f_c_pos+1))
			m.l_c_pos = At(')',m.shortstr)
			m.f_str = Left(m.shortstr,m.l_c_pos-1)
			m.thiscode = Val(m.f_str)
			Seek m.thiscode

			Do While compcode = m.thiscode And !Eof()
				If !m.annual And !Empty(end_date) And ((Month(end_date) < m.month And Year(end_date) <= m.year) Or Year(end_date) < m.year )

				Else
					Do c_record
				Endif

				Select (m.d_emp)
				Skip
			Enddo
		Endif
		m.barno = m.barno+1
	Enddo

Case m.exeto = 3  &&Department
	Set Order To Tag deptcode Of  (m.i_emp)
	m.totbars = Cntbar('deptpop')

	m.barno = 1
	Do While m.barno <= m.totbars
		If Mrkbar('deptpop',m.barno)
			Set Order To Tag deptcode Of  (m.i_emp)
			m.thistext = Alltrim(Prmbar('deptpop',m.barno))  &&Get the text so that you can identify the selection
			m.f_c_pos = At('(',m.thistext)
			m.shortstr = Alltrim(Substr(m.thistext,m.f_c_pos+1))
			m.l_c_pos = At(')',m.shortstr)
			m.f_str = Left(m.shortstr,m.l_c_pos-1)
			m.thiscode = Val(m.f_str)

			Seek m.thiscode
			Do While deptcode = m.thiscode And !Eof()
				Do c_record

				Select (m.d_emp)
				Skip
			Enddo
		Endif
		m.barno = m.barno+1
	Enddo
Case m.exeto = 4  &&Employee
	Set Order To Tag empcode Of (m.i_emp)
	m.totbars = Cntbar('emppop')
	m.barno = 1
	Do While m.barno <= m.totbars
		If Mrkbar('emppop',m.barno)
			Set Order To Tag empcode Of (m.i_emp)
			m.thistext = Alltrim(Prmbar('emppop',m.barno))  &&Get the text so that you can identify the selection
			m.f_c_pos = At('(',m.thistext)
			m.shortstr = Alltrim(Substr(m.thistext,m.f_c_pos+1))
			m.l_c_pos = At(')',m.shortstr)
			m.f_str = Left(m.shortstr,m.l_c_pos-1)
			m.thiscode = Val(m.f_str)
			Select (m.d_emp)
			Seek m.thiscode
**Create record
			Do c_record
		Endif
		m.barno = m.barno+1
	Enddo
Endcase

Select t_params

Return

Procedure c_record
m.direction = 1
Select (m.d_emp)
Scatter Memvar Memo
If !m.annual
	If !Empty(end_date) And ((Month(end_date) < m.month And Year(end_date) = m.year) Or Year(end_date) < m.year)

	Else
		Do getthem
	Endif
Else
	If Year(join_date) > m.year Or (!Empty(end_date) And Year(end_date) < m.year)

	Else
		Do getthem
	Endif
Endif
Select (m.d_emp)
Return

***********
*******end scope

Procedure annualize
Create Cursor taxdiff (empcode N(5),names C(40),cumtaxab N(12,2),cumtax N(12,2),atax N(12,2),;
	tdiff N(12,2),taxperiod N(5),monthav N(12,2))

Select (m.d_emp)
Go Top

Do While !Eof()
	m.empcode = empcode
	m.names = Alltrim(onames)+' '+Alltrim(surname)
	m.taxable = 0
	m.paye = 0
	m.taxperiod = 0

	m.tmonth = 1

	Do While m.tmonth <= 12
		m.d_d_dat = "D_"+Alltrim(Str(m.tmonth))+Alltrim(Str(m.year)) &&salary details table

		m.i_s_dat = m.datapath+m.d_s_dat+".CDX"
		m.i_d_dat = m.datapath+m.d_d_dat+".CDX"

		If opendbf(m.d_d_dat)

			Select (m.d_d_dat)
			Set Order To Tag poscombi Of (m.i_d_dat)

			m.para_code = 12 &&Taxable

			m.poscombi = "["+Alltrim(Str(m.para_code))+"/"+Alltrim(Str(m.empcode))+"]"

			Seek m.poscombi

			If Found()
				If d_amt > 0
					m.taxperiod = m.taxperiod+1
					m.taxable = m.taxable+d_amt
				Endif
			Endif

			m.para_code = 5 &&Taxable

			m.poscombi = "["+Alltrim(Str(m.para_code))+"/"+Alltrim(Str(m.empcode))+"]"
			Seek m.poscombi

			If Found()
				If d_amt > 0
					m.paye = m.paye+d_amt
				Endif
			Endif
		Endif

		m.tmonth = m.tmonth+1

	Enddo

	If m.taxable > 0
		Select taxdiff
		Append Blank

		Replace empcode With m.empcode
		Replace taxperiod With m.taxperiod
		Replace cumtaxab With m.taxable
		Replace cumtax With m.paye
		Replace names With m.names
**Calculate tax
		m.monthav = Round(m.taxable/m.taxperiod,2)
		m.mtax = calctax(m.monthav)-1056
		m.atax = m.mtax*m.taxperiod
		m.tdiff = m.atax-m.paye

		Select taxdiff

		Replace monthav With m.monthav
		Replace atax With m.atax
		Replace tdiff With m.tdiff
	Endif
	Select (m.d_emp)
	Skip
Enddo
Select taxdiff
Return



Procedure setnhif
m.tz_cdx = m.tmppath+"tz"+Left(Sys(3),6)+".cdx" &&Index for the temporary file

Select (m.d_f_list)
Set Order To Tag f_code Of (m.i_f_list)

**NHIF returns

Create Cursor nhif (nhifno C(20),surname C(30),onames C(50),;
	s_idno C(12),empcode N(4),s_sno N(4),s_sval N(12,2),;
	s_surname C(30),s_other C(50),spouseid C(30),oldempcode C(20))

Index On nhifno Tag nhifno Of (m.tz_cdx) Ascending
Index On empcode Tag empcode Of (m.tz_cdx) Ascending

s_date = Ctod('01/07/'+Alltrim(Str(m.year-1)))
e_date = Ctod('30/06/'+Alltrim(Str(m.year)))

************

Select(m.d_emp)
Go Top
m.thermsize = Reccount()

Do acttherm With "Processing the Query. Please wait. Hit END to cancel"
m.tcount = 0
m.hitit = 0

Do While !Eof() And m.hitit <> 6
	m.hitit = Inkey()

	If m.hitit = 6
		?? Chr(7)
		m.mess = "Are you sure you want to cancel the processing(Y/N)?"
		If m.ans <> 6
			m.hitit = 0
		Else
			@ Row(),Col()-20 Say 'Stopping...'
			Exit
		Endif
	Endif

	Select(m.d_emp)

	m.tcount = m.tcount+1
	m.thermpos = m.tcount
	m.thislen = (m.thermpos/m.thermsize)*100
	=updtherm(m.thislen)

	If (end_date < s_date And !Empty(end_date)) Or (join_date > e_date And !Empty(join_date))
		Skip
		Loop
	Endif

	m.surname = Upper(Alltrim(surname))
	m.onames = Upper(Alltrim(onames))
	m.empcode = empcode
	m.oldempcode = Alltrim(oldempcode)

*m.s_surname = UPPER(ALLTRIM(s_surname))
*m.s_other = UPPER(ALLTRIM(s_other))
*m.spouseid = UPPER(ALLTRIM(spouseid))

	m.nhifno = Space(20)
	m.s_sno = 0
	m.s_sval = 0

	m.nocombo = Alltrim(Str(empdata.empcode))+"/"+Alltrim(Str(6))+"/"
	Select(m.d_novalues)
	Set Order To Tag nocombo Of (m.i_novalues)
	Seek m.nocombo
	If Found()
		m.nhifno = Alltrim(novalue)
	Endif

	m.s_idno = Space(10)
	m.nocombo = Alltrim(Str(empdata.empcode))+"/"+Alltrim(Str(3))+"/"
	Select(m.d_novalues)
	Set Order To Tag nocombo Of (m.i_novalues)
	Seek m.nocombo
	If Found()
		m.s_idno = Alltrim(novalue)
	Endif

	m.nhifcheck = Space(1)
	m.nocombo = Alltrim(Str(empdata.empcode))+"/"+Alltrim(Str(11))+"/"
	Select(m.d_novalues)
	Set Order To Tag nocombo Of (m.i_novalues)
	Seek m.nocombo
	If Found()
		m.nhifcheck = Upper(Left(Alltrim(novalue),1))
	Endif


	Select(m.d_emp)
	m.ccount = 1
	m.n_date = s_date

	Do While m.ccount <= 12  &&AND m.nhifcheck = 'Y'
		Select(m.d_emp)
		If (end_date < m.n_date And !Empty(end_date))
			Exit
		Endif

		If  join_date > Gomonth(m.n_date,1) Or Empty(join_date)

		Else
			lposcombi = "["+Alltrim(Str(7))+"/"+Alltrim(Str(empcode))+"]"
			m.n_month = Month(m.n_date)
			m.n_year = Year(m.n_date)

			m.d_d_dat = "D_"+Alltrim(Str(m.n_month))+Alltrim(Str(m.n_year)) &&salary details table

			If opendbf(m.d_d_dat)

				m.isclosed = .T. &&This month has been closed. Use archives-no processing
				m.i_d_dat = m.datapath+m.d_d_dat+".CDX"

				Select (m.d_d_dat)
				Set Order To Tag poscombi Of (m.i_d_dat)
				Seek lposcombi
				m.dd_amt = 0

				Do While "["+Alltrim(Str(7))+"/"+Alltrim(Str(empcode))+"]" = lposcombi And !Eof()
					If !Deleted()
						If m.isclosed
							m.dd_amt = m.dd_amt+d_amt
						Else
							If !Freeze
								m.dd_amt = m.dd_amt+Payment
							Endif
						Endif
					Endif
					Skip
				Enddo

				If  m.dd_amt > 0
					m.s_sno = m.s_sno+1
					m.s_sval = m.s_sval+m.dd_amt
				Endif
			Endif
		Endif

		m.n_date = Gomonth(m.n_date,1)
		m.ccount = m.ccount+1

	Enddo &&MONTHS

	If m.s_sno > 0
		Select nhif
		Append Blank
		Gather Memvar
	Endif

	Select(m.d_emp)
	Skip
Enddo &&EMPLOYEE

Do deactthermo
Select nhif
Set Order To Tag nhifno Of (m.tz_cdx)
Return


Procedure setsum
m.tz_cdx = m.tmppath+"tz"+Left(Sys(3),6)+".cdx" &&Index for the temporary file

Select (m.d_f_list)
Set Order To Tag f_code Of (m.i_f_list)

**payroll annual summary

Create Cursor pay_sum (surname C(30),onames C(50),;
	empcode N(4),s_sno N(4),s_sval N(12,2),oldempcode C(20),;
	TITLE C(50),deptname C(60),c_centre C(30),join_date D(10),;
	end_date D(10),depreason C(100),e_contract D(10),e_status C(20),;
	month1 N(12,2),month2 N(12,2),month3 N(12,2),month4 N(12,2),;
	month5 N(12,2),month6 N(12,2),month7 N(12,2),month8 N(12,2),;
	month9 N(12,2),month10 N(12,2),month11 N(12,2),month12 N(12,2),;
	mtotal N(12,2))


Index On empcode Tag empcode Of (m.tz_cdx) Ascending

s_date = Ctod('01/10/'+Alltrim(Str(m.year-1)))
e_date = Ctod('30/09/'+Alltrim(Str(m.year)))
************

Select(m.d_emp)
Go Top
m.thermsize = Reccount()

Do acttherm With "Processing the Query. Please wait. Hit END to cancel"
m.tcount = 0
m.hitit = 0

Do While !Eof() And m.hitit <> 6
	m.title = Space(50)
	m.deptname = Space(60)
	m.c_centre = Space(30)
	m.e_status= Space(20)
	m.depreason= Space(20)

	m.hitit = Inkey()

	If m.hitit = 6
		?? Chr(7)
		m.mess = "Are you sure you want to cancel the processing(Y/N)?"
		If m.ans <> 6
			m.hitit = 0
		Else
			@ Row(),Col()-20 Say 'Stopping...'
			Exit
		Endif
	Endif

	Select(m.d_emp)
	m.funcno = funcno
	m.deptcode = deptcode
	m.empcode = empcode
	m.join_date = join_date
	m.end_date = end_date
	m.depreason = Alltrim(remarks)

	Select (m.d_function)
	Set Order To funcno
	Seek m.funcno
	If Found()
		m.title = Alltrim(f_name)
	Endif

	Select (m.d_depts)
	Set Order To deptcode
	Seek m.deptcode
	If Found()
		m.deptname = Alltrim(deptname_l)
	Endif

	Select (m.d_ccents)
	Set Order To empcode
	Go Top
	Seek m.empcode
	If Found()
		Do While empcode = m.empcode And !Eof()
			If !Deleted() And percent > 0
				m.c_centre  = Alltrim(cost_lname)
			Endif
			Skip
		Enddo
	Endif

	Select(m.d_emp)

	m.tcount = m.tcount+1
	m.thermpos = m.tcount
	m.thislen = (m.thermpos/m.thermsize)*100
	=updtherm(m.thislen)

	If (end_date < s_date And !Empty(end_date)) Or (join_date > e_date And !Empty(join_date))
		Skip
		Loop
	Endif

	m.surname = Upper(Alltrim(surname))
	m.onames = Upper(Alltrim(onames))
	m.empcode = empcode
	m.oldempcode = Alltrim(oldempcode)

	m.nhifno = Space(20)
	m.s_sno = 0
	m.s_sval = 0

	Select(m.d_emp)
	m.ccount = 1
	m.n_date = s_date
	m.month1 = 0
	m.month2 = 0
	m.month3 = 0
	m.month4 = 0
	m.month5 = 0
	m.month6 = 0
	m.month7 = 0
	m.month8 = 0
	m.month9 = 0
	m.month10 = 0
	m.month11 = 0
	m.month12 = 0
	m.mtotal = 0


	Do While m.ccount <= 12
		Select(m.d_emp)
		If (end_date < m.n_date And !Empty(end_date))
			Exit
		Endif

		If  join_date > Gomonth(m.n_date,1) Or Empty(join_date)

		Else
			lposcombi = "["+Alltrim(Str(3))+"/"+Alltrim(Str(empcode))+"]"
			m.n_month = Month(m.n_date)
			m.n_year = Year(m.n_date)

			m.d_d_dat = "D_"+Alltrim(Str(m.n_month))+Alltrim(Str(m.n_year)) &&salary details table

			If opendbf(m.d_d_dat)
				m.isclosed = .T. &&This month has been closed. Use archives-no processing
				m.i_d_dat = m.datapath+m.d_d_dat+".CDX"

				Select (m.d_d_dat)
				Set Order To Tag poscombi Of (m.i_d_dat)
				Seek lposcombi
				m.dd_amt = 0

				Do While "["+Alltrim(Str(3))+"/"+Alltrim(Str(empcode))+"]" = lposcombi And !Eof()
					If !Deleted()
						If m.isclosed
							m.dd_amt = m.dd_amt+d_amt
						Else
							If !Freeze
								m.dd_amt = m.dd_amt+Payment
							Endif
						Endif
					Endif
					Skip
				Enddo

				Do Case
				Case m.ccount = 1
					m.month1 = m.dd_amt
				Case m.ccount = 2
					m.month2 = m.dd_amt
				Case m.ccount = 3
					m.month3 = m.dd_amt
				Case m.ccount = 4
					m.month4 = m.dd_amt
				Case m.ccount = 5
					m.month5 = m.dd_amt
				Case m.ccount = 6
					m.month6 = m.dd_amt
				Case m.ccount = 7
					m.month7 = m.dd_amt
				Case m.ccount = 8
					m.month8 = m.dd_amt
				Case m.ccount = 9
					m.month9 = m.dd_amt
				Case m.ccount = 10
					m.month10 = m.dd_amt
				Case m.ccount = 11
					m.month11 = m.dd_amt
				Case m.ccount = 12
					m.month12 = m.dd_amt
				Endcase

				If  m.dd_amt > 0
					m.s_sno = m.s_sno+1
					m.s_sval = m.s_sval+m.dd_amt
				Endif
			Endif
		Endif

		m.n_date = Gomonth(m.n_date,1)
		m.ccount = m.ccount+1
	Enddo &&MONTHS

	m.mtotal = m.s_sval
	If m.s_sno > 0
		Select pay_sum
		Append Blank
		Gather Memvar
	Endif

	Select(m.d_emp)
	Skip
Enddo &&EMPLOYEE

Do deactthermo
Select pay_sum
Return



Function opendbf
Parameters lname
l_openedok = .F.
If !Empty(lname)
	llname = Alltrim(lname)
	If !Used(lname)
	Endif
	nsqlstring = "select * from "+llname
	lretval=SQLExec(nConnectionHandle,nsqlstring,"llname ")
	If lretval = 1
		l_openedok = .F.
	Endif
Endif
Return l_openedok


Function defcurr_p
If opendbf('currency')
	Select Currency
	Go Top
	Deactivate Popup ratepop

	Define Popup ratepop;
		FROM 5,0.800 ;
		TO 12,43;
		PROMPT Field  Alltrim(Currency.curr_lname) + " (" + Alltrim(Currency.curr_sname) + ")";
		MARGIN;
		SCROLL;
		MESSAGE "Select the currency you need to view . Click to select";
		COLOR ,Rgb(0,128,128,255,255,255)
	m.count = 0
	On Selection Popup ratepop Deactivate Popup ratepop
	Return .T.
Else
	Return .F.
Endif

Function getthem

Return

Function closedbfs


Return

Function p_dialog


Return

Function Filter


Return

Function dialogbox

Return

*Function monthd

*	Return

*****************************

Function gbasic &&get the basic pay
Parameters e_val
m.ycount = t_params.startpay
Return m.ycount


Function ggrade &&get the grade
Parameters e_val
m.ycount = 0

If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif

m.oldalias = Alias()

Select staff
Go Top
Locate For staffno = m.staffno

If Found()
	m.gradeid = staff.gradeid
	Select v_grades
	Go Top
	Locate For gradeid = m.gradeid
	If Found()
		m.ycount = Val(Alltrim(grade))
	Endif
Endif
Select (m.oldalias)
Return m.ycount

Function gcgrade &&get the grade
Parameters e_val
m.ycount = 0
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.gradeid = staff.gradeid
	Select v_grades
	Go Top
	Locate For gradeid = m.gradeid
	If Found()
		m.ycount = Alltrim(v_grades.grade)
	Endif
Endif
Select (m.oldalias)
Return m.ycount

Function gdgrade &&get the grade
Parameters e_val
m.ycount = 0
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.gradeid = staff.gradeid
	Select v_grades
	Go Top
	Locate For gradeid = m.gradeid
	If Found()
		m.ycount = Alltrim(v_grades.Description)
	Endif
Endif
Select (m.oldalias)
Return m.ycount

Function gscale &&get the grade
Parameters e_val

m.ycount = 0
m.staffno = t_params.staffno
m.oldalias = Alias()

Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.gradeid = staff.gradeid
	Select v_grades
	Go Top
	Locate For gradeid = m.gradeid
	If Found()
		m.ycount = scaleid
	Endif
Endif

Select (m.oldalias)
Return m.ycount

Function pgroup &&get the payroll group
Parameters e_val
m.ycount = t_params.compcode
Return m.ycount


Function calcnhif
Parameter m.amtbasic
Private m.area

*This function clculates the nhif contribution
m.area = Select()
m.nhifkey = 'Rate'

Select v_nhif
m.amt = 0
Go Top
Do While Not Eof()
	If !Deleted()
		If m.amtbasic <= Upper
			m.amt=rate
			Exit
		Endif
	Endif
	Skip
Enddo

Select (m.area)

Return m.amt


Function amonth &&
Return lmonth

Function ayear &&
Return lyear


Function cum
Parameters m.qpara,m.qperi,m.qdura
m.cumm = 0

If Empty(m.qperi)
	m.qperi = 1
Endif

If Empty(m.qdura)
	m.qdura = lmonth
Endif

m.zyear = lyear
m.cperi = m.qperi

If !Empty(m.qpara)
	Do While m.cperi <= m.qdura
		m.staffno = t_params.staffno
		m.dfile = 'D_'+Alltrim(Str(m.cperi))+Alltrim(Str(m.zyear))
		nsqlstring = "SELECT * 	FROM "+m.dfile+" where staffno = @lstaffno "
		z = SQLExec(nConnectionHandle, "create procedure picksort_"+m.dfile+" @lstaffno numeric(10) as " + ;
			nsqlstring )
****************************
		m =SQLExec(nConnectionHandle, "execute picksort_"+m.dfile+"  "+Alltrim(Str(m.staffno)),"v_t_month")
		If m > 0
			Select v_t_month
			Go Top
			Locate For para_code = m.qpara
			Do While para_code = m.qpara
				m.cumm = m.cumm+d_amt
				Skip
			Enddo
			Use
		Endif
		m.cperi = m.cperi+1
	Enddo
Endif
Return m.cumm

Function ewo_days &&working days in the month
m.tsun = 0
m.sdcount = 1
m.stdate = Alltrim(Str(m.sdcount))+'/'+Alltrim(Str(m.month))+'/'+Alltrim(Str(m.year))
m.sfdate = Ctod(m.stdate)

If t_params.datejoin > m.sfdate
	m.sdcount = Day(t_params.datejoin)
	m.stdate = Alltrim(Str(m.sdcount))+'/'+Alltrim(Str(m.month))+'/'+Alltrim(Str(m.year))
	m.sfdate = Ctod(m.stdate)
Endif

Do While !Empty(m.sfdate) And !Empty(t_params.datejoin)
	If Dow(m.sfdate) = 1 Or Dow(m.sfdate) = 7 Or !Empty(ishol(m.sfdate))
	Else
		m.tsun = m.tsun+1
	Endif
	If  !Empty(t_params.dateleft) And m.sfdate > t_params.dateleft
		Exit
	Endif
	m.sdcount = m.sdcount+1
	m.stdate = Alltrim(Str(m.sdcount))+'/'+Alltrim(Str(m.month))+'/'+Alltrim(Str(m.year))
	m.sfdate = Ctod(m.stdate)
Enddo
Return m.tsun

Function wo_days &&working days in the month
m.tsun = 0
m.sdcount = 1
m.stdate = Alltrim(Str(m.sdcount))+'/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))
m.sfdate = Ctod(m.stdate)
Do While !Empty(m.sfdate)
	If Dow(m.sfdate) = 1 Or Dow(m.sfdate) = 7 Or !Empty(ishol(m.sfdate))
	Else
		m.tsun = m.tsun+1
	Endif
	m.sdcount = m.sdcount+1
	m.stdate = Alltrim(Str(m.sdcount))+'/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))
	m.sfdate = Ctod(m.stdate)
Enddo
Return m.tsun

Function awdays  &&get the days actualy worked in the current month
m.dcount = 0
m.num = Day(t_params.datejoin)
m.dcount = 0

Return m.dcount
Do While .T. And !Empty(t_params.datejoin)
	If m.num+m.dcount > monthd()
		Exit
	Endif
	If  !Empty(t_params.dateleft) And t_params.datejoin+m.dcount > t_params.dateleft
		Exit
	Endif
	m.dcount = m.dcount+1
Enddo
Return m.dcount

Function ishol
Parameters tdate
m.thol = ''
m.hday = Day(tdate)
m.hmonth = Month(tdate)
Select v_holidays
Locate For hmonth = m.hmonth And hday = m.hday
If Found() And !Deleted()
	m.thol = Code
	If Empty(m.thol)
		m.thol = 'HOL'
	Endif
Endif
Return m.thol


Function monthd
m.tdays = 1
Do While .T.
	m.tdate  = Alltrim(Str(m.tdays))+'/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))
	If Empty(Ctod(m.tdate))
		m.tdays = m.tdays-1
		Exit
	Endif
	m.tdays = m.tdays+1
Enddo
Return m.tdays

Function workper  &&get the number of periods a person has worked
Parameters e_val
Private m.ycount

m.st_date = '01/'+Alltrim(Str(Month(t_params.datejoin)))+'/'+Alltrim(Str(Year(t_params.datejoin)))
m.ycount =  0

m.st_date = Ctod(m.st_date)

m.jmonth = Month(m.st_date)
m.jyear = Year(m.st_date)

m.tesdate = '01/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))
m.esdate = Ctod(m.tesdate)

If m.jyear <> m.year
	m.ssdate = '01/'+Alltrim(Str(m.jmonth))+'/'+Alltrim(Str(lyear-1))
	m.st_date = Ctod(m.ssdate)
	If Gomonth(m.st_date,12) <= m.esdate
		m.st_date = Gomonth(m.st_date,12)
	Endif
Else
	m.ssdate = '01/'+Alltrim(Str(m.jmonth))+'/'+Alltrim(Str(lyear))
Endif

Do While m.st_date <= m.esdate
	m.st_date = Gomonth(m.st_date,1)
	m.ycount = m.ycount+1
Enddo

Return m.ycount


Function taxper  &&get the number of tax periods a person has worked this year
Parameters e_val
Private m.ycount

m.st_date = '01/'+Alltrim(Str(Month(t_params.datejoin)))+'/'+Alltrim(Str(Year(t_params.datejoin)))
m.ycount =  0

m.st_date = Ctod(m.st_date)

m.jmonth = Month(m.st_date)
m.jyear = Year(m.st_date)

m.tesdate = '01/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear))
m.esdate = Ctod(m.tesdate)

If m.jyear <> lyear
	m.ssdate = '01/01/'+Alltrim(Str(lyear))
	m.st_date = Ctod(m.ssdate)
Else
	m.ssdate = '01/'+Alltrim(Str(m.jmonth))+'/'+Alltrim(Str(lyear))
Endif

Do While m.st_date <= m.esdate
	m.st_date = Gomonth(m.st_date,1)
	m.ycount = m.ycount+1
Enddo

Return m.ycount

Procedure shomode
Do Case
Case v_paymodes.paymodeid = 0
	Deactivate Popup modepop
Case v_paymodes.paymodeid = 1
	Deactivate Popup modepop
Case v_paymodes.paymodeid = 2 &&Banks
	Select v_BANKS

	Define Popup bkpop;
		FROM 4.2,60.2;
		TO 20.45,150 ;
		PROMPT Field  Alltrim(Upper(v_BANKS.bank)) ;
		SCROLL;
		MARGIN;
		MESSAGE "";
		COLOR ,Rgb(0,0,255,255,255,255)
	On Selection Popup bkpop Do shobank
	Activate Popup bkpop At 6,46
Endcase
Return


Procedure shobank
lcode = v_BANKS.bankid
Select * From v_branches Having lcode = v_branches.bankid Into Cursor tbranches
Select tbranches
Go Top
If !Eof()

	Define Popup brpop;
		FROM 4.2,100.2;
		TO 24.45,300 ;
		PROMPT Field  Alltrim(Upper(tbranches.branch)) ;
		SCROLL;
		MARGIN;
		MESSAGE "";
		COLOR ,Rgb(0,0,255,255,255,255)

	On Selection Popup brpop Do shobranch
	Activate Popup brpop At 10,45

Endif

Return

Procedure shobranch
Deactivate Popup modepop
Deactivate Popup bkpop
Deactivate Popup brpop
Return

Function ggroup &&get the grade
Parameters e_val
m.ycount = 0
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.groupid = staff.groupid
	Select v_groups
	Go Top
	Locate For groupid = m.groupid
	If Found()
		m.ycount = Alltrim(v_groups.cgroup)
	Endif
Endif
Select (m.oldalias)
Return m.ycount

Function gdept &&get the department
Parameters e_val
m.ycount = 'None'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.deptid = staff.deptid
	nsqlstring = "select * from departments order by department  "
	=SQLExec(nConnectionHandle,nsqlstring,"v_depts")
	Select v_depts
	Go Top
	Locate For deptid = m.deptid
	If Found()
		m.ycount = Alltrim(v_depts.department)
	Endif
	Use
Endif
Select (m.oldalias)
Return m.ycount

*******my new function to get the Functions

Function g_cbal &&get the c_bal
Parameters e_val
m.ycount = 'None'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.deptid = staff.deptid
	nsqlstring = "select * from departments order by department  "
	=SQLExec(nConnectionHandle,nsqlstring,"v_depts")
	Select v_depts
	Go Top
	Locate For deptid = m.deptid
	If Found()
		m.ycount = Alltrim(v_depts.department)
	Endif
	Use
Endif
Select (m.oldalias)
Return m.ycount


Function gshift &&get the shift
Parameters e_val
m.ycount = 'None'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.shiftid = staff.shiftid
	If Used('v_shifts')
		Select v_shifts
		Use
	Endif

	nsqlstring = "select * from shifts  "
	=SQLExec(nConnectionHandle,nsqlstring,"v_shifts")

	Select v_shifts
	Go Top
	Locate For shiftid = m.shiftid
	If Found()
		m.ycount = Alltrim(v_shifts.shiftname)
	Endif
	Use
Endif
Select (m.oldalias)
Return m.ycount

Function gdesignation &&get the designation or function or position in company
Parameters e_val
m.oldalias = Alias()

m.ycount = 'None'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.funcid = staff.funcid
	If !Used('v_functions')
		nsqlstring = "select * from functions  "
		=SQLExec(nConnectionHandle,nsqlstring,"v_functions")
	Endif

	Select v_functions
	Go Top
	Locate For funcid = m.funcid
	If Found()
		m.ycount = Alltrim(v_functions.gfunction)
	Endif
Endif
Select (m.oldalias)
*SELECT tc_params
Return m.ycount

Function gcurr &&get the currency
Parameters e_val
m.ycount = 'None'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.currencyid = staff.currencyid
	If Used('v_currency')
		Select v_currency
		Use
	Endif

	nsqlstring = "select * from currency order by currencydesc  "
	=SQLExec(nConnectionHandle,nsqlstring,"v_currency")

	l_currencydesc = 'Base'

	Select v_currency
	Go Top
	Locate For currencyid = m.currencyid
	If Found()
		m.ycount = Alltrim(v_currency.currencydesc)
	Endif
	Use
Endif
Select (m.oldalias)
Return m.ycount

Function gcurr_c &&get the currency
Parameters e_val
m.ycount = 0
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.ycount = staff.currencyid
Endif
Select (m.oldalias)
Return m.ycount

Function g_rate &&get the currency rate for the month
Parameters e_val,e_month
m.ycount = 0
m.oldalias = Alias()

If Empty(e_month)
	m.le_month = lmonth
Else
	m.le_month = e_month
Endif

If Empty(e_val)
	m.lcurrid = 0
Else
	m.lcurrid = e_val
Endif

If m.lcurrid > 0
	If !Used('v_currency')
		nsqlstring = "select * from currency order by currencydesc  "
		=SQLExec(nConnectionHandle,nsqlstring,"v_currency")
	Endif
	Select v_currency
	Go Top
	Locate For currencyid = m.lcurrid
	If Found()
		m.c_combi = "v_currency."+Left(Lower(mon(m.le_month)),3)+"_rate"
		m.ycount = &c_combi
	Endif
Endif

Select (m.oldalias)
Return m.ycount


Function galtstaff &&get the alternate no
Parameters e_val
m.ycount = '0'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.ycount = Alltrim(staff.altstaffno)
Endif
Select (m.oldalias)
Return m.ycount

Function gscore &&get the alternate no
Parameters e_val
m.ycount = '0'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.ycount = staff.callgenscore
Endif
Select (m.oldalias)
Return m.ycount

Function gagentid &&get the alternate no
Parameters e_val
m.ycount = '0'
If Empty(e_val)
	m.staffno = t_params.staffno
Else
	m.staffno = e_val
Endif
m.oldalias = Alias()
Select staff
Go Top
Locate For staffno = m.staffno
If Found()
	m.ycount = staff.callgenid
Endif
Select (m.oldalias)
Return m.ycount


Function getidno &&get the identificationno
Parameters thisidtype,thisstaffno
m.oldalias = Alias()
l_thisidvalue = ''
l_thisstaffno = 0
If !Isnull(thisstaffno)
	l_thisstaffno = thisstaffno
Endif

l_thisidtype = ''
If !Isnull(thisidtype)
	l_thisidtype = Alltrim(thisidtype)
Endif
If !Empty(l_thisidtype) And l_thisstaffno > 0
	l_filter = "id_code = '"+l_thisidtype+"' AND staffno = "+Alltrim(Str(l_thisstaffno))
	If Used('cv_id')
		Select cv_id
		Use
	Endif
	=opendtable('identification','cv_id',l_filter,.F.,'idid')
	If Used('cv_id')
		Select cv_id
		Go Top
		If !Eof()
			If !Isnull(id_value)
				l_thisidvalue = Alltrim(id_value)
			Endif
		Endif
	Endif
Endif
Select (m.oldalias)
Return l_thisidvalue



Procedure RIGHTM
Wait Window 'RIGHT' Timeout 30
Return .T.

Function workyears &&get the number of years a person has worked
Parameters e_val
Private m.ycount
m.st_date = t_params.datejoin
m.ycount =  0
If  !Empty(m.st_date)
	m.cdate = Ctod('28/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
	m.st_date = Gomonth(m.st_date,12)
	Do While m.st_date < m.cdate
		m.ycount = m.ycount+1
		m.st_date = Gomonth(m.st_date,12)
	Enddo
Endif
Return m.ycount

Function setskin

Return .T.

Function indextable
nsqlstring = 'CREATE INDEX [D_22005] ON [dbo].[d_22005] ([d_monthid]  desc ) WITH DROP_EXISTING ON [PRIMARY]'
*WITH
*   DROP_EXISTING
*ON [PRIMARY]
MN=SQLExec(nConnectionHandle,nsqlstring)
Return

Function opendtable
Parameters l_table,l_alias,l_filter,l_updatable,l_keyfield

If nConnectionHandle < 1 &&no handle!! Must quit
	Return .F.
Endif

o_alias = Alias()
opensuccess = .F.

If !Empty(l_table)
	l_table = Alltrim(l_table)

	If Empty(l_alias)
		l_alias = Alltrim(l_table)
	Endif

	If Empty(l_keyfield)
		l_keyfield = ''
	Else
		l_keyfield = Alltrim(l_keyfield)
	Endif

	If !Empty(l_filter)
		l_filter = Alltrim(l_filter)
		l_openstr = "select * from "+l_table+" where "+l_filter
	Else
		l_openstr = "select * from "+l_table
	Endif

	If !Empty(l_keyfield)
		l_openstr = l_openstr+" ORDER BY "+l_keyfield
	Endif
	l_opened =SQLExec(nConnectionHandle,l_openstr,l_alias)

	If l_opened > 0 And l_updatable And !Empty(l_keyfield)
		l_table = Upper(Alltrim(l_table))

		Select (l_alias)
		Set Multilocks On  && Must be on for table buffering
		=CursorSetProp("Tables",l_table)

** The next property must include every remote field matched with the
** view cursor field
		Select (l_alias)

**Build up the required fields ::

		Usqlstring = ""
		uusqlstring = ""
		l_total = Fcount()
		lc = 1
		Do While lc <= l_total
			nFieldNumber = lc
			l_fieldname = Alltrim(Field(nFieldNumber))
			Usqlstring = Usqlstring+Alltrim(l_fieldname)+" "
			Usqlstring = Usqlstring+l_table+"."+Alltrim(l_fieldname)+" "
			If !Empty(uusqlstring)
				uusqlstring = uusqlstring+","
			Endif
			uusqlstring = uusqlstring+Alltrim(l_fieldname)
			lc = lc+1
		Enddo

		Select (l_alias)
		=CursorSetProp("UpdateNameList", Usqlstring)

** Set the key field
		=CursorSetProp("KeyFieldList",l_keyfield)

** The next property specifies which fields can be updated.
		=CursorSetProp("UpdatableFieldList",uusqlstring)

** The next property enables the ability to send updates.
		=CursorSetProp("SendUpdates", .T.)
		=CursorSetProp('Buffering', 3,l_alias)  && Enable table buffering
	Endif
Endif

If Used(l_alias)
	opensuccess = .T.
	Select (l_alias)
Else
	If !Empty(o_alias)
		Select (o_alias)
	Endif
Endif
Return opensuccess


Procedure buildexpr2
Parameters tp_formu

m.ok = .T.

If !Empty(tp_formu)
	Select * From e_params Order By p_s_name Into Cursor tparams

*space place into m.buildform to prevent a return value that is greater than
*0 if code does not exist

	m.termys = '",()+-/*^<>='  &&Those that terminate a string

	Store 1 To m.counter, m.no
	Store "" To m.sign, m.p_formu1

	m.ok = .T.
	m.p_formu = Alltrim(tp_formu)

	Store "" To m.buildform

	m.statexact = Set('EXACT')

	Set Exact On
	For m.counter = 1 To Len(m.p_formu)+1
*i = SUBSTR(m.itemno2,m.counter,1)
		i = Substr(m.p_formu,m.counter,1)

		If i $ m.termys Or m.counter = Len(m.p_formu)+1
			If m.counter = Len(m.p_formu)+1
				m.ok = check_f(Alltrim(m.buildform)," ")
			Else
				m.ok = check_f(Alltrim(m.buildform),Substr(m.p_formu,m.counter,1))
			Endif
		Else
			m.buildform = m.buildform+i
		Endif

		If !m.ok
			m.counter = Len(m.p_formu)+1 &&Exit in a sly way . Jumping to the exit point
		Endif
	Endfor
	Set Exact &statexact

	If !m.ok
		Wait Window "Not a valid expression" Timeout 3
	Else
		Select e_params
		Replace p_formu1 With m.p_formu1
*WAIT WINDOW  m.p_formu1+' '+ALLTRIM(e_params.P_L_NAME) TIMEOUT 30
*Wait WINDOW "Expression Valid" NOWAIT
	Endif
Endif
Return m.ok

Function foxfunc
Parameters s_fun
m.s_fun = Alltrim(s_fun)+"()"
Select udfs
Go Top
Locate For Upper(Alltrim(Func)) = Upper(Alltrim(m.s_fun))
Return Found()

Function check_f
Parameters sofar,thisone
m.ar = Select()
sofar = Alltrim(sofar)

If thisone $ '" "+-/(),*<>='  &&normal mathematical functions
	Select tparams
	Go Top
	m.balmode = .F.
	If Right(Alltrim(sofar),1) = '_'
		sofar = Left(Alltrim(sofar),Len(Alltrim(sofar))-1)
		m.balmode = .T.
	Endif
	Locate For Upper(Alltrim(p_s_name)) = Upper(Alltrim(sofar))

	If Found() Or Empty(Alltrim(sofar)) Or foxfunc(Upper(Alltrim(sofar)))
		If Found() And !Empty(tparams.p_s_name)
			If m.balmode
				m.buildform = "FB_EVAL('"+Alltrim(Str(tparams.para_code))+"')"
			Else
				m.buildform = "F_EVAL('"+Alltrim(Str(tparams.para_code))+"')"
			Endif
		Endif
		m.p_formu1=m.p_formu1+m.buildform+thisone
		Store "" To m.buildform
		Return .T.
	Else
		If Type(sofar) = "N" Or Type(sofar) = "D" Or Type(sofar) = "C"
			m.p_formu1=m.p_formu1+m.buildform+thisone
			Replace e_params.p_formu1 With Alltrim(m.p_formu1)
			Store "" To m.buildform
			Return .T.
		Else
			Return .F.
		Endif
	Endif
Else
	Return .F.
Endif
Select (m.ar)
Return .F.

Procedure shopay
Deactivate Popup paypop
Return .T.


Function checkaccess
Parameters xlappuserid,xlatype,xlacontrol

lastalias = Alias()
If Empty(xlappuserid)
	lappuserid = 0
Else
	lappuserid = xlappuserid
Endif

If lappuserid  > 0
	If Used('t_appuser')
		Select t_appuser
		Use
	Endif
	lopened = opendtable('appuser','t_appuser','',.F.,'appuserid')

	Select t_appuser
	Go Top
	Locate For appuserid = lappuserid
	If Found()
		lurights = Alltrim(urights)
		l_username = ''
		fullusername= Alltrim(Alltrim(t_appuser.othernames)+' '+Alltrim(t_appuser.surname))
		If Empty(fullusername)
			fullusername = Alltrim(username)
		Endif
		l_username = Upper(Alltrim(username))

		Select t_appuser
		If l_username = 'ADMIN'
			Return .T.
		Endif

		c_userlevel= userlevel

		If Empty(xlatype)
			latype = ' '
		Else
			latype = Upper(Alltrim(xlatype))
		Endif
		If !Empty(Alltrim(latype))
			If Empty(xlacontrol)
				lacontrol = ' '
			Else
				lacontrol = Alltrim(xlacontrol)
			Endif

			If !Empty(Alltrim(lacontrol))
				If !Used('tu_controls')
					lopened = opendtable('u_controls','tu_controls','',.F.,'controlid')
				Endif
				Select tu_controls

				Go Top
				Locate For Alltrim(controlname) = lacontrol
				If Found()
					lcontrolid = tu_controls.controlid
					lsearchp = '['+Alltrim(Str(lcontrolid))+'/'+latype+']'
					If At(lsearchp,lurights) > 0
						If !Empty(lastalias) And Used(lastalias)
							Select (lastalias)
						Endif
						Return .T.
					Endif
				Endif
			Endif
		Endif
	Endif
Endif
If !Empty(lastalias) And Used(lastalias)
	Select (lastalias)
Endif

Return .F.


Procedure annualdets
lopened = opendtable('identification','identification','id_no = 1',.F.,'id_no')

If !Used('P9PARAS')
	lopened = opendtable('P9PARAS','P9PARAS','',.F.,'P9PARASid')
Endif

If !Used('v_groups')
	lopened = opendtable('groups','v_groups','',.F.,'groupid')
Endif

If !Used('staff')

	lconstr = ""
	lpaygroup = 'All Groups'

	If 	defgroupid > 0
		lconstr = lconstr+'staff.groupid = '+Alltrim(Str(defgroupid))
		Select v_groups
		Go Top
		Locate For groupid = defgroupid
		If Found()
			lpaygroup = Alltrim(cgroup)
		Endif
	Endif
	m.tx_cdx = m.tmppath+"tx"+Left(Sys(3),6)+".cdx" &&Index for the temporary file
	=opendtable('staff','staff',lconstr,.T.,'staffno')
	Select staff
Endif

Select v_groups

**************p9a
If Left(Upper(Alltrim(q_reports.r_name)),6) <> 'SPREAD'
	Create Cursor p9a (p9aid N(10),mmonth N(2),staffno N(10),employer C(100),surname C(100),onames C(100),;
		co_pin C(20),emp_pin C(20),monthy C(15), A N(12,2), B N(12,2), C N(12,2), D N(12,2), e1 N(12,2), ;
		e2 N(12,2), e3 N(12,2), F N(12,2), G N(12,2), H N(12,2),  j N(12,2), K N(12,2), l N(12,2), m N(12,2),;
		join_date D(8),end_date D(8),rent N(12,2),m2 N(12,2),servant N(12,2),gardener N(12,2),;
		ayah N(12,2),watchd N(12,2),watchn N(12,2),furniture N(12,2),water N(12,2),phone N(12,2),;
		elec N(12,2),alarm N(12,2),intben N(12,2),car N(12,2),carsize N(8),ssmonth N(2),eemonth N(2))

	m.p9aid = 0

	Select staff
	Go Top

	Do While !Eof()
		Select staff
		If (Year(Ctod(staff.dateleft)) < lr_t_year And !Empty(Ctod(staff.dateleft))) Or (Year(Ctod(staff.datejoin)) > lr_t_year And !Empty(Ctod(staff.datejoin)))
			Skip
			Loop
		Endif

		Select staff
		m.staffno = staff.staffno
		lLstaffno = staff.staffno
		m.ccount = 1
		Do While m.ccount <= 12
			m.p9aid = m.p9aid+1

			m.executed = 1
			m.dfile = 'd_'+Alltrim(Str(m.ccount))+Alltrim(Str(lr_t_year))

			If !Used(m.dfile)
				osuccess =opendtable(m.dfile,m.dfile,"",.T.,'d_monthid')
			Endif

			If !Used(m.dfile)
				m.executed = 0
			Endif

			m.servant = 0
			m.gardener = 0
			m.ayah = 0
			m.watchd = 0
			m.watchn = 0
			m.furniture = 0
			m.water = 0
			m.phone = 0
			m.elec = 0
			m.alarm = 0
			m.intben = 0
			m.carsize = 0
			m.car = 0

			m.A = 0  &&Basic pay
			m.B = 0  &&Non-benefit cash
			m.C = 0  &&Value of quarters
			m.D = 0  &&Gross pay
			m.e1 = 0  && 30% of Gross
			m.e2 = 0  && Actual contrib
			m.e3 = 0  && Fixed
			m.f = 0  && Owner occupied interest -Standard amount of interest
			m.G = 0  && Retirement contrib- The lowest of E added to F
			m.H = 0  && D-G
			m.j = 0  && ROUND TO K-pounds (H)
			m.K = 0  && tax on (J)
			m.l = 0  && Relief
			m.m = 0  && PAYE TAX (K-L)
			m.m2 = 0

			m.mmonth = m.ccount
			monthy = mon(m.ccount)

			m.staffno = staff.staffno
			m.surname = staff.surname
			m.onames = staff.onames
			m.join_date = Ctod(staff.datejoin)
			m.end_date = Ctod(staff.dateleft)

			m.emp_pin = ''
			Select identification
			Go Top
			Locate For staffno = m.staffno
			If Found()
				m.emp_pin = Alltrim(id_value)
			Endif

			m.co_pin = Alltrim(v_groups.pin)
			m.employer = Alltrim(v_groups.cpname_l)

			If m.executed > 0
				m.A = getamts('BASIC')
				m.B = getamts('BENEFITS')
				m.C = getamts('QUARTER')

				m.D = m.A+m.B+m.C

				If m.D > 0
					m.e2 = getamts('ACTUAL')
					m.e1 = 0
					m.e3 = 0

					If m.e2 > 0
						m.e1 = Round((30/100)*m.A,0)
						m.e3 = getamts('FIXED')
					Endif
					m.f = getamts('OWNER')

					m.G = getlower(m.e1,m.e2,m.e3)+m.f
					m.H = m.D-m.G
					m.j = Round(m.H/20,0)

					m.K = getamts('TAX')
					m.l = getamts('RELIEF')  &&Relief
					m.m = getamts('PAYE')  &&PAYE

					m.madj = getamts('TAXADJ') &&Interest benefit
					m.mpayea = getamts('PAYEA') &&Interest benefit

					m.m = m.m+m.madj+m.mpayea
					m.rent = getamts('RENT')  &&Rent
					m.servant = getamts('SERVANT') &&Servant
					m.gardener = getamts('GARDENER') &&Servant
					m.ayah = getamts('AYAH') &&Servant
					m.watchd = getamts('WATCHD') &&Servant
					m.watchn = getamts('WATCHN') &&Servant
					m.furniture = getamts('FURNITURE') &&Servant
					m.water = getamts('WATER') &&Servant
					m.phone = getamts('PHONE') &&Servant
					m.elec = getamts('ELEC') &&Servant
					m.alarm = getamts('ALARM') &&Servant
					m.intben = getamts('INTBEN') &&Interest benefit
					m.carsize = getamts('CARSIZE') &&Interest benefit
					m.car = getamts('CAR') &&Interest benefit
				Endif
			Endif
			Select p9a
			Append Blank
			Gather Memvar
			m.ccount = m.ccount+1
		Enddo

		Select staff
		Skip
	Enddo

	Select p9a

	m.t_file = Upper(Alltrim(q_reports.r_name))
	m.repfile = reportpath+m.t_file+".FRX"

	If Upper(Alltrim(q_reports.r_name)) = 'W9F'
		m.repfile = reportpath+"W9F.FRX"
	Endif

	Select p9a
	If Upper(Alltrim(q_reports.r_name)) = 'P9A (BACK PAGE)'
		m.repfile = reportpath+"P9A_2.FRX"
		Select * From p9a Having p9a.A > 0 Into Cursor p9a_t
		Select p9a_t.staffno, p9a_t.join_date, p9a_t.end_date ;
			FROM p9a_t ;
			GROUP By p9a_t.staffno Into Cursor p9a_2
		Select p9a_2
	Endif

	Select p9a

*If (Left(Upper(Alltrim(q_reports.r_name)),3) = 'P10' And Left(Upper(Alltrim(q_reports.r_name)),4) <> 'P10A') Or Left(Upper(Alltrim(q_reports.r_name)),4) = 'W10F'

	m.repfile = reportpath+"P10.FRX"
	If Upper(Alltrim(q_reports.r_name)) = 'W10F'
		m.repfile = reportpath+"W10F.FRX"
	Endif

	If Used('p9b')
		Select p9b
		Use
	Endif

	Select * ;
		FROM p9a ;
		ORDER By p9a.mmonth ;
		INTO Cursor p9b

	If Used('p10')
		Select p10
		Use
	Endif

	Select p9b

	Select p9b.mmonth,p9b.monthy, Sum(p9b.m) As 'M';
		FROM p9b;
		ORDER By p9b.mmonth,p9b.monthy;
		GROUP By p9b.mmonth,p9b.monthy;
		INTO Cursor p10
	Select p10
Else
	If 1 = 2
		m.tz_cdx = m.tmppath+"tz"+Left(Sys(3),6)+".cdx" &&Index for the temporary file

		Select (m.d_f_list)
		Set Order To Tag f_code Of (m.i_f_list)

		Create Cursor tannual (empcode N(4),surname C(100),onames C(100),;
			jan N(12,2),feb N(12,2),mar N(12,2),apr N(12,2),may N(12,2),jun N(12,2),;
			jul N(12,2),aug N(12,2),sep N(12,2),oct N(12,2),nov N(12,2),dec N(12,2))

		Index On empcode Tag empcode Of (m.tz_cdx) Ascending

		Select tannual
		Set Order To Tag empcode Of (m.tz_cdx)

		m.fstr = Alltrim(q_reports.rep_fields)

		Select(m.d_emp)
		Go Top

		Do While !Eof() &&EMPLOYEE FILE
			Select staff
			If (Year(end_date) < lr_t_year And !Empty(end_date)) Or (Year(join_date) > lr_t_year And !Empty(join_date))
				Skip
				Loop
			Endif
			Select t_params
			Set Order To Tag empcode Of (m.tx_cdx)
			Seek empdata.empcode
			If !Found()
				Select staff
				Skip
				Loop
			Endif

			Set Order To Tag emp_per Of (m.tx_cdx)

			Select staff
			m.ccount = 1
			Do While m.ccount <= 12
				m.fstr = Alltrim(q_reports.rep_fields)

				Do While !Empty(m.fstr)
					m.fpos = At("}",m.fstr)
					m.f1 = Left(m.fstr,m.fpos-1)
					m.addf = Substr(m.f1,2)
					If m.fpos <> Len(m.fstr)
						m.fstr = Substr(m.fstr,m.fpos+1)
					Else
						m.fstr = ""
					Endif

					Select (m.d_f_list)
					Seek Val(m.addf)

					If Found()
						m.para_code = para_code

						If m.para_code > 0
							m.empcode = empdata.empcode
							m.surname = empdata.surname
							m.onames = empdata.onames

							m.semp_per = "("+Alltrim(Str(empdata.empcode))+"*"+Alltrim(Str(m.ccount))
							m.temp_per = m.semp_per+"*"+Alltrim(Str(m.para_code))+")"
							m.monthy = 'tannual.'+Left(mon(m.ccount),3)

							Select t_params
							Seek m.temp_per

							If Found()
								m.retamt = op_amt+sal_amt+amt
							Else
								m.retamt = 0
							Endif

							Select tannual
							Seek m.empcode
							If !Found()
								Append Blank
								Gather Memvar Fields surname,onames,empcode
							Endif
							Replace &monthy With &monthy+m.retamt
						Endif
					Endif
				Enddo

				m.ccount = m.ccount+1
			Enddo &&MONTHS

			Select staff
			Skip
		Enddo &&EMPLOYEE

		Select tannual
	Endif
Endif

Go Top
Return


Procedure coinage
m.alias = Alias()
lopened = opendtable('money','t_money','',.F.,'moneyid')
If 1 = 1 &&lopened > 0
	Create Cursor money (Desc C(150),Value N(12,2),Number N(10))
	m.cc_cdx = m.tmppath+"cc"+Left(Sys(3),6)+".cdx"
	Index On Value Tag Value Of (m.cc_cdx) Descending Additive
	Select t_money
	Go Top
	Do While !Eof()
		m.value = mvalue
		m.number = 0
		m.desc = Alltrim(mDesc)
		Select money
		Append Blank
		Gather Memvar
		Select t_money
		Skip
	Enddo

	m.co_cdx = m.tmppath+"co"+Left(Sys(3),6)+".cdx"
	m.cur_str = "STAFFNO N(10),altstaffno C(10),cgroup C(50),onames C(25),surname C(15), tnet N(12,2) "

	Select money
	Set Order To Value
	Go Top
	Do While !Eof()
		If Value < 1.0
			m.cur_str = M.cur_str+", nc_"+Alltrim(Str(Int(Value*100)))+" N(12,2)"
		Else
			m.cur_str = M.cur_str+", n_"+Alltrim(Str(Int(Value)))+" N(12,2)"
		Endif
		Select money
		Skip
	Enddo

	m.cur_str = "("+M.cur_str+")"
	Create Cursor  det_coin &cur_str


	Select det_coin
	Index On altstaffno Tag altstaffno  Of (m.co_cdx) Additive
	Index On staffno Tag staffno  Of (m.co_cdx) Additive
	Index On cgroup Tag cgroup Of (m.co_cdx) Additive

	Select money
	Set Order To Tag Value
	Replace All Number With 0

	Select (m.alias)
	Go Top
	If !Eof()
		Do While !Eof()
			m.bal=net
			lpaygroup  = ''
			lxstaffno = staffno

			=opendtable('staff','v_staff','',.F.,'staffno')

			Select v_staff
			Go Top
			Locate For staffno = lxstaffno

			m.altstaffno = altstaffno
			m.surname = surname
			m.onames = onames
			m.staffno = staffno
			l_thisgroupid = groupid

			Select v_groups
			Go Top
			Locate For groupid = l_thisgroupid
			If Found()
				lpaygroup = Alltrim(cgroup)
			Endif


			Select det_coin
			Append Blank
			Replace tnet With m.bal
			Replace altstaffno With m.altstaffno
			Replace surname With Alltrim(m.surname)
			Replace onames With Alltrim(m.onames)
			Replace staffno With m.staffno
			Replace cgroup With lpaygroup

			Select money
			Go Top

			Do While !Eof()
				m.den = Upper(Alltrim(Desc))
				m.num = ((m.bal-(m.bal%Value))/Value)

				If Value < 1.0
					m.cValue = Alltrim(Str(Int(Value*100)))
					m.rep_den = "NC_"+m.cValue
				Else
					m.cValue = Alltrim(Str(Int(Value)))
					m.rep_den = "N_"+m.cValue
				Endif

				Select det_coin
				Replace &rep_den With m.num

				Select money
				Replace Number With Number+m.num
				m.bal=m.bal%Value
				Skip
			Enddo
			Select(m.alias)
			Skip
		Enddo

		Select det_coin
		Set Order To Tag cgroup Of (m.co_cdx)
		Go Top
	Endif

	Select money
	Use

	Select det_coin
	Go Top

	If File((reportpath+'DETCOIN.Frx'))
		Report Form (reportpath+'DETCOIN.Frx') Preview
	Endif
Endif
Return


Function isholiday
Parameters ldate

molias = Alias()
If Dow(ldate) = 1 Or Dow(ldate) = 7
	Return .T.
Else
	tlday = Day(ldate)
	tlmonth = Month(ldate)
	Select holidays
	Set Filter To holidays.H_month = tlmonth And holidays.hday = tlday
	Go Top
	If !Eof()
		Set Filter To
		Return .T.
	Endif
	Set Filter To
Endif

If !Empty(molias)
	Select (molias)
Endif
Return .F.


Procedure shoC
Deactivate Popup Cpop
Return


Procedure createtable
Parameters ctable
Set Defa To (HomeDir)
Return .T.

If !Used('e_tables')
	Select 0
	Use (Alltrim(HomeDir)+'e_tables.DBF') Shared
Endif

Set Defa To (IDC_Datapath)

l_ctable = Alltrim(Upper(ctable))

Select e_tables
Set Order To e_table
Go Top
Seek l_ctable

If Found()
	nsqlstring = "CREATE TABLE "+Alltrim(l_ctable)+" ("
	m.sep = ''
	Do While Alltrim(Upper(e_table)) = l_ctable And !Eof()
		l_fieldname = Alltrim(e_tables.fieldname)
		l_fieldtype = Alltrim(e_tables.fieldtype)
		l_fieldsize = e_tables.fieldsize
		l_fielddec = e_tables.fielddec

		nsqlstring = nsqlstring+m.sep+l_fieldname+' '
		nsqlstring = nsqlstring+l_fieldtype+'('
		nsqlstring = nsqlstring+Alltrim(Str(l_fieldsize))

		If l_fielddec > 0
			nsqlstring = nsqlstring+','+Alltrim(Str(l_fielddec))
		Endif
		nsqlstring = nsqlstring+')'
		m.sep = ','

		Select e_tables
		Skip
	Enddo
	Use
	nsqlstring = nsqlstring+')'
	MN=SQLExec(nConnectionHandle,nsqlstring)
Endif

If MN = 1
	Return .T.
Else
	Return .F.
Endif


Function checkname
Parameters xlappuserid

lastalias = Alias()
fullusername= 'All'
If Empty(xlappuserid)
	lappuserid = 0
Else
	lappuserid = xlappuserid
Endif

If lappuserid  > 0
	If Used('t_appuser')
		Select t_appuser
		Use
	Endif
	lopened = opendtable('appuser','t_appuser','',.F.,'appuserid')
	Select t_appuser
	Go Top
	Locate For appuserid = lappuserid
	If Found()
		lurights = Alltrim(urights)
		fullusername= Alltrim(Alltrim(t_appuser.othernames)+' '+Alltrim(t_appuser.surname))
		If Empty(fullusername)
			fullusername = Alltrim(username)
		Endif
	Endif
Endif
If !Empty(lastalias) And Used(lastalias)
	Select (lastalias)
Endif
Return fullusername

Function checkparas
Parameters xlappuserid
lastalias = Alias()
fullusername= ''

If Empty(xlappuserid)
	lappuserid = 0
Else
	lappuserid = xlappuserid
Endif

If lappuserid  > 0
	If Used('e_appuser')
		Select e_appuser
		Use
	Endif
	lopened = opendtable('appuser','e_appuser','appuserid = '+Alltrim(Str(lappuserid)),.T.,'appuserid')
	Select e_appuser
	Go Top
	If !Eof()
		If Isnull(selparas)
			fullusername= ''
		Else
			fullusername= Alltrim(e_appuser.selparas)
		Endif
	Endif
Endif

If !Empty(lastalias) And Used(lastalias)
	Select (lastalias)
Endif
Return fullusername


Function canedit
Parameters xr_reportid
lastalias = Alias()
lcanedit = .F.
If !Empty(xr_reportid)
	Select q_reports
	Locate For reportid = xr_reportid
	If Found()
		If appuserid = l_appuserid Or appuserid = 0
			lcanedit = .T.
		Endif
	Endif
Endif
If !Empty(lastalias) And Used(lastalias)
	Select (lastalias)
Endif
Return lcanedit

Procedure ffind
Parameters ltfind
If !Empty(currform)
	Select (currform)
	APP_GLOBAL.showtablefinddialog
Endif
Return


Procedure gparavalue
Parameters parac,gstaffno
LOALIAS = Alias()
lwhen = 0
lparac = 0
lpempcode = 0
lgstaffno = 0

If !Empty(parac)
	lparac = parac
Endif

If !Empty(gstaffno)
	lgstaffno = gstaffno
Endif

lpvalue = 0
If lparac > 0
	If Used('t_params')
		Select t_params
		If lgstaffno > 0
			Select * From t_params Where staffno = lgstaffno Order By para_code Into Cursor vt_params
		Else
			Select * From t_params Order By para_code Into Cursor vt_params
		Endif
		Select vt_params
		Go Top
		Locate For para_code = lparac
		Do While para_code = lparac  And !Eof()
			If !Deleted()
				lpvalue = lpvalue+amt
			Endif
			Skip
		Enddo
		Use
	Endif
Endif
If !Empty(LOALIAS)
	Select (LOALIAS)
Endif
Return lpvalue


Procedure gparaname
Parameters parac,gstaffno
LOALIAS = Alias()
lparac = 0
lgstaffno = 0

If !Empty(parac)
	lparac = parac
Endif

If !Empty(gstaffno)
	lgstaffno = gstaffno
Endif

lpname = ' '
If lparac > 0
	If Used('t_params')
		Select t_params
		If lgstaffno > 0
			Select * From t_params Where staffno = lgstaffno And para_code = lparac Order By para_code Into Cursor vc_params
		Else
			Select * From t_params Where para_code = lparac Order By para_code Into Cursor vc_params
		Endif

		Select vc_params
		Go Top
		lpname = Alltrim(p_l_name)
		Use
	Endif
Endif
If !Empty(LOALIAS)
	Select (LOALIAS)
Endif

Return lpname



*CREATE [ UNIQUE ] [ CLUSTERED | NONCLUSTERED ] INDEX index_name
*    ON { table | view } ( column [ ASC | DESC ] [ ,...n ] )
*[ WITH < index_option > [ ,...n] ]
*[ ON filegroup ]

*< index_option > :: =
*   { PAD_INDEX |
*      FILLFACTOR = fillfactor |
*      IGNORE_DUP_KEY |
*      DROP_EXISTING |
*  STATISTICS_NORECOMPUTE |
*  SORT_IN_TEMPDB
*}

Function checkdate
Parameters fin_date
If !Isnull(fin_date)
	l_fin_date = fin_date
	Select e_p9paras
	Go Top
	Locate For Alltrim(Upper(para_des)) = 'FINYEAR'
	If Found()
		lfin_firstmon = defavalue

		lcurrfinmon = lmonth
		lcurrfinyear = lyear
		last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(lcurrfinyear)))
		If lcurrfinmon < lfin_firstmon
			lcurrfinyear = lyear-1
			last_date = Ctod('01/'+Alltrim(Str(lfin_firstmon))+'/'+Alltrim(Str(lcurrfinyear)))
		Endif
		lc_date = Ctod('01/'+Alltrim(Str(lmonth))+'/'+Alltrim(Str(lyear)))
		ltmon = 0
		Do While last_date <= lc_date
			last_date = Gomonth(last_date,1)
			ltmon = ltmon+1
		Enddo
		lcurrfinmon = ltmon
		Thisform.Container1.Lblcurrperiod.Caption = 'The current financial period : '+Alltrim(Str(ltmon))+' of '+Alltrim(Str(lcurrfinyear))
	Endif
Endif
Return cal_date

Function stripext
Parameter m.filename
Private m.dotpos, m.terminator
m.dotpos = Rat(".", m.filename)
m.terminator = Max(Rat("\", m.filename), Rat(":", m.filename))
If m.dotpos > m.terminator
	m.filename = Left(m.filename, m.dotpos-1)
Endif
Return m.filename

* STRIPPATH - Strip the path from a file name.
*
* Description:
* Find positions of backslash in the name of the file.  If there is one
* take everything to the right of its position and make it the new file
* name.  If there is no slash look for colon.  Again if found, take
* everything to the right of it as the new name.  If neither slash
* nor colon are found then return the name unchanged.
*
* Parameters:
* filename - character string representing a file name
*
* Return value:
* The string "filename" with any path removed
*


Function strippath
Parameter m.filename
Private m.slashpos, m.namelen, m.colonpos
m.slashpos = Rat("\", m.filename)
If m.slashpos <> 0
	m.namelen  = Len(m.filename) - m.slashpos
	m.filename = Right(m.filename, m.namelen)
Else
	m.colonpos = Rat(":", m.filename)
	If m.colonpos <> 0
		m.namelen  = Len(m.filename) - m.colonpos
		m.filename = Right(m.filename, m.namelen)
	Endif
Endif
Return m.filename



****************For export formats
*	This program contains additional functions only (for SET PROCEDURE TO)
*
*	The program that actually is doing the work is RepExpFl.
*
*	Here are placed two type of functions:
*		1.	Functions NEEDED RepExpFl to work (they are called from inside RepExpFl).
*			These functions you can include in your project procedure file, or write your own
*			with same functionality.
*		2.	Functions needed only examples to work. With them you can do what you like.
*
*	Functions used in RepExpFl from Foxtools.fll:
*		In VFP WORDS, WORDNUM.
*		In Foxpro 2.6 for Windows: some more functions like FORCEEXT and more.
*		In Foxpro 2.6 for DOS: you have to write replacements for all functions used from Foxtools.fll.

#INCLUDE "FOXPRO.H"

************************ START SECTION: Functions NEEDED RepExpFl to work
*	Functions NEEDED RepExpFl to work (they are called from inside RepExpFl).
*	These functions you can include in your project procedure file, or write your own
*	with same functionality.

***
*	Creates a table according to the given structure information
*	(CREATE TABLE or CREATE CURSOR with error handling)
*	Written by Nikolay Petkov
*	PARAMETERS:
*	tcPath
*		empty - create a cursor
*		valid path and name - create a table with given name
*	aStrct - structure information. Possibilities
*		1. with ARRAY
*		2. directly with string of type "field1 N(4), field2 C(10)"
*	tnBlockSiz - BLOCKSIZE for created table
*	tcAlias - (inp) alias (cursor name) to open cursor or table and to use in program
*			(out) - new alias
*	tcOtherFormat - (only in case of table creation) Table is created in other format. For example if here place FOX2X - in old 2.6 format
*		(see COPY TO command for more information)
*	RETURNs:
*		 0 if all is OK, otherwise number of the error
*		IF OK - new table is selected as work area
*	EXAMPLEs:
*	to create table
*IF CreTabl1( m.pathDB, @aStruct, 0, '', 'FREE' ) = 0
*ENDIF
*	to create cursor
*IF CreTabl1( '', @aStruct, 0, m.tcAlias ) = 0
*ENDIF
*
Function CreTabl1( tcPath, aStrct, tnBlockSiz, tcAlias, tcClause, tcOtherFormat )
If Empty(m.tnBlockSiz)
	tnBlockSiz = SetBlock()
Endif
If !IsChar(m.tcClause)
	tcClause = Iif( Empty(m.tcPath), '', 'FREE' ) && defaults to create FREE tables
Endif
Local lcStructInfo, lnOldBlock, lnError, lcOldOnERR
If Type("aStrct[1]")="U"
	lcStructInfo = "(" + m.aStrct + ")"
Else
	lcStructInfo = "FROM ARRAY aStrct"
Endif
lnOldBlock = SetBlock()
lnError = 0
lcOldOnERR = onError()
On Error lnError=Error()
Set Blocksize To m.tnBlockSiz
Select 0	&& in any case - to have criteria if can not be created
If Empty(m.tcPath)
*	create a CURSOR
	If Empty(m.tcAlias)
		tcAlias = Sys(2015)
	Endif
	Create Cursor (m.tcAlias) &tcClause ;
		&lcStructInfo
Else
*	create a TABLE
	tcPath = Force_DBF(m.tcPath,.T.)
	If Empty(m.tcOtherFormat)
		Create Table (m.tcPath) &tcClause ;
			&lcStructInfo
	Else
*	Table is created in other format. For exmple if tcOtherFormat="FOX2X" - in old 2.6 format
		Local lcAliasTmp
		lcAliasTmp = Sys(2015)
		Create Cursor (m.lcAliasTmp) &lcStructInfo
		If m.lnError = 0
			Copy To (m.tcPath) Type &tcOtherFormat
			If m.lnError = 0
				If Empty(m.tcAlias)
					Use (m.tcPath) Exclusive
				Else
					Use (m.tcPath) Alias (m.tcAlias) Exclusive
				Endif
			Endif
		Endif
		=Close1(m.lcAliasTmp)
	Endif
	If m.lnError = 0
*	if OK, new table work area is selected
		If !Empty(m.tcAlias) And !CurAlias( m.tcAlias )
*	if other alias is given - re-open with this alias
			Use (m.tcPath) Alias (m.tcAlias) Exclusive
		Endif
		Flush	&& to be shure that table files are really created on disk!! (otherwise buffering in Windows...)
	Endif
Endif
If m.lnError = 0
	If Used()
		tcAlias = Alias()
	Else
		lnError = -1	&& it is not created, but no error (!) - we set error to -1
	Endif
Endif
Set Blocksize To m.lnOldBlock
On Error &lcOldOnERR
Return m.lnError

***
*	Return FoxPro version running (compatible in all FoxPro versions)
*	VERSION(5) returns the number 700 in VFP, so this function is not universal and compatible in versions up to VFP
*	Written by Nikolay Petkov
*
Function FoxVersion
Private lcVerStr, lnVersion, ln1, ln2, i
lnVersion = 0
lcVerStr = Version(1)
For i=1 To 3
	ln1 = At(Space(1),m.lcVerStr,m.i) + 1
	ln2 = At(Space(1),m.lcVerStr,m.i+1)
	lnVersion = Val(Substr(m.lcVerStr,m.ln1,m.ln2-m.ln1))
	If m.lnVersion > 0
		Exit
	Endif
Endfor
Return m.lnVersion

***
*	Returns RECNO(), but if the table is in state BOF(),EOF()
*	returns negative value, to be used with function GO1
*
Function recno1
Lparameters tcAlias
If Empty(m.tcAlias)
	tcAlias = Alias()
Endif
If Empty(m.tcAlias)
	Return -3
Endif
If Eof(m.tcAlias)
	Return -2
Endif
If Bof(m.tcAlias)
	Return -1
Endif
Return Recno(m.tcAlias)

***
*	As GO, but with checking position, to be used with function Recno1
*
Function Go1
Lparameters tnRecToGo, tcAlias
If Empty(m.tcAlias)
	tcAlias = Alias()
Endif
Do Case
Case m.tnRecToGo>Reccount(m.tcAlias)
	Go Bottom In (m.tcAlias)
	Return .F.
Case m.tnRecToGo<1
	Go Top In (m.tcAlias)
	Return .F.
Otherwise
	Go m.tnRecToGo In (m.tcAlias)
	Return ( Recno(m.tcAlias)=m.tnRecToGo )
Endcase

****
*	Closes a table and returns the result
*
Function Close1
Lparameter tcAlias, tlUsed
If Vartype(m.tcAlias) = "L"
*	closes table in current work area
	If Used()
		Use
	Endif
	Return !Used()
Endif
If Empty(m.tcAlias)
	Return .T.
Endif
If m.tlUsed
	Return .F.
Endif
If Used(m.tcAlias)
	Use In (m.tcAlias)
Endif
Return !Used(m.tcAlias)

***
*	Returns ON('ERROR')
*
Function onError
Return On('ERROR')

***
*	Returns SET('BLOCKSIZE')
*
Function SetBlock
Return Set('BLOCKSIZE')

***
*	Returns blank value, depending on the type of tValue
*
Function NullInit( tValue )
Local lcType
lcType = Vartype(m.tValue)
Do Case
Case Inlist(m.lcType,'N','F','Y')
	Return 0
Case Inlist(m.lcType,'D')
	Return Date00()
Case Inlist(m.lcType,'T')
	Return Dtot(Date00())
Case m.lcType=='L'
	Return .F.
Case m.lcType=='O'
	Return .Null.
Endcase
Return ''

***
*	Returns empty date
*
Function Date00
Return Ctod('')

***
*	Converts POSITIVE decimal integers to hex (Char)
*	Writen by Jonathan Cohen
*	Modifyed by Nikolay Petkov to fixed lenght of output string
*   Input:  NUMERIC
*   Output: CHAR
*
Function DecToHex
Lparameter tnInNum
If m.tnInNum<=15
	Return Padl(FindHex(m.tnInNum),2,"0")
Endif
Local lcOutStr
lcOutStr = Space(0)
Do While m.tnInNum>0
	lcOutStr = FindHex(Mod(m.tnInNum,16)) + m.lcOutStr
	tnInNum = Int(m.tnInNum/16)
Enddo
Return m.lcOutStr
*
* Lookup table for conversion of alpha hex chars
Function FindHex
Lparameters InVal        && Integer 0-16
Local jOutStr
Do Case
Case m.InVal=10
	jOutStr='A'
Case m.InVal=11
	jOutStr='B'
Case m.InVal=12
	jOutStr='C'
Case m.InVal=13
	jOutStr='D'
Case m.InVal=14
	jOutStr='E'
Case m.InVal=15
	jOutStr='F'
Otherwise
	jOutStr=Str(m.InVal,1,0)
Endcase
Return m.jOutStr

***
*	Combination from ALLTRIM & STR
*
Function As( tnNumber )
Return Alltrim( Str(m.tnNumber) )

***
*	Returns .t. if specified expression is character
*
Function IsChar
Lparameters teToTest
Return Vartype(m.teToTest)="C"

***
*	Returns .t. if the given alias is currently selected
*
Function CurAlias( tcAlias )
If Used() And !Empty(m.tcAlias) And Alltrim(Upper(m.tcAlias))==Alias()
	Return .T.
Else
	Return .F.
Endif

***
*	Returns path and name with forced extention
*	PARAMETERS:
*	olnlyIfNot
*		.f. - allways puts extention
*		.t. - puts extention only if extention is absent in given name
*
Function Force_DBF
Lparameters m.filname, m.olnlyIfNot
If Pcount()<2
	m.olnlyIfNot = .F.
Endif
Return Force_EXT(m.filname, CDBF, m.olnlyIfNot)

***
*	Returns path and name with changed extension
*	PARAMETERS:
*	tlOnlyIfNot
*		.f. - puts extension even allready have
*		.t. - puts extension only if extension missing in tcFileName
*
Function Force_EXT
Lparameters tcFileName, tcNewExt, tlOnlyIfNot
Private lcDot
lcDot = "."
If m.tlOnlyIfNot And m.lcDot$Justfname(m.tcFileName)
	Return m.tcFileName
Endif
tcFileName = stripext(m.tcFileName)
tcNewExt = Alltrim(m.tcNewExt)
Do Case
Case Empty(m.tcNewExt)
	Return m.tcFileName
Case Left(m.tcNewExt,1)==m.lcDot
	Return m.tcFileName + m.tcNewExt
Endcase
Return m.tcFileName + m.lcDot + m.tcNewExt

***
*	Removes extension from the file name
*
Function stripext
Lparameter tcFileName
tcFileName = Trim(m.tcFileName)
Private lnDotPos, lnTerminator
lnDotPos = Rat(".", m.tcFileName)
lnTerminator = Max(Rat("\", m.tcFileName), Rat(":", m.tcFileName))
If m.lnDotPos > m.lnTerminator
	tcFileName = Left(m.tcFileName, m.lnDotPos-1)
Endif
Return m.tcFileName

***
*	Returns Font attributes for given NUMERIC variable,
*	which is also suitable to be used as parameter in FONTMETRIC()
*
Function FontStyleN
Lparameters tnFontStyle
Do Case
Case m.tnFontStyle=1
	Return 'B'
Otherwise
	Return 'N'
Endcase

***
*	Renames a given file with error handling (if target file is in other device - copy/delete)
*
Function RenFile
Parameters tcFile1, tcFile2, m.useTTS_N
Private llUseWinApi
llUseWinApi = .T.	&& if need can be a parameter
If File(m.tcFile1)
*IF m.useTTS_N AND TTSATTRIB(m.tcFile)
*	=TTSATTRIB(m.tcFile,.f.)
*ENDIF
	If File(m.tcFile2) And !DelFile(m.tcFile2,m.useTTS_N)
		Return .F.
	Endif
	Private lnError
	lnError = 0
	If Upper(Justdrive(m.tcFile1)) <> Upper(Justdrive(m.tcFile2))
		If CopyFile( m.tcFile1, m.tcFile2 )
			=DelFile( m.tcFile1 )
		Endif
	Else
		If m.llUseWinApi
			Return MoveFile( m.tcFile1, m.tcFile2 ) <> 0
		Else
			Private lcOldOnError
			lcOldOnError = onError()
			On Error lnError=Error()
			Rename (m.tcFile1) To (m.tcFile2)
			On Error &lcOldOnError
			Return File(m.tcFile2) And !File(m.tcFile1) And m.lnError = 0
		Endif
	Endif
Endif
Return .F.

***
*	Deletes a given file with error handling
*	RETURs: .t. if file is deleted, otherwise .f.
*			in tnError returns the error number, if any
*			Possible error numbers:
*			File is in use by another.  (108)
*			File is in use.  (3)
*		tcBadMessage (out)
*	Remark: useTTSIN is dummy
*
Function DelFile
Parameters tcFile, useTTSIN, tnError, tlMesNotDeleted, tcBadMessage
tnError = 0
Private llUseWinApi
llUseWinApi = .T.	&& if need can be a parameter
If File(m.tcFile)
	If m.llUseWinApi
		If DeleteFile( m.tcFile ) = 0	&& Error deleting
			tnError = -108	&& File is in use by another, we put minus sign
		Endif
	Else
*IF m.useTTSIN AND TTSATTRIB(m.tcFile)
*	=TTSATTRIB(m.tcFile,.f.)
*ENDIF
		Private lcOldOnERR
		lcOldOnERR = onError()
		On Error tnError = Error()
		Delete File (m.tcFile)
		On Error &lcOldOnERR
		If File(m.tcFile) And m.tnError=0
*	no error in command DELETE FILE, but file is not deleted
*	(for example when file is used by another)
			tnError = -108
		Endif
	Endif
	If File(m.tcFile)
		Private lcMessage
		lcMessage = "Problem deleting file:"+Chr(13)+Chr(13)+Lower(m.tcFile)
		If Empty(m.tcBadMessage)
			tcBadMessage = ""
		Endif
		tcBadMessage = m.tcBadMessage + Chrtran( m.lcMessage, Chr(13), Space(1) ) + Chr(13)
		If m.tlMesNotDeleted
			=Worn_mesg( m.lcMessage )
		Endif
		Return .F.
	Endif
Endif
Return .T.

***
*	As Windows API function MoveFile
*	The MoveFile function renames an existing file or a directory (including all its children).
*	The MoveFile function will move (rename) either a file or a directory (including all its children)
*	either in the same directory or across directories. The one caveat is that the MoveFile function
*	will fail on directory moves when the destination is on a different volume.
*		If the function succeeds, the return value is nonzero.
*		If the function fails, the return value is zero
*
Function MoveFile
Parameters tcExistingFileName, tcNewFileName
Declare Integer MoveFile In Win32api As MoveFile0 ;
	STRING @src, String @Dest
Return MoveFile0( @m.tcExistingFileName, @m.tcNewFileName )

***
*	As Windows API function DeleteFile
*	The DeleteFile function deletes an existing file.
*		If the function succeeds, the return value is nonzero.
*		If the function fails, the return value is zero
*
Function DeleteFile
Parameters tcFileName
Declare Integer DeleteFile In Win32api As DeleteFile0 ;
	STRING @
Return DeleteFile0( @m.tcFileName )

***
*	Copies given file, with error handling
*	RETURN: .t. if OK
*		tcBadMessage (out)
*	Remark: useTTSIN is dummy
*
Function CopyFile
Parameters tcFile1, tcFile2, useTTSIN, tlMesProgrss, tlMesNotCopied, tcBadMessage
Private llOk, llUseWinApi
llOk = .F.
llUseWinApi = .T.	&& if need can be a parameter
If File(m.tcFile1)
	If !DelFile( m.tcFile2, m.useTTSIN, 0, m.tlMesNotCopied, @m.tcBadMessage )
		Return .F.
	Endif
	If m.tlMesProgrss
		Wait Clear
		Wait Window '  '+Lower(m.tcFile1)+'  '+Lower(m.tcFile2) Nowait
	Endif
	If m.llUseWinApi
*	Copy with the help of Windows API
		llOk = CopyFileApi( m.tcFile1, m.tcFile2, 0 ) <> 0
	Else
*	Fox style copy
		Private lnError, lcOldOnError
		lnError = 0
		lcOldOnError = onError()
		On Error lnError=Error()
		Copy File (m.tcFile1) To (m.tcFile2)
		On Error &lcOldOnError
		llOk = File(m.tcFile2) And m.lnError = 0
	Endif
	If m.tlMesProgrss
		Wait Clear
	Endif
Else
	Private lcMessage
	lcMessage = "Can not copy file:"+Chr(13)+Lower(m.tcFile1)+Chr(13)+Chr(13)+;
		"in file:"+Chr(13)+Lower(m.tcFile2)
	If Empty(m.tcBadMessage)
		tcBadMessage = ""
	Endif
	tcBadMessage = m.tcBadMessage + Chrtran( m.lcMessage, Chr(13), Space(1) ) + Chr(13)
	If m.tlMesNotCopied
		=Worn_mesg( m.lcMessage )
	Endif
Endif
Return m.llOk

***
*	Function: Copies File. Faster than Fox Copy and handles errors internally.
*		tcSource -  Source File
*		tcTarget -  Target File
*		tnFlag   -  0* override, 1 don't
*    Return:
*		If the function succeeds, the return value is nonzero
*		If the function fails, the return value is zero. To get extended error information, call GetLastError
*
Function CopyFileApi
Parameters lcSource, lcTarget, nFlag
Declare Integer CopyFile In WIN32API As CopyFile0 ;
	STRING @cSource, String @cTarget, Integer nFlag
Return CopyFile0( @m.lcSource, @m.lcTarget, m.nFlag )

***
*	Calls MessageBox for simple WORNING message (replaces old WornMess)
*
#Define WARNING_LOC			"Warning"
Function Worn_mesg
Lparameters tcMessage, tcTitle, nDialogBoxType
If Pcount()<2 Or Empty(m.tcTitle)
	tcTitle = Upper(WARNING_LOC)
Endif
If Pcount()<3
	nDialogBoxType = MB_OK + MB_ICONEXCLAMATION
Endif
Return Messagebox( m.tcMessage, m.tcTitle, m.nDialogBoxType )

***
*	Returns type C from the given value (any type)
*	lnTypeRet
*		0 - ordinary conversion
*		1 - other ("frendly")
*
Function AnyToC
Lparameters inVar, tnTypeRet
If Pcount()<2
	tnTypeRet = 0
Endif
Local lcType
lcType = Type("m.inVar")
Do Case
Case Inlist(m.lcType,'C','M')
	Return m.inVar
Case Inlist(m.lcType,'N','I','Y')
	Return ASspec(m.inVar)
Case m.lcType='D'
	Return Dtoc(m.inVar)
Case m.lcType='T'
	Return Ttoc(m.inVar)
Case m.lcType='L'
	If m.tnTypeRet=1
		Return Iif(m.inVar,CYES_LOC,CNO_LOC)
	Else
		Return Iif(m.inVar,".t.",".f.")
	Endif
Case m.lcType='O'
	Return COBJECT_LOC
Case m.lcType='G'
	Return CGENERAL_LOC
Otherwise
	Return m.inVar
Endcase
Endfunc

************************ END SECTION: Functions NEEDED RepExpFl to work

************************ START SECTION: Functions NEEDED RepExpFl to work
*	Additional functions NEEDED RepEnhance to work (they are called from inside RepEnhance).
*	These functions you can include in your project procedure file, or write your own
*	with same functionality.

***
*	Returns .t. if specified expression is object
*
Function IsObject
Lparameters teToTest
*RETURN VARTYPE(m.teToTest)="O"
Return Vartype(m.teToTest)="O" And !Isnull(m.teToTest)

***
*	Returns STRING - whole number without decimal portion,
*	only if it is zero
*
Function ASspec
Lparameters tnNumber, tnRound
If Pcount()<2
	tnRound = 15
Endif
If IsWhole(m.tnNumber)
	Return As(m.tnNumber)
Else
	Return Ltrim(trim1(Str(m.tnNumber,25,m.tnRound),'0'))
Endif

***
*	Check if a numeric value is whole
*
Function IsWhole
Parameters m.tnNumber
Return m.tnNumber=Int(m.tnNumber)

***
*	As TRIM, but removes also all simbols, listed in tcSimb,
*	from the end of the string. tcSimb can be longer from 1
*
Function trim1
Lparameters tcStr, tcSimb
If Pcount()<2
	tcSimb = ","
Endif
Local lnLen
tcSimb = m.tcSimb+Space(1)		&& also removes and spaces
tcStr = Trim(m.tcStr)
lnLen = Len(m.tcStr)
Do While .T.
	If m.lnLen<=0
		Exit
	Endif
	If ! Substr(m.tcStr,m.lnLen,1) $ m.tcSimb
		Exit
	Endif
	lnLen = m.lnLen - 1
Enddo
If m.lnLen>0
	Return Padr(m.tcStr,m.lnLen)
Else
	Return ""
Endif

************************ END SECTION: Functions NEEDED RepEnhance to work

************************ START SECTION: Functions needed only examples to work
*	Functions needed only examples to work. With them you can do what you like.

***
*	Calls MessageBox for simple informative message
*	(  yes_mesg.SCX, yes_Mesg.SPR )
*
#Define INFORMATION_LOC		"information"
Function Info_mesg
Lparameters tcMessage, tcTitle, nDialogBoxType
If Empty(m.tcMessage)
	tcMessage = ""
Endif
If Empty(m.tcTitle)
	tcTitle = Upper(INFORMATION_LOC)
Endif
If Pcount()<3
	nDialogBoxType = MB_OK + MB_ICONINFORMATION
Endif
Return Messagebox( m.tcMessage, m.tcTitle, m.nDialogBoxType )

***
*	Similar function as in Windows DLL and addititions
*	Runs external exe or file
*	tcFileName  -  Name of the file to open (execute)
*	tcWorkDir   -  Working directory
*	tnShowWindow
*		SW_HIDE = 0
*		SW_SHOWNORMAL, SW_NORMAL = 1
*		SW_SHOWMINIMIZED = 2
*		SW_SHOWMAXIMIZED, SW_MAXIMIZE = 3
*		SW_SHOWNOACTIVATE = 4
*		SW_SHOW = 5
*		SW_MINIMIZE = 6
*		SW_SHOWMINNOACTIVE = 7
*		SW_SHOWNA = 8
*		SW_RESTORE = 9
*		SW_SHOWDEFAULT, SW_MAX = 10
*	tcOperation
*		"open"  The function opens the file specified by the lpFile parameter. The file can be an executable file or a document file. It can also be a folder.
*		"print"  The function prints the file specified by lpFile. The file should be a document file. If the file is an executable file, the function opens the file, as if "open" had been specified.
*		"explore"  The function explores the folder specified by lpFile.
*		This parameter can be EMPTY. In that case, the function opens the file specified by lpFile.
*	tnAction
*		0 - Normal
*		1 - Wait to start application and return handle to window
*		2 - Wait to terminate started application
*	RETURN:
*		0  - The operating system is out of memory or resources
*		2  - Bad Association
*		31 - No application association
*		29 - Failure to load application
*		30 - Application is busy
*		Returns a value greater than 32 if successful,
*		or an error value that is less than or equal to 32 otherwise
*
Function ShellExe( tcFileName, tcParameters, tcWorkDir, tcOperation, tnShowWindow, ;
	tnAction, tnHandleStarted )
If Empty(m.tnAction)
	tnAction = 0
Endif
If Empty(m.tcParameters)
	tcParameters = ""
Endif
If Empty(m.tcWorkDir)
	tcWorkDir = ""
Endif
If Empty(m.tcOperation)
	tcOperation = "Open"
Endif
If IsLog(m.tnShowWindow)
	tnShowWindow = 1
Endif
Declare Integer ShellExecute ;
	IN SHELL32.Dll ;
	INTEGER nWinHandle,;
	STRING cOperation,;
	STRING cFileName,;
	STRING cParameters,;
	STRING cDirectory,;
	INTEGER nShowWindow
Local lnReturn
tcFileName = PutQuotes( Alltrim(m.tcFileName), .F., .T. )
tcWorkDir = PutQuotes( Alltrim(m.tcWorkDir), .F., .T. )
If m.tnAction>0
	Local aWins0[1]
	=aWindows( @aWins0 )	&& Array with Windows before starting
Endif
lnReturn = ShellExecute( 0, m.tcOperation, m.tcFileName, m.tcParameters, m.tcWorkDir, m.tnShowWindow )
If m.lnReturn>=32 And m.tnAction>0
*	wait for the new window to appear)
	Local lnInitialActiveWindow, tnTimeStart, lcTitle, aWinsAfter[1]
	lnInitialActiveWindow = MainHwnd()	&& FoxTools.FLL
	tnTimeStart = Seconds()
	lcTitle = "Starting "+m.tcFileName
	Do While .T.
		=aWindows( @aWinsAfter )
		tnHandleStarted = GetNewWindow( @aWins0, @aWinsAfter )
		If m.tnHandleStarted>0 And m.lnInitialActiveWindow<>m.tnHandleStarted
			Exit
		Endif
		If EscapeProc()
			Exit
		Endif
		If Seconds() - m.tnTimeStart > 30
			If Inlist( YesNo( "After 30 s the application is not activated."+Chr(13)+"Wait more?", m.lcTitle, MB_DEFBUTTON1 ), IDOK, IDYES )
				Wait Clear
				Wait Window m.lcTitle Nowait Noclear
				tnTimeStart = Seconds()
			Else
				Exit
			Endif
		Endif
*=INKEY( 0.05 )
	Enddo
	If m.tnAction=2 And m.tnHandleStarted>0 And m.lnInitialActiveWindow<>m.tnHandleStarted
* Provided window handle is still valid then wait to terminate
		Wait Window 'Waiting to finish "' + Alltrim(GetWindowText(m.tnHandleStarted)) +'"' Nowait Noclear
		Do While IsWindow( m.tnHandleStarted ) = 1
*=INKEY( 0.1 )
			=Sleep( 100 )	&& In Milliseconds
		Enddo
	Endif
	Wait Clear
Endif
Return m.lnReturn

***
*	Returns .t. if specified expression is logical
*
Function IsLog
Lparameters teToTest
Return Vartype(m.teToTest)="L"

***
*	Puts quotes on the given string
*
Function PutQuotes
Lparameters m.tcString, tlCheck, tlOnlyIfSpaces
If m.tlOnlyIfSpaces And !Space(1)$m.tcString
	Return m.tcString
Endif
Local lcQuote
lcQuote = '"'
If m.tlCheck And m.lcQuote $ m.tcString
	lcQuote = "'"
Endif
If m.lcQuote <> Padr(m.tcString,1)
	Return m.lcQuote + m.tcString + m.lcQuote
Else
	Return m.tcString
Endif

******************
***   Author: (c) Rick Strahl, 1994, Modified by Nikolay Petkov 04.02.2002
*** Function: Creates an Array of top level wins
***           on the Windows DeskTop.
***   Assume: FOXTOOLS is loaded
***           Pass paWindows array by REFERENCE!
***     Uses: WinTitle()
***           WinNext()
***     Pass: paWindows -  an array that will be
***                        loaded with window names.
***                        The array will be 2D
***                        containing names and win
***                        handles.
***   Return: lnWinCount-  Number of Windows loaded
*
Procedure aWindows
Parameters paWindows
Private lhCurrWin, lnWinCount
*** Assign FoxPro Window (Desktop? NP)
lhCurrWin = GetWindow( MainHwnd(), 0 )
lnWinCount = 0
Do While lhCurrWin > 0
*** Skip non-visible and child wins
	If !Empty( GetWindowText(m.lhCurrWin) ) And IsWindowVisible(m.lhCurrWin)<>0
		lnWinCount = lnWinCount + 1
		Dimension paWindows(m.lnWinCount,2)
		paWindows[m.lnWinCount,1] = GetWindowText(m.lhCurrWin)
		paWindows[m.lnWinCount,2] = m.lhCurrWin
	Endif
*** Next Window in Chain
	lhCurrWin = GetWindow(m.lhCurrWin,2)
Enddo
Return m.lnWinCount

***
*	Returns handle to reasantly started application (window), by Nikolay Petkov 04.02.2002
*	Usage:
*	LOCAL aWins0[1], aWinsAfter[1], lnHandleStarted
*	=aWindows( @aWins0 )	&& Array with Windows before starting
*	action...
*	=aWindows( @aWinsAfter )
*	lnHandleStarted = GetNewWindow( @aWins0, @aWinsAfter )
*
Function GetNewWindow( taWins0, taWinsAfter )
External Array taWins0, taWinsAfter
Local lnHandle, i, j, llFound
lnHandle = 0
For i=1 To Alen(taWinsAfter,1)	&& scan array "after"
	If !Empty(taWinsAfter[m.i,2])
		llFound = .F.
		For j=1 To Alen(taWins0,1)	&& scan array "before"
			If !Empty(taWins0[m.j,2])
				If taWins0[m.j,2] = taWinsAfter[m.i,2]
					llFound = .T.
					Exit
				Endif
			Endif
		Endfor
		If !m.llFound
			lnHandle = taWinsAfter[m.i,2]
			Exit
		Endif
	Endif
Endfor
Return m.lnHandle

***
*	Checks keyboard buffer for keyboard input.
*	If yes, ascs if to exit a procedure and return the ansuer: .t./.f.
*	m.chrList - list with keys to check (defaults to Escape)
*
#Define PROCEDURE_LOC		"Procedure "
#Define WILLCANSEL_LOC		"will be canceled"
#Define CCONFIRM_LOC		"Do you confirm?"
Function EscapeProc
Lparameters tcMessage, tcChrList
If Pcount()<2
	tcChrList = Chr(27)
Endif
If Chrsaw()
	Local lnKeyNumber
	lnKeyNumber = Inkey()
	Clear Typeahead
	If m.lnKeyNumber<1 Or Chr(m.lnKeyNumber)$m.tcChrList
		If Inlist(Messagebox(PROCEDURE_LOC+Iif(Empty(m.tcMessage),"",m.tcMessage)+Chr(13)+WILLCANSEL_LOC+Chr(13)+CCONFIRM_LOC,;
				MB_YESNO + MB_ICONQUESTION + MB_DEFBUTTON2), IDOK, IDYES)
			Return .T.
		Endif
	Endif
Endif
Return .F.

***
*	Simple YES/NO dialog, using MessageBox().
*	PARAMETERS:
*	nDialogBoxType
*		MB_OK               0 - OK button only
*		MB_OKCANCEL         1 - OK and Cancel buttons
*		MB_ABORTRETRYIGNORE 2 - Abort, Retry, and Ignore buttons
*		MB_YESNOCANCEL      3 - Yes, No, and Cancel buttons
*		MB_YESNO            4 - Yes and No buttons
*		MB_RETRYCANCEL      5 - Retry and Cancel buttons
*	nDefaultButton
*		MB_DEFBUTTON1       0   - First button is default
*		MB_DEFBUTTON2       256 - Second button is default
*		MB_DEFBUTTON3       512 - Third button is default
*	nIcon
*		MB_ICONSTOP             16      && Critical message
*		MB_ICONQUESTION         32      && Warning query
*		MB_ICONEXCLAMATION      48      && Warning message
*		MB_ICONINFORMATION      64      && Information message
*	Other Constants (summ with nDialogBoxType)
*		MB_SYSTEMMODAL		4096 - System Modal
*		MB_TASKMODAL		8192 - Task Modal
*
*
*	RETURN:
*		IDOK        1 - OK button pressed
*		IDCANCEL    2 - Cancel button pressed
*		IDABORT     3 - Abort button pressed
*		IDRETRY     4 - Retry button pressed
*		IDIGNORE    5 - Ignore button pressed
*		IDYES       6 - Yes button pressed
*		IDNO        7 - No button pressed
*
Function YesNo
Lparameters tcMessage, tcTitleBox, nDefaultButton, nDialogBoxType, nIcon
If Empty(m.tcTitleBox)
	tcTitleBox = _Screen.Caption
Endif
If Pcount()<3
	nDefaultButton = MB_DEFBUTTON1
Endif
If Pcount()<4
*nDialogBoxType = MB_YESNO
	nDialogBoxType = MB_YESNOCANCEL
Endif
If Pcount()<5
	nIcon = MB_ICONQUESTION
Endif
If Empty(m.tcMessage)
	tcMessage = 'Are you sure?'
Endif
Return Messagebox( m.tcMessage, m.tcTitleBox, m.nDialogBoxType+m.nDefaultButton+m.nIcon )

Function GetWindowText( tnHandle )
Declare Integer GetWindowText In WIN32API As GetWindowText0 ;
	INTEGER HWnd, String @lpString, Integer nMaxCount
Local lpTitle, lnResult, lnLen
lnLen = 512
lpTitle = Repl(Chr(0),m.lnLen)
lnResult = GetWindowText0( m.tnHandle, @m.lpTitle, m.lnLen-1 )
If m.lnResult <> 0
	Return Left(m.lpTitle,At(Chr(0),lpTitle)-1)
Else
	Return ""
Endif
*
Function IsWindow( tnHandle )
Declare Integer IsWindow In user32.Dll As IsWindow0 ;
	INTEGER HWnd
Return IsWindow0( m.tnHandle )	&& Return 0/1
*
*	Usage: IsWindowVisible(m.tnHandle)<>0
Function IsWindowVisible( tnHandle )
Declare Integer IsWindowVisible In user32.Dll As IsWindowVisible0 ;
	INTEGER HWnd
Return IsWindowVisible0( m.tnHandle )	&& Return 0/1
*
***     #define GW_HWNDFIRST        0 (Desktop)
***     #define GW_HWNDLAST         1
***     #define GW_HWNDNEXT         2 (default)
***     #define GW_HWNDPREV         3
Function GetWindow( tnHandleOriginal, tnRelationship )
Declare Integer GetWindow In user32.Dll As GetWindow0 ;
	INTEGER HWnd, Integer uCmd
Return GetWindow0( m.tnHandleOriginal, m.tnRelationship )	&& Return 0/1

***
*	The Sleep function suspends the execution of the current thread for a specified interval
*	Specifies the time, in milliseconds, for which to suspend execution.
*	A value of zero causes the thread to relinquish the remainder of its time slice to any other
*	thread of equal priority that is ready to run. If there are no other threads of equal priority
*	ready to run, the function returns immediately, and the thread continues execution.
*	A value of INFINITE causes an infinite delay
*
Function Sleep
Parameters tnMilliseconds
Declare Sleep In WIN32API As Sleep0  ;
	INTEGER
=Sleep0( m.tnMilliseconds )
Return .T.

***
*	Returns handle to main window
*	this will execute if Foxtools.fll is not loaded
*
Function MainHwnd
Return _vfp.HWnd

****
*	         
*	     ,  CHARACTER
*	 WORDNUMX -    "a,,c"     ""
*		( -  foxtools   )
*	  tcSep   ,    WORDNUM
*
Function WordnumX
Parameter tcString, tnWord, tcSep
If Parameters()<3
	tcSep = ','
Endif
If Len(m.tcSep) > 1
	Return WORDNUM(m.tcString, m.tnWord, m.tcSep)	&& foxtools.fll
Endif
Private lnPosStart, lnPosEnd, tnWords
tnWords = WordsX(m.tcString, m.tcSep)
If m.tnWords=0 And m.tnWord=1
	Return m.tcString
Endif
If m.tnWord>m.tnWords Or m.tnWord<=0
	Return ""
Endif
If m.tnWord=1
	lnPosStart = 1
Else
	lnPosStart = At(m.tcSep,m.tcString,m.tnWord-1) + 1
Endif
If m.lnPosStart>Len(m.tcString)
	Return ""
Endif
lnPosEnd = At(m.tcSep,m.tcString+m.tcSep,m.tnWord)
Return Substr(m.tcString,m.lnPosStart,m.lnPosEnd-m.lnPosStart)

***
*	      ,       tcSep
*	    WordnumX
*
Function WordsX
Parameters tcString, tcSep
If Parameters()<2
	tcSep = ","
Endif
If Len(m.tcSep) > 1
	Return WORDS(m.tcString, m.tcSep)	&& foxtools.fll
Endif
Return Occurs(m.tcSep,m.tcString) + 1

***
*	Gets home folder for application
*
Function GetHome
Do Case
Case Type("oApp.cHomeDir")="C"
	Return oApp.cHomeDir
Case Type("m.pcHomeDir")="C"
	Return m.pcHomeDir
Otherwise
	Return Addbs(Justpath(Sys(16,0)))
Endcase
Endfunc

***
*	Returns unique ALIAS, suitable for file name with
*
Function UniqAlias
Parameters tcFirstLett
If Parameters()<1
	tcFirstLett = 'T'
Endif
Private lcTempAlias
Do While .T.
	lcTempAlias = m.tcFirstLett + Left(Sys(3),7)
	If !Used(m.lcTempAlias)
		Return m.lcTempAlias
	Endif
Enddo

************************ END SECTION: Functions needed only examples to work
Procedure audit
Parameters l_calias,l_ref,c_desc,c_a_para_code,c_a_staffno

l_a_para_code = 0
l_a_staffno = 0
l_c_desc = ''
If !Isnull(c_desc)
	If !Empty(c_desc)
		l_c_desc = c_desc
	Endif
Endif

If !Isnull(c_a_staffno)
	If !Empty(c_a_staffno)
		l_a_staffno = c_a_staffno
	Endif
Endif

If !Isnull(c_a_para_code)
	If !Empty(c_a_para_code)
		l_a_para_code = c_a_para_code
	Endif
Endif

m.refno = Alltrim(l_calias)+'.'+Alltrim(l_ref)
If !Used('atrack')
	l_filter = 'auditid = 0'
	lopened = opendtable('atrack','atrack',l_filter,.T.,'auditid')
Endif
l_refno = &refno
If lopened
	Select (l_calias)

	lfieldcount = Fcount()
	fd = 1
	Do While fd <= lfieldcount
		l_oldvalue = Oldval(Field(fd),l_calias)
		l_afield = Alltrim(Field(fd))
		m.fieldname = l_calias+'.'+Alltrim(Field(fd))
		m.l_fieldname = "'"+Alltrim(m.fieldname)+"'"
		l_newvalue = &fieldname
		Select (l_calias)
		If l_oldvalue <> l_newvalue
			If Used('idcounter')
				Select idcounter
				Use
			Endif
			l_type = Type(&l_fieldname)
			lopened = opendtable('idcounter','idcounter','',.T.,'counterid')
			l_auditid = 0
			Select idcounter
			Go Top
			Locate For Alltrim(Upper(cKey)) =  'AUDIT'
			If Found()
				l_auditid = keyvalue+1
				Replace keyvalue With l_auditid
				=Tableupdate(.T.)
			Endif
			Use

			Do Case
			Case l_type = 'N'
				l_oldvalue = Alltrim(Str(l_oldvalue))
				l_newvalue = Alltrim(Str(l_newvalue))
			Case l_type = 'T'
				l_oldvalue = Ttoc(l_oldvalue)
				l_newvalue = Ttoc(l_newvalue)
			Case l_type = 'D'
				l_oldvalue = Dtoc(l_oldvalue)
				l_newvalue = Dtoc(l_newvalue)
			Case l_type = 'L'
				If l_oldvalue = .F.
					l_oldvalue = 'FALSE'
				Else
					l_oldvalue = 'TRUE'
				Endif

				If l_newvalue  = .F.
					l_newvalue  = 'FALSE'
				Else
					l_newvalue  = 'TRUE'
				Endif
			Endcase

			Select atrack
			Append Blank
			Replace auditid With l_auditid
			Replace adate With Datetime()
			Replace auser With c_username
			Replace category With l_calias
*Replace Afield With l_afield
			Replace oldvalue With l_oldvalue
			Replace newvalue With l_newvalue
*Replace ref_no With l_refno
*Replace ref_field With l_ref
*Replace ftype With l_type
			Replace para_code With l_a_para_code
			Replace staffno With l_a_staffno
			Replace c_desc With l_c_desc
			=Tableupdate(.T.)
		Endif
		Select (l_calias)
		fd = fd+1
	Enddo
Endif
Select (l_calias)
Return .T.


Local loGlob
Local lnSuccess
Local lnStatus

* The Chilkat API can be unlocked for a fully-functional 30-day trial by passing any
* string to the UnlockBundle method.  A program can unlock once at the start. Once unlocked,
* all subsequently instantiated objects are created in the unlocked state.
*
* After licensing Chilkat, replace the "Anything for 30-day trial" with the purchased unlock code.
* To verify the purchased unlock code was recognized, examine the contents of the LastErrorText
* property after unlocking.  For example:
loGlob = Createobject('Chilkat_9_5_0.Global')
lnSuccess = loGlob.UnlockBundle("Anything for 30-day trial")
If (lnSuccess <> 1) Then
	? loGlob.LastErrorText
	Release loGlob
	Cancel
Endif

lnStatus = loGlob.UnlockStatus
If (lnStatus = 2) Then
	? "Unlocked using purchased unlock code."
Else
	? "Unlocked in trial mode."
Endif

* The LastErrorText can be examined in the success case to see if it was unlocked in
* trial more, or with a purchased unlock code.
? loGlob.LastErrorText

Release loGlob

